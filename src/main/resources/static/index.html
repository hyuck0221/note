<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
    <meta name="color-scheme" content="light dark"/>
    <meta name="supported-color-schemes" content="light dark"/>
    <title>Ïò®ÎùºÏù∏ Î©îÎ™®Ïû•</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        /* ---------- Design Tokens ---------- */
        :root {
            /* Light Theme */
            --bg-primary: #FAFBFC;
            --bg-secondary: #F8F9FA;
            --surface-primary: #FFFFFF;
            --surface-secondary: #F1F3F4;
            --surface-elevated: #FFFFFF;
            --surface-overlay: rgba(255, 255, 255, 0.95);

            --text-primary: #1A1A1A;
            --text-secondary: #6B7280;
            --text-tertiary: #9CA3AF;
            --text-accent: #4338CA;

            --accent-primary: #6366F1;
            --accent-secondary: #818CF8;
            --accent-hover: #4F46E5;
            --accent-pressed: #4338CA;

            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;

            --border-primary: rgba(0, 0, 0, 0.08);
            --border-secondary: rgba(0, 0, 0, 0.05);
            --border-focus: var(--accent-primary);

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-full: 9999px;

            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --spacing-xl: 24px;
            --spacing-2xl: 32px;

            --font-xs: 0.75rem;
            --font-sm: 0.875rem;
            --font-base: 1rem;
            --font-lg: 1.125rem;
            --font-xl: 1.25rem;
            --font-2xl: 1.5rem;

            --line-height-tight: 1.25;
            --line-height-normal: 1.5;
            --line-height-relaxed: 1.625;

            --backdrop-blur: blur(20px);
            --transition-fast: 0.15s ease;
            --transition-normal: 0.2s ease;
            --transition-slow: 0.3s ease;
        }

        /* Dark Theme */
        body.dark-mode {
            --bg-primary: #0A0A0A;
            --bg-secondary: #111111;
            --surface-primary: #1A1A1A;
            --surface-secondary: #2A2A2A;
            --surface-elevated: #262626;
            --surface-overlay: rgba(26, 26, 26, 0.95);

            --text-primary: #FAFAFA;
            --text-secondary: #A1A1AA;
            --text-tertiary: #71717A;
            --text-accent: #A78BFA;

            --accent-primary: #8B5CF6;
            --accent-secondary: #A78BFA;
            --accent-hover: #7C3AED;
            --accent-pressed: #6D28D9;

            --success: #34D399;
            --warning: #FBBF24;
            --error: #F87171;

            --border-primary: rgba(255, 255, 255, 0.1);
            --border-secondary: rgba(255, 255, 255, 0.05);
            --border-focus: var(--accent-primary);

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.4);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6), 0 10px 10px -5px rgba(0, 0, 0, 0.5);
        }

        /* ---------- Base Reset ---------- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: var(--font-base);
            line-height: var(--line-height-normal);
            color: var(--text-primary);
            background: var(--bg-primary);
            transition: color var(--transition-normal), background-color var(--transition-normal);
            display: flex;
            flex-direction: column;
        }

        /* ---------- Custom Scrollbar ---------- */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-primary);
            border-radius: var(--radius-full);
            border: 2px solid transparent;
            background-clip: padding-box;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-primary);
            background-clip: padding-box;
        }

        ::-webkit-scrollbar-corner {
            background: transparent;
        }

        /* ---------- Utility Classes ---------- */
        .hidden {
            display: none !important;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* ---------- Animations ---------- */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(4px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
            }
            to {
                transform: translateX(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        /* ---------- Layout ---------- */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .topbar {
            height: 64px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--spacing-lg);
            background: var(--surface-overlay);
            backdrop-filter: var(--backdrop-blur);
            border-bottom: 1px solid var(--border-secondary);
            z-index: 1000;
        }

        .topbar-left,
        .topbar-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .logo {
            font-size: var(--font-lg);
            font-weight: 600;
            color: var(--text-primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .logo::before {
            content: 'üìù';
            font-size: var(--font-xl);
        }

        .app-content {
            flex: 1;
            display: grid;
            grid-template-columns: 320px 1fr;
            overflow: hidden;
        }

        /* ---------- Sidebar ---------- */
        .sidebar {
            background: var(--surface-primary);
            border-right: 1px solid var(--border-primary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform var(--transition-normal);
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-secondary);
        }

        .search-container {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-lg);
            padding-left: 40px;
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            background: var(--surface-secondary);
            color: var(--text-primary);
            font-size: var(--font-sm);
            transition: all var(--transition-fast);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .search-icon {
            position: absolute;
            left: var(--spacing-md);
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
            font-size: var(--font-sm);
        }

        .sidebar-controls {
            padding: var(--spacing-md) var(--spacing-lg);
            display: flex;
            gap: var(--spacing-sm);
        }

        .memo-list {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-sm);
        }

        .memo-item {
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-xs);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
            border: 1px solid transparent;
            user-select: none;
        }

        .memo-item:hover {
            background: var(--surface-secondary);
            border-color: var(--border-primary);
        }

        .memo-item.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-md);
        }

        .memo-item.active .memo-preview {
            color: rgba(255, 255, 255, 0.8);
        }

        .memo-title {
            font-weight: 500;
            font-size: var(--font-sm);
            line-height: var(--line-height-tight);
            margin-bottom: var(--spacing-xs);
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .memo-preview {
            font-size: var(--font-xs);
            color: var(--text-tertiary);
            line-height: var(--line-height-normal);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .memo-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--spacing-sm);
            font-size: var(--font-xs);
            color: var(--text-tertiary);
        }

        .memo-item.active .memo-meta {
            color: rgba(255, 255, 255, 0.7);
        }

        .sidebar-footer {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* ---------- Content Area ---------- */
        .content {
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .memo-detail {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: var(--spacing-2xl);
            gap: var(--spacing-lg);
            min-height: 0;      /* allow flex item to shrink */
            overflow-y: auto;   /* enable scrolling when content is long */
        }

        .memo-title-input {
            font-size: var(--font-2xl);
            font-weight: 600;
            padding: var(--spacing-md) var(--spacing-lg);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            background: var(--surface-primary);
            color: var(--text-primary);
            transition: all var(--transition-fast);
        }

        .memo-title-input:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .memo-title-input::placeholder {
            color: var(--text-tertiary);
        }

        .memo-editor-container {
            flex: 1;
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            background: var(--surface-primary);
            overflow: auto;
            box-shadow: var(--shadow-sm);
        }

        .memo-metadata {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--surface-secondary);
            border-radius: var(--radius-lg);
            font-size: var(--font-xs);
            color: var(--text-secondary);
        }

        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: var(--spacing-2xl);
            color: var(--text-tertiary);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: var(--spacing-lg);
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: var(--font-xl);
            font-weight: 500;
            margin-bottom: var(--spacing-sm);
            color: var(--text-secondary);
        }

        .empty-state-description {
            font-size: var(--font-sm);
            line-height: var(--line-height-relaxed);
            max-width: 400px;
        }

        /* ---------- Buttons ---------- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid transparent;
            border-radius: var(--radius-md);
            font-size: var(--font-sm);
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all var(--transition-fast);
            user-select: none;
            white-space: nowrap;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--surface-secondary);
            color: var(--text-secondary);
            border-color: var(--border-primary);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--surface-primary);
            color: var(--text-primary);
            border-color: var(--border-primary);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
        }

        .btn-ghost:hover:not(:disabled) {
            background: var(--surface-secondary);
            color: var(--text-primary);
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: var(--radius-md);
        }

        .btn-sm {
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: var(--font-xs);
        }

        .btn-lg {
            padding: var(--spacing-md) var(--spacing-xl);
            font-size: var(--font-base);
        }

        /* ---------- Modals ---------- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--surface-primary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: fadeIn var(--transition-normal) ease;
        }

        .modal-header {
            padding: var(--spacing-xl);
            border-bottom: 1px solid var(--border-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: var(--font-lg);
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            border-radius: var(--radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all var(--transition-fast);
        }

        .modal-close:hover {
            background: var(--surface-secondary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: var(--spacing-xl);
        }

        .modal-footer {
            padding: var(--spacing-xl);
            border-top: 1px solid var(--border-secondary);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-sm);
        }

        /* ---------- Form Elements ---------- */
        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-size: var(--font-sm);
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: var(--spacing-md);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            background: var(--surface-secondary);
            color: var(--text-primary);
            font-size: var(--font-sm);
            transition: all var(--transition-fast);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-input::placeholder,
        .form-textarea::placeholder {
            color: var(--text-tertiary);
        }

        .form-checkbox {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .form-checkbox input {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-primary);
        }

        /* ---------- Notifications ---------- */
        .notification {
            position: fixed;
            top: var(--spacing-xl);
            right: var(--spacing-xl);
            background: var(--surface-primary);
            color: var(--text-primary);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-primary);
            z-index: 10001;
            opacity: 0;
            transition: opacity var(--transition-slow);
        }

        .notification.show {
            opacity: 1;
        }

        .notification.success {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .notification.error {
            background: var(--error);
            color: white;
            border-color: var(--error);
        }

        /* ---------- Loading States ---------- */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-primary);
            border-radius: 50%;
            border-top-color: var(--accent-primary);
            animation: spin 1s linear infinite;
        }

        /* ---------- Responsive Design ---------- */
        @media (max-width: 768px) {
            .app-content {
                grid-template-columns: 1fr;
            }

            .app-content.sidebar-collapsed {
                grid-template-columns: 0 1fr;
            }

            .sidebar {
                position: fixed;
                top: 64px;
                left: 0;
                bottom: 0;
                width: 300px;
                z-index: 1000;
                transform: translateX(-100%);
                box-shadow: var(--shadow-xl);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .memo-detail {
                padding: var(--spacing-lg);
            }

            .topbar {
                padding: 0 var(--spacing-md);
            }

            .logo {
                font-size: var(--font-base);
            }

            .modal-content {
                width: 95%;
                margin: var(--spacing-lg);
            }
        }

        @media (max-width: 480px) {
            .topbar {
                height: 56px;
            }

            .app-content {
                height: calc(100vh - 56px);
            }

            .sidebar {
                top: 56px;
                width: 280px;
            }

            .memo-detail {
                padding: var(--spacing-md);
                gap: var(--spacing-md);
            }

            .memo-title-input {
                font-size: var(--font-xl);
            }
        }

        /* ---------- Toast UI Editor Customization ---------- */
        .toastui-editor-defaultUI,
        .toastui-editor-dark {
            border: none !important;
            background: transparent !important;
        }

        .toastui-editor-defaultUI .te-toolbar,
        .toastui-editor-dark .te-toolbar {
            border-bottom: 1px solid var(--border-primary) !important;
            background: var(--surface-secondary) !important;
            padding: var(--spacing-sm) !important;
            position: sticky !important;
            top: 0;
            z-index: 10;
        }

        .toastui-editor-defaultUI .te-toolbar button,
        .toastui-editor-dark .te-toolbar button {
            border-radius: var(--radius-sm) !important;
            margin: 2px !important;
            transition: all var(--transition-fast) !important;
        }

        .toastui-editor-defaultUI .te-toolbar button:hover,
        .toastui-editor-dark .te-toolbar button:hover {
            background: var(--surface-primary) !important;
        }

        .toastui-editor-defaultUI .te-md-container,
        .toastui-editor-dark .te-md-container {
            background: var(--surface-primary) !important;
            color: var(--text-primary) !important;
        }


        .toastui-editor-defaultUI .te-preview,
        .toastui-editor-dark .te-preview {
            background: var(--surface-primary) !important;
            color: var(--text-primary) !important;
        }

        /* Sticky toolbar for Toast UI Editor v3+ */
        .toastui-editor-toolbar {
            position: sticky !important;
            top: 0;
            z-index: 20;
            background: var(--surface-secondary) !important;
            border-bottom: 1px solid var(--border-primary) !important;
        }

        /* Toolbar moved out of editor should fill the width */
        .toolbar-moved {
            width: 100%;
        }

        /* --- Ensure memo pane grows when sidebar is collapsed (all breakpoints) --- */
        .app-content.sidebar-collapsed {
            grid-template-columns: 0 1fr !important;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css"/>
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/theme/toastui-editor-dark.css"/>
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
</head>
<body>
<script>
    (function () {
        var storedTheme = localStorage.getItem('theme') || 'dark-mode';
        document.body.classList.add(storedTheme);
    })();
</script>

<div class="app-container">
    <!-- Top Bar -->
    <div class="topbar">
        <div class="topbar-left">
            <button id="toggleSidebar" class="btn btn-ghost btn-icon">
                <span>‚ò∞</span>
            </button>
            <a href="#" class="logo">Ïò®ÎùºÏù∏ Î©îÎ™®Ïû•</a>
        </div>
        <div class="topbar-right">
            <button id="themeToggle" class="btn btn-ghost btn-icon" title="ÌÖåÎßà Î≥ÄÍ≤Ω">
                <span id="themeIcon">üåô</span>
            </button>
            <button id="saveBtn" class="btn btn-primary btn-sm" title="Ï†ÄÏû•">
                <span>üíæ</span>
                <span>Ï†ÄÏû•</span>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="app-content">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="search-container">
                    <input id="codeInput" class="search-input" type="text" placeholder="ÏÉà Î©îÎ™® ÏΩîÎìú ÏûÖÎ†•..."
                           autocomplete="off" maxlength="8"/>
                    <span class="search-icon">üîç</span>
                </div>
                <div class="sidebar-controls">
                    <button id="addBtn" class="btn btn-primary btn-sm" title="Î©îÎ™® Ï∂îÍ∞Ä">
                        <span>‚ûï</span>
                        <span>Ï∂îÍ∞Ä</span>
                    </button>
                </div>
            </div>

            <div class="memo-list" id="memoList">
                <!-- Memo items will be populated here -->
            </div>

            <div class="sidebar-footer">
                <button id="settingsBtn" class="btn btn-ghost btn-sm" title="ÏÑ§Ï†ï">
                    <span>‚öôÔ∏è</span>
                    <span>ÏÑ§Ï†ï</span>
                </button>
                <button id="shareBtn" class="btn btn-ghost btn-sm" title="Í≥µÏú†">
                    <span>üîó</span>
                    <span>Í≥µÏú†</span>
                </button>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content">
            <div id="memoDetail" class="memo-detail hidden">
                <input id="memoTitle" class="memo-title-input" type="text" placeholder="Î©îÎ™® Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
                       autocomplete="off"/>
                <div id="memoEditor" class="memo-editor-container"></div>
                <div class="memo-metadata">
                    <div id="memoDates">
                        <span>ÏÉùÏÑ±: <span id="createDate">-</span></span>
                        <span>ÏàòÏ†ï: <span id="updateDate">-</span></span>
                    </div>
                    <div class="save-status">
                        <span id="saveStatus" class="hidden">Ï†ÄÏû•Îê®</span>
                    </div>
                </div>
            </div>

            <div id="noMemo" class="empty-state">
                <div class="empty-state-icon">üìù</div>
                <div class="empty-state-title">Î©îÎ™®Í∞Ä ÏóÜÏäµÎãàÎã§</div>
                <div class="empty-state-description">
                    ÏÉàÎ°úÏö¥ Î©îÎ™®Î•º Ï∂îÍ∞ÄÌïòÏó¨ ÏãúÏûëÌïòÏÑ∏Ïöî.<br>
                    ÏôºÏ™Ω ÏÇ¨Ïù¥ÎìúÎ∞îÏóêÏÑú Î©îÎ™® ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÍ≥† Ï∂îÍ∞Ä Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div id="shareModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Î©îÎ™® Í≥µÏú†</h3>
            <button id="shareClose" class="modal-close">‚úï</button>
        </div>
        <div class="modal-body">
            <div id="shareStageSelect">
                <div class="form-group">
                    <div style="display: flex; gap: var(--spacing-sm); justify-content: center;">
                        <button id="receiveBtn" class="btn btn-secondary">Í≥µÏú†Î∞õÍ∏∞</button>
                        <button id="createBtn" class="btn btn-primary">Í≥µÏú†ÌïòÍ∏∞</button>
                    </div>
                </div>
            </div>

            <div id="shareStageReceive" class="hidden">
                <div class="form-group">
                    <label class="form-label">Í≥µÏú† ÏΩîÎìú</label>
                    <input id="shareCodeInput" class="form-input" type="text" placeholder="Í≥µÏú† ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"/>
                </div>
                <button id="shareCodeConfirmBtn" class="btn btn-primary">ÌôïÏù∏</button>
            </div>

            <div id="shareStageCreate" class="hidden">
                <div class="form-group">
                    <div style="display: flex; gap: var(--spacing-sm); justify-content: center;">
                        <button id="modeLinkBtn" class="btn btn-secondary">ÎßÅÌÅ¨</button>
                        <button id="modeFileBtn" class="btn btn-secondary">ÌååÏùº</button>
                    </div>
                </div>

                <div id="linkInputWrap" class="hidden">
                    <div class="form-group">
                        <label class="form-label">ÎßÅÌÅ¨</label>
                        <input id="linkInput" class="form-input" type="text" placeholder="Í≥µÏú†Ìï† ÎßÅÌÅ¨Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"/>
                    </div>
                </div>

                <div id="fileInputWrap" class="hidden">
                    <div class="form-group">
                        <label class="form-label">ÌååÏùº</label>
                        <div style="border: 2px dashed var(--border-primary); border-radius: var(--radius-md); padding: var(--spacing-2xl); text-align: center; cursor: pointer;">
                            <input id="fileInput" type="file" style="display: none;"/>
                            <p id="fileDropText" style="color: var(--text-secondary);">ÌååÏùºÏùÑ ÎìúÎûòÍ∑∏ÌïòÍ±∞ÎÇò ÌÅ¥Î¶≠ÌïòÏó¨ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</p>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="form-checkbox">
                        <input type="checkbox" id="remainingChk"/>
                        <label for="remainingChk">Ï°∞Ìöå Í∞ÄÎä• ÌöüÏàò Ï†úÌïú</label>
                        <input type="number" id="remainingInput" class="form-input" min="1"
                               style="width: 80px; margin-left: auto;" disabled/>
                    </div>
                </div>

                <button id="shareSubmitBtn" class="btn btn-primary" disabled>Í≥µÏú†ÌïòÍ∏∞</button>

                <div id="shareResultWrap" class="hidden" style="margin-top: var(--spacing-xl); text-align: center;">
                    <div id="shareResultText"
                         style="white-space: pre-wrap; font-size: var(--font-sm); margin-bottom: var(--spacing-md);"></div>
                    <img id="shareResultQR" style="width: 180px; height: 180px; border-radius: var(--radius-md);" src=""
                         alt="QR ÏΩîÎìú"/>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">ÏÑ§Ï†ï</h3>
            <button id="settingsClose" class="modal-close">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <div class="form-checkbox">
                    <input type="checkbox" id="autoSaveEnable"/>
                    <label for="autoSaveEnable">ÏûêÎèô Ï†ÄÏû• ÌôúÏÑ±Ìôî</label>
                </div>
                <input type="number" id="autoSaveIntervalInput" class="form-input" min="10" max="240" placeholder="60"
                       style="margin-top: var(--spacing-sm);" disabled/>
                <small style="color: var(--text-tertiary);">ÏûêÎèô Ï†ÄÏû• Í∞ÑÍ≤© (Ï¥à)</small>
            </div>

            <div class="form-group">
                <label class="form-label">ÌÖåÎßà</label>
                <select id="themeSelect" class="form-select">
                    <option value="light">ÎùºÏù¥Ìä∏ Î™®Îìú</option>
                    <option value="dark">Îã§ÌÅ¨ Î™®Îìú</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ïó∞Îèô</label>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span id="clientStatus" style="color: var(--text-secondary);">ÎØ∏Ïó∞Îèô</span>
                    <button id="clientIntegrationBtn" class="btn btn-secondary btn-sm">Ïó∞Í≤∞</button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button id="resetListBtn" class="btn btn-secondary">Î©îÎ™® Î™©Î°ù Ï¥àÍ∏∞Ìôî</button>
        </div>
    </div>
</div>

<!-- Client Integration Modal -->
<div id="clientIntegrationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ïó∞Îèô</h3>
            <button id="clientDialogClose" class="modal-close">‚úï</button>
        </div>
        <div class="modal-body">
            <div id="createClientBtn" class="btn btn-primary"
                 style="margin: var(--spacing-sm); width: calc(100% - var(--spacing-lg));">ÏÉà ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÉùÏÑ±
            </div>
            <div id="connectClientBtn" class="btn btn-secondary"
                 style="margin: var(--spacing-sm); width: calc(100% - var(--spacing-lg));">Í∏∞Ï°¥ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ïó∞Í≤∞
            </div>

            <div id="clientConnectForm" class="hidden">
                <div class="form-group">
                    <label class="form-label">ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏΩîÎìú</label>
                    <input id="clientCodeInput" class="form-input" type="text" placeholder="ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"/>
                </div>
                <button id="clientCodeConfirmBtn" class="btn btn-primary">ÌôïÏù∏</button>
            </div>

            <div id="clientConnectStatus" class="hidden"
                 style="margin-top: var(--spacing-md); padding: var(--spacing-md); background: var(--surface-secondary); border-radius: var(--radius-md); color: var(--text-secondary);"></div>

            <button id="clientConnectExecuteBtn" class="btn btn-primary hidden" style="margin-top: var(--spacing-md);">
                Ïó∞Í≤∞ Ïã§Ìñâ
            </button>
            <button id="clientDialogBackBtn" class="btn btn-secondary hidden" style="margin-top: var(--spacing-md);">
                Îí§Î°ú
            </button>
        </div>
    </div>
</div>

<!-- Terms Modal -->
<div id="termsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="termsTitle" class="modal-title">Ïù¥Ïö©ÏïΩÍ¥Ä</h3>
        </div>
        <div class="modal-body">
            <div id="termsContent"
                 style="max-height: 400px; overflow-y: auto; line-height: var(--line-height-relaxed);"></div>
        </div>
        <div class="modal-footer">
            <button id="termsConfirm" class="btn btn-primary">ÌôïÏù∏</button>
        </div>
    </div>
</div>

<script>
    // Persist selected memo across reloads
    const activeCodeKey = 'activeMemoCode';
    let activeCode = localStorage.getItem(activeCodeKey) || null;

    var currentMenuCode = null;

    document.addEventListener('DOMContentLoaded', () => {

        // Utility selectors
        const $ = selector => document.querySelector(selector);
        const $$ = selector => Array.from(document.querySelectorAll(selector));

        // Safe date parser: handles numeric-string epoch and ISO strings
        function toDate(obj) {
            if (obj == null) return new Date(NaN);
            if (typeof obj === 'string' && /^\d+$/.test(obj)) {
                return new Date(Number(obj));
            }
            return new Date(obj);
        }

        // Move the Toast¬†UI toolbar outside the scrollable editor so it never scrolls away
        function moveToolbar() {
            const toolbar = memoEditorContainer.querySelector('.te-toolbar');
            if (toolbar && !toolbar.classList.contains('toolbar-moved')) {
                const memoDetailElem = document.getElementById('memoDetail');
                memoDetailElem.insertBefore(toolbar, memoEditorContainer);
                toolbar.classList.add('toolbar-moved');
            }
        }

        // Initialize or reinitialize the ToastUI editor
        function initEditor(content = '') {
            return new toastui.Editor({
                el: $('#memoEditor'),
                height: '100%',
                width: '100%',
                initialEditType: 'wysiwyg',
                previewStyle: 'vertical',
                toolbarItems: [
                    ['heading', 'bold', 'italic', 'strike'],
                    ['hr', 'quote'],
                    ['ul', 'ol', 'task', 'table'],
                    ['link', 'code', 'codeblock']
                ],
                hideModeSwitch: true,
                initialValue: content,
                theme: document.body.classList.contains('dark-mode') ? 'dark' : 'light'
            });
        }

        const connectCodeKey = 'connectClientCode';
        let connectClientResponseData = null;

        function initConnectClient() {
            const stored = localStorage.getItem(connectCodeKey);
            if (stored) {
                fetch('/connect/client', {headers: {'Connect-Code': stored}})
                    .then(res => res.json())
                    .then(data => {
                        if (!data) {
                            localStorage.removeItem(connectCodeKey);
                            location.reload();
                        } else {
                            connectClientResponseData = data;
                            const returnedCodes = data.noteCodes;
                            const stored = JSON.parse(localStorage.getItem(noteCodesKey) || '[]');
                            const merged = stored.map(o => o.code).filter(code => returnedCodes.includes(code));
                            returnedCodes.forEach(code => {
                                if (!merged.includes(code)) merged.push(code);
                            });
                            noteCodeObjs = merged.map(code => ({code}));
                            localStorage.setItem(noteCodesKey, JSON.stringify(noteCodeObjs));
                            codes = noteCodeObjs.map(o => o.code);
                        }
                    })
                    .catch(() => {
                        localStorage.removeItem(connectCodeKey);
                        location.reload();
                    });
            }
        }

        initConnectClient();

        currentMenuCode = null;
        const themeToggle = $('#themeToggle');
        const themeIcon = $('#themeIcon');

        const memoEditorContainer = $('#memoEditor');

        function applyEditorThemeClass() {
            const wrapper = memoEditorContainer.querySelector('.toastui-editor-defaultUI, .toastui-editor-dark');
            if (!wrapper) return;
            if (document.body.classList.contains('dark-mode')) {
                wrapper.classList.add('toastui-editor-dark');
                wrapper.classList.remove('toastui-editor-defaultUI');
            } else {
                wrapper.classList.add('toastui-editor-defaultUI');
                wrapper.classList.remove('toastui-editor-dark');
            }
        }

        function updateThemeIcon() {
            if (document.body.classList.contains('dark-mode')) {
                themeIcon.textContent = '‚òÄÔ∏è';
            } else {
                themeIcon.textContent = 'üåô';
            }
        }

        updateThemeIcon();
        let memoEditor = initEditor('');
        moveToolbar();

        document.addEventListener('keydown', e => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (document.activeElement === memoTitle) {
                    updateTitle();
                } else {
                    updateContent();
                }
            }
        });

        applyEditorThemeClass();
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            document.body.classList.toggle('light-mode');
            const newTheme = document.body.classList.contains('dark-mode') ? 'dark-mode' : 'light-mode';
            localStorage.setItem('theme', newTheme);
            updateThemeIcon();
            const currentContent = memoEditor.getMarkdown();
            memoEditor.destroy();
            memoEditor = initEditor(currentContent);
            moveToolbar();
            applyEditorThemeClass();
        });

        const toggleSidebar = $('#toggleSidebar');
        const sidebar = $('.sidebar');
        toggleSidebar.addEventListener('click', () => {
            const isMobile = window.matchMedia('(max-width: 768px)').matches;

            if (isMobile) {
                // Î™®Î∞îÏùº: Í∏∞Ï°¥ Ïä¨ÎùºÏù¥Îìú Î∞©Ïãù
                sidebar.classList.toggle('open');
            } else {
                // Îç∞Ïä§ÌÅ¨ÌÜ±: Ï†ëÌûò/ÌéºÏπ®
                sidebar.classList.toggle('collapsed');
                document.querySelector('.app-content')
                    .classList.toggle('sidebar-collapsed');
            }
        });

        const saveBtn = $('#saveBtn');
        saveBtn.addEventListener('click', () => {
            updateTitle();
            updateContent();
        });

        const contentArea = $('.content');
        contentArea.addEventListener('click', () => {
            if (sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
            }
        });

        let draggedCode = null;
        const clientIdKey = 'clientId';
        const noteCodesKey = 'noteCodes';
        const noteCodeObjsKey = noteCodesKey;
        let noteCodeObjs = JSON.parse(localStorage.getItem(noteCodesKey) || '[]');

        let clientId = localStorage.getItem(clientIdKey);

        function showNotification(msg, type = 'success') {
            let notif = document.querySelector('.notification');
            if (!notif) {
                notif = document.createElement('div');
                notif.className = 'notification';
                document.body.appendChild(notif);
            }
            notif.textContent = msg;
            notif.className = `notification ${type} show`;

            // If a hide timer is already running, reset it
            if (notif._hideTimeout) {
                clearTimeout(notif._hideTimeout);
            }

            // Start a new 1‚Äësecond timer before fade‚Äëout
            notif._hideTimeout = setTimeout(() => {
                notif.classList.remove('show');
            }, 1000); // wait 1‚ÄØs, then CSS takes care of fade‚Äëout
        }

        const isInitial = !clientId;
        if (isInitial) {
            clientId = crypto.randomUUID();
            localStorage.setItem(clientIdKey, clientId);
            fetch('/notification/terms-of-used')
                .then(res => res.json())
                .then(data => showTerms(data));
        } else {
            fetch('/notification')
                .then(res => res.json())
                .then(data => {
                    const storedNumber = localStorage.getItem('notificationNumber');
                    if (storedNumber !== String(data.number)) {
                        showTerms(data);
                    }
                });
        }

        function showTerms(data) {
            const termsModal = document.getElementById('termsModal');
            const termsTitle = document.getElementById('termsTitle');
            const termsContent = document.getElementById('termsContent');
            const termsConfirm = document.getElementById('termsConfirm');
            termsTitle.textContent = data.title;
            termsContent.innerHTML = marked.parse(data.content);
            termsModal.classList.add('show');
            termsConfirm.onclick = () => {
                localStorage.setItem('notificationNumber', String(data.number));
                location.reload();
            };
        }

        const sidebarList = $('#memoList');
        const memoDetail = $('#memoDetail');
        const memoTitle = $('#memoTitle');
        const createDateElem = $('#createDate');
        const updateDateElem = $('#updateDate');
        const addBtn = $('#addBtn');
        const codeInput = $('#codeInput');
        // Restrict to uppercase letters & digits, max 8 chars
        codeInput.addEventListener('input', () => {
            codeInput.value = codeInput.value
                .toUpperCase()
                .replace(/[^A-Z0-9]/g, '')
                .substring(0, 8);
        });
        const noMemoElem = $('#noMemo');
        const settingsBtn = $('#settingsBtn');
        const settingsModal = $('#settingsModal');
        const settingsClose = settingsModal ? $('#settingsClose') : null;
        const autoSaveEnable = settingsModal ? $('#autoSaveEnable') : null;
        const autoSaveInput = settingsModal ? $('#autoSaveIntervalInput') : null;
        const themeSelect = settingsModal ? $('#themeSelect') : null;
        const resetListBtn = settingsModal ? $('#resetListBtn') : null;

        if (settingsBtn) {
            settingsBtn.addEventListener('click', () => {
                const savedInterval = parseInt(localStorage.getItem('autoSaveInterval'));
                if (!isNaN(savedInterval)) {
                    autoSaveEnable.checked = true;
                    autoSaveInput.disabled = false;
                    autoSaveInput.value = savedInterval;
                } else {
                    autoSaveEnable.checked = false;
                    autoSaveInput.disabled = true;
                    autoSaveInput.value = '';
                }
                themeSelect.value = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
                settingsModal.classList.add('show');
                const isLinked = !!connectClientResponseData;
                $('#clientStatus').textContent = isLinked
                    ? `Ïó∞ÎèôÏ§ë: ${connectClientResponseData.code}`
                    : 'ÎØ∏Ïó∞Îèô';
                const btn = $('#clientIntegrationBtn');
                btn.textContent = isLinked ? 'Ïó∞Í≤∞Ìï¥Ï†ú' : 'Ïó∞Í≤∞';
                btn.onclick = () => {
                    if (connectClientResponseData) {
                        localStorage.removeItem(connectCodeKey);
                        connectClientResponseData = null;
                        const statusElem = $('#clientStatus');
                        statusElem.textContent = 'ÎØ∏Ïó∞Îèô';
                        btn.textContent = 'Ïó∞Í≤∞';
                    } else {
                        settingsModal.classList.remove('show');
                        openClientIntegrationDialog();
                    }
                };
            });
            settingsClose.addEventListener('click', () => settingsModal.classList.remove('show'));
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) settingsModal.classList.remove('show');
            });

            autoSaveEnable.addEventListener('change', e => {
                if (e.target.checked) {
                    autoSaveInput.disabled = false;
                    const val = 60;
                    autoSaveInput.value = val;
                    localStorage.setItem('autoSaveInterval', val);
                    setupAutoSave();
                } else {
                    autoSaveInput.disabled = true;
                    localStorage.removeItem('autoSaveInterval');
                    if (autoSaveTimerId !== null) {
                        clearInterval(autoSaveTimerId);
                        autoSaveTimerId = null;
                    }
                }
            });

            autoSaveInput.addEventListener('change', e => {
                let v = parseInt(e.target.value);
                if (isNaN(v) || v < 10) v = 10;
                if (v > 240) v = 240;
                e.target.value = v;
                if (autoSaveEnable.checked) {
                    localStorage.setItem('autoSaveInterval', v);
                    setupAutoSave();
                }
            });

            themeSelect.addEventListener('change', e => {
                const val = e.target.value;
                document.body.classList.toggle('dark-mode', val === 'dark');
                document.body.classList.toggle('light-mode', val === 'light');
                localStorage.setItem('theme', val === 'dark' ? 'dark-mode' : 'light-mode');
                updateThemeIcon();
                const currentContent = memoEditor.getMarkdown();
                memoEditor.destroy();
                memoEditor = initEditor(currentContent);
                applyEditorThemeClass();
            });

            resetListBtn.addEventListener('click', () => {
                if (confirm('Ï†ïÎßê Ï¥àÍ∏∞Ìôî ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                    localStorage.removeItem(noteCodesKey);
                    location.reload();
                }
            });
        }

        function openClientIntegrationDialog() {
            const m = document.getElementById('clientIntegrationModal');
            m.classList.add('show');
            ['createClientBtn', 'connectClientBtn'].forEach(id => document.getElementById(id).classList.remove('hidden'));
            ['clientConnectForm', 'clientConnectStatus', 'clientConnectExecuteBtn', 'clientDialogBackBtn'].forEach(id => document.getElementById(id).classList.add('hidden'));
        }

        $('#clientDialogClose').addEventListener('click', () => {
            $('#clientIntegrationModal').classList.remove('show');
        });

        $('#createClientBtn').addEventListener('click', () => {
            fetch('/connect/client?' + codes.map(c => 'noteCodes=' + encodeURIComponent(c)).join('&'), {method: 'POST'})
                .then(res => res.json())
                .then(data => {
                    localStorage.setItem(connectCodeKey, data.code);
                    connectClientResponseData = data;
                    const status = $('#clientConnectStatus');
                    status.textContent = 'ÏÉùÏÑ± ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§';
                    status.classList.remove('hidden');
                    $('#clientDialogBackBtn').classList.remove('hidden');
                    ['createClientBtn', 'connectClientBtn'].forEach(id => $('#' + id).classList.add('hidden'));
                });
        });

        $('#connectClientBtn').addEventListener('click', () => {
            $('#clientConnectForm').classList.remove('hidden');
            ['createClientBtn', 'connectClientBtn'].forEach(id => $('#' + id).classList.add('hidden'));
            $('#clientDialogBackBtn').classList.remove('hidden');
        });

        $('#clientDialogBackBtn').addEventListener('click', () => {
            location.reload();
        });

        $('#clientCodeConfirmBtn').addEventListener('click', () => {
            const input = $('#clientCodeInput').value.trim();
            const statusElem = $('#clientConnectStatus');
            statusElem.classList.add('hidden');
            fetch('/connect/client', {headers: {'Connect-Code': input}})
                .then(res => res.json().catch(() => null))
                .then(data => {
                    if (!data) {
                        statusElem.textContent = 'Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäî ÏΩîÎìúÏûÖÎãàÎã§';
                        statusElem.classList.remove('hidden');
                        return;
                    }
                    connectClientResponseData = data;
                    statusElem.textContent = 'ÌôïÏù∏ÎêòÏóàÏäµÎãàÎã§\nÏïÑÎûò Ïó∞Í≤∞ Î≤ÑÌäºÏùÑ ÎàÑÎ•¥Î©¥ Í∏∞Ï°¥ Îì±Î°ùÌïú Î©îÎ™®Î•º ÏÇ¨ÎùºÏßëÎãàÎã§';
                    statusElem.classList.remove('hidden');
                    $('#clientConnectExecuteBtn').classList.remove('hidden');
                    $('#clientCodeConfirmBtn').disabled = true;
                })
                .catch(() => {
                    statusElem.textContent = 'Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäî ÏΩîÎìúÏûÖÎãàÎã§';
                    statusElem.classList.remove('hidden');
                });
        });

        $('#clientConnectExecuteBtn').addEventListener('click', () => {
            const data = connectClientResponseData;
            localStorage.setItem(connectCodeKey, data.code);
            noteCodeObjs = data.noteCodes.map(c => ({code: c}));
            localStorage.setItem(noteCodesKey, JSON.stringify(noteCodeObjs));
            location.reload();
        });

        codeInput.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addBtn.click();
            }
        });

        let codes = noteCodeObjs.map(o => o.code);
        let memos = [];
        let autoSaveTimerId = null;

        if (codes.length === 0) {
            memoDetail.classList.add('hidden');
            noMemoElem.classList.remove('hidden');
        }

        function setupAutoSave() {
            if (autoSaveTimerId !== null) {
                clearInterval(autoSaveTimerId);
            }
            const interval = parseInt(localStorage.getItem('autoSaveInterval'));
            if (!isNaN(interval)) {
                autoSaveTimerId = setInterval(() => {
                    if (activeCode) {
                        updateContent();
                    }
                }, interval * 1000);
            }
        }

        setupAutoSave();

        function fetchMemos() {
            if (codes.length === 0) {
                sidebarList.innerHTML = '';
                memoDetail.classList.add('hidden');
                noMemoElem.classList.remove('hidden');
                return;
            }
            fetch('/note/list?' + codes.map(c => 'codes=' + encodeURIComponent(c)).join('&'))
                .then(res => res.json())
                .then(data => {
                    const returnedCodes = data.map(m => m.code);
                    const invalidCodes = codes.filter(c => !returnedCodes.includes(c));
                    if (invalidCodes.length) {
                        noteCodeObjs = noteCodeObjs.filter(o => returnedCodes.includes(o.code));
                        localStorage.setItem(noteCodesKey, JSON.stringify(noteCodeObjs));
                        codes = noteCodeObjs.map(o => o.code);
                    }
                    const fetched = data;
                    memos = codes.map(c => fetched.find(m => m.code === c)).filter(m => m);
                    renderList();
                    if (memos.length === 0) {
                        memoDetail.classList.add('hidden');
                        noMemoElem.classList.remove('hidden');
                        return;
                    }
                    noMemoElem.classList.add('hidden');
                    if (!activeCode || !memos.find(m => m.code === activeCode)) {
                        activeCode = memos[0].code;
                    }
                    localStorage.setItem(activeCodeKey, activeCode);
                    selectMemo(activeCode);
                });
        }

        function renderList() {
            sidebarList.innerHTML = '';
            memos.forEach(m => {
                const li = document.createElement('div');
                li.className = 'memo-item';
                li.setAttribute('draggable', true);

                const preview = m.content ? m.content.substring(0, 100) : '';
                const createDate = new Date(m.createDate).toLocaleDateString();
                const updateDate = new Date(m.updateDate).toLocaleDateString();

                li.innerHTML = `
                    <div class="memo-title">${m.title || '(Ï†úÎ™©ÏóÜÏùå)'}</div>
                    <div class="memo-preview">${preview}</div>
                    <div class="memo-meta">
                        <span>ÏàòÏ†ï: ${updateDate}</span>
                        <span>ÏÉùÏÑ±: ${createDate}</span>
                    </div>
                `;

                if (m.code === activeCode) {
                    li.classList.add('active');
                }

                li.addEventListener('click', () => selectMemo(m.code));

                // Drag and drop functionality
                li.addEventListener('dragstart', function (e) {
                    draggedCode = m.code;
                    e.dataTransfer.effectAllowed = 'move';
                });

                li.addEventListener('dragenter', function (e) {
                    e.preventDefault();
                    if (draggedCode !== m.code) {
                        li.style.backgroundColor = 'var(--surface-secondary)';
                    }
                });

                li.addEventListener('dragleave', function (e) {
                    li.style.backgroundColor = '';
                });

                li.addEventListener('dragover', function (e) {
                    e.preventDefault();
                });

                li.addEventListener('drop', function (e) {
                    e.preventDefault();
                    li.style.backgroundColor = '';
                    if (draggedCode && draggedCode !== m.code) {
                        reorderMemos(draggedCode, m.code);
                    }
                    draggedCode = null;
                });

                sidebarList.appendChild(li);
            });
        }

        function reorderMemos(draggedCode, targetCode) {
            const draggedIndex = noteCodeObjs.findIndex(o => o.code === draggedCode);
            const targetIndex = noteCodeObjs.findIndex(o => o.code === targetCode);

            if (draggedIndex !== -1 && targetIndex !== -1) {
                const draggedItem = noteCodeObjs.splice(draggedIndex, 1)[0];
                noteCodeObjs.splice(targetIndex, 0, draggedItem);
                localStorage.setItem(noteCodesKey, JSON.stringify(noteCodeObjs));
                codes = noteCodeObjs.map(o => o.code);
                fetchMemos();
            }
        }

        function selectMemo(code) {
            activeCode = code;
            localStorage.setItem(activeCodeKey, activeCode);
            const memo = memos.find(m => m.code === code);
            if (memo) {
                memoDetail.classList.remove('hidden');
                noMemoElem.classList.add('hidden');
                memoTitle.value = memo.title || '';
                memoEditor.setMarkdown(memo.content || '');
                createDateElem.textContent = new Date(memo.createDate).toLocaleString();
                updateDateElem.textContent = new Date(memo.updateDate).toLocaleString();
                renderList();
            }
        }

        // Ï†úÎ™©Îßå Ï†ÄÏû•
        function updateTitle() {
            if (!activeCode) return;
            const title = memoTitle.value.trim();

            fetch(`/note/${activeCode}/title`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({title})
            })
                .then(res => res.json())
                .then(data => {
                    const memo = memos.find(m => m.code === activeCode);
                    if (memo) {
                        memo.title = title;
                        const parsed = toDate(data.updateDate ?? Date.now());
                        memo.updateDate = parsed.getTime();
                        updateDateElem.textContent = parsed.toLocaleString();
                        renderList();
                    }
                    showNotification('Ï†úÎ™©Ïù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§', 'success');
                })
                .catch((e) => showNotification('Ï†úÎ™© Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§', 'error'));
        }

        // ÎÇ¥Ïö©Îßå Ï†ÄÏû•
        function updateContent() {
            if (!activeCode) return;
            const content = memoEditor.getMarkdown();

            fetch(`/note/${activeCode}/content`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({content})
            })
                .then(res => res.json())
                .then(data => {
                    const memo = memos.find(m => m.code === activeCode);
                    if (memo) {
                        memo.content = content;
                        const parsed = toDate(data.updateDate ?? Date.now());
                        memo.updateDate = parsed.getTime();
                        updateDateElem.textContent = parsed.toLocaleString();
                        renderList();
                    }
                    showNotification('ÎÇ¥Ïö©Ïù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§', 'success');
                })
                .catch(() => showNotification('ÎÇ¥Ïö© Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§', 'error'));
        }

        function generateCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let out = '';
            for (let i = 0; i < 8; i++) {
                out += chars[Math.floor(Math.random() * chars.length)];
            }
            return out;
        }

        addBtn.addEventListener('click', () => {
            let code = codeInput.value.trim().toUpperCase()
                .replace(/[^A-Z0-9]/g, '')
                .substring(0, 8);

            // If no code entered, generate one until it is unique
            if (!code) {
                do {
                    code = generateCode();
                } while (codes.includes(code));
            } else if (codes.includes(code)) {
                showNotification('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî ÏΩîÎìúÏûÖÎãàÎã§', 'error');
                return;
            }

            fetch(`/note/${code}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({clientId: clientId})
            })
                .then(res => res.json())
                .then(() => {
                    noteCodeObjs.unshift({code}); // ÏÉà Î©îÎ™®Î•º Î™©Î°ù Îß® ÏïûÏóê Î∞∞Ïπò
                    localStorage.setItem(noteCodesKey, JSON.stringify(noteCodeObjs));
                    codes = noteCodeObjs.map(o => o.code);
                    activeCode = code;
                    localStorage.setItem(activeCodeKey, activeCode);
                    codeInput.value = '';
                    fetchMemos();
                    showNotification('Î©îÎ™®Í∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§', 'success');
                })
                .catch(() => {
                    showNotification('Î©îÎ™® Ï∂îÍ∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§', 'error');
                });
        });

        // Share functionality
        const shareBtn = $('#shareBtn');
        const shareModal = $('#shareModal');
        const shareClose = $('#shareClose');

        shareBtn.addEventListener('click', () => {
            shareModal.classList.add('show');
        });

        shareClose.addEventListener('click', () => {
            shareModal.classList.remove('show');
        });

        shareModal.addEventListener('click', (e) => {
            if (e.target === shareModal) {
                shareModal.classList.remove('show');
            }
        });

        fetchMemos();
    });
</script>
</body>
</html>