<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
    <meta name="color-scheme" content="light dark"/>
    <meta name="supported-color-schemes" content="light dark"/>
    <title>Ïò®ÎùºÏù∏ Î©îÎ™®Ïû•</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        /* ---------- Design Tokens ---------- */
        :root {
            /* Light Theme */
            --bg-primary: #FAFBFC;
            --bg-secondary: #F8F9FA;
            --surface-primary: #FFFFFF;
            --surface-secondary: #F1F3F4;
            --surface-elevated: #FFFFFF;
            --surface-overlay: rgba(255, 255, 255, 0.95);

            --text-primary: #1A1A1A;
            --text-secondary: #6B7280;
            --text-tertiary: #9CA3AF;
            --text-accent: #4338CA;

            --accent-primary: #6366F1;
            --accent-secondary: #818CF8;
            --accent-hover: #4F46E5;
            --accent-pressed: #4338CA;

            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;

            --border-primary: rgba(0, 0, 0, 0.08);
            --border-secondary: rgba(0, 0, 0, 0.05);
            --border-focus: var(--accent-primary);

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-full: 9999px;

            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --spacing-xl: 24px;
            --spacing-2xl: 32px;

            --font-xs: 0.75rem;
            --font-sm: 0.875rem;
            --font-base: 1rem;
            --font-lg: 1.125rem;
            --font-xl: 1.25rem;
            --font-2xl: 1.5rem;

            --line-height-tight: 1.25;
            --line-height-normal: 1.5;
            --line-height-relaxed: 1.625;

            --backdrop-blur: blur(20px);
            --transition-fast: 0.15s ease;
            --transition-normal: 0.2s ease;
            --transition-slow: 0.3s ease;

            --folder-bg: #e8e8e8;
        }

        /* Dark Theme */
        body.dark-mode {
            --bg-primary: #0A0A0A;
            --bg-secondary: #111111;
            --surface-primary: #1A1A1A;
            --surface-secondary: #2A2A2A;
            --surface-elevated: #262626;
            --surface-overlay: rgba(26, 26, 26, 0.95);

            --text-primary: #FAFAFA;
            --text-secondary: #A1A1AA;
            --text-tertiary: #71717A;
            --text-accent: #A78BFA;

            --accent-primary: #8B5CF6;
            --accent-secondary: #A78BFA;
            --accent-hover: #7C3AED;
            --accent-pressed: #6D28D9;

            --success: #34D399;
            --warning: #FBBF24;
            --error: #F87171;

            --border-primary: rgba(255, 255, 255, 0.1);
            --border-secondary: rgba(255, 255, 255, 0.05);
            --border-focus: var(--accent-primary);

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.4);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6), 0 10px 10px -5px rgba(0, 0, 0, 0.5);

            --folder-bg: #353535;
        }

        /* ---------- Base Reset ---------- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: var(--font-base);
            line-height: var(--line-height-normal);
            color: var(--text-primary);
            background: var(--bg-primary);
            transition: color var(--transition-normal), background-color var(--transition-normal);
            display: flex;
            flex-direction: column;
        }

        /* ---------- Custom Scrollbar ---------- */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-primary);
            border-radius: var(--radius-full);
            border: 2px solid transparent;
            background-clip: padding-box;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-primary);
            background-clip: padding-box;
        }

        ::-webkit-scrollbar-corner {
            background: transparent;
        }

        /* ---------- Utility Classes ---------- */
        .hidden {
            display: none !important;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* ---------- Animations ---------- */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(4px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
            }
            to {
                transform: translateX(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        /* ---------- Layout ---------- */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .topbar {
            height: 64px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--spacing-lg);
            background: var(--surface-overlay);
            backdrop-filter: var(--backdrop-blur);
            border-bottom: 1px solid var(--border-secondary);
            z-index: 1000;
        }

        .topbar-left,
        .topbar-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .logo {
            font-size: var(--font-lg);
            font-weight: 600;
            color: var(--text-primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .logo::before {
            content: 'üìù';
            font-size: var(--font-xl);
        }

        /* Í≥µÏú† Í≤∞Í≥º ÌôîÎ©¥ Ïä§ÌÉÄÏùº */
        .share-result-container {
            text-align: center;
            padding: var(--spacing-xl) var(--spacing-lg);
            animation: fadeIn 0.3s ease;
            max-width: 480px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
        }

        .share-success-icon {
            font-size: 48px;
            margin-bottom: var(--spacing-lg);
            color: var(--success);
        }

        .share-result-title {
            font-size: var(--font-xl);
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
        }

        .share-code-container {
            background: var(--surface-secondary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .code-display {
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--surface-primary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin: var(--spacing-md) 0;
            box-shadow: var(--shadow-sm);
        }

        .generated-code {
            flex: 1;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: var(--font-xl);
            font-weight: 700;
            color: var(--accent-primary);
            letter-spacing: 2px;
            text-align: center;
            user-select: all;
        }

        .share-code-info {
            font-size: var(--font-sm);
            color: var(--text-secondary);
            margin-top: var(--spacing-md);
        }

        .app-content {
            flex: 1;
            display: grid;
            grid-template-columns: 320px 1fr;
            overflow: hidden;
        }

        /* ---------- Sidebar ---------- */
        .sidebar {
            background: var(--surface-primary);
            border-right: 1px solid var(--border-primary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform var(--transition-normal);
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-secondary);
        }

        .search-container {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-lg);
            padding-left: 40px;
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            background: var(--surface-secondary);
            color: var(--text-primary);
            font-size: var(--font-sm);
            transition: all var(--transition-fast);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .search-icon {
            position: absolute;
            left: var(--spacing-md);
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
            font-size: var(--font-sm);
        }

        .sidebar-controls {
            padding: var(--spacing-md) var(--spacing-lg);
            display: flex;
            gap: var(--spacing-sm);
        }

        .memo-list {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-sm);
        }

        /* ---------- Folder List ---------- */
        .folder-header {
            cursor: pointer;
            position: relative; /* ÏòµÏÖò Î©îÎâ¥ Í∏∞Ï§ÄÏ†ê */
            display: flex;
            flex-direction: column; /* Ï†úÎ™©Ï§Ñ + ÏÑ§Î™ÖÏùÑ ÏÑ∏Î°úÎ°ú */
            gap: 4px;
            padding: var(--spacing-md);
            margin: var(--spacing-xs) 0;
            border-radius: var(--radius-md);
            user-select: none;
            transition: background var(--transition-fast);
            background: var(--folder-bg);
        }

        .folder-header:hover {
            background: var(--folder-bg);
        }

        .folder-header.active {
            background: var(--folder-bg);
            color: var(--text-primary);
        }

        .folder-header.active .folder-description {
            color: rgba(255, 255, 255, .9);
        }

        .folder-header::before {
            content: '‚ñ∏';
            position: absolute;
            left: var(--spacing-sm);
            top: 50%;
            transform: translateY(-50%);
            font-size: var(--font-sm);
            color: var(--text-tertiary); /* Í∏∞Î≥∏ ÏÉâÏÉÅ */
            transition: color var(--transition-fast);
        }

        .folder-header.has-active-memo::before {
            color: var(--accent-primary); /* Î©îÎ™® ÏÑ†ÌÉùÎêú ÌÖåÎëêÎ¶¨ ÏÉâÏÉÅÍ≥º ÎèôÏùºÌïòÍ≤å */
        }

        .folder-list {
            padding: var(--spacing-sm);
            border-bottom: 1px solid var(--border-secondary);
            max-height: 160px;
            overflow-y: auto;
        }

        .folder-item {
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-xs);
            border-radius: var(--radius-md);
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all var(--transition-fast);
        }

        .folder-item:hover {
            background: var(--surface-secondary);
        }

        .folder-item.active {
            background: var(--accent-primary);
            color: #ffffff;
        }

        .folder-delete {
            font-size: var(--font-xs);
            opacity: 0;
            transition: opacity var(--transition-fast);
        }

        .folder-item:hover .folder-delete {
            opacity: 1;
        }

        .folder-header-row {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .folder-description {
            padding-left: 24px;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .folder-options-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1rem;
        }

        .folder-options-menu {
            position: absolute;
            top: calc(var(--spacing-sm) + 28px); /* note Î©îÎâ¥ÏôÄ ÎèôÏùº Y Ïò§ÌîÑÏÖã */
            right: var(--spacing-sm); /* note Î©îÎâ¥ÏôÄ ÎèôÏùº X Ïò§ÌîÑÏÖã */
            background: var(--surface-primary);
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            min-width: 120px;
            z-index: 1000;
            box-shadow: 0 2px 6px rgb(0 0 0 / 12%);
        }

        .folder-option-item {
            padding: 6px 10px;
            cursor: pointer;
        }

        .folder-option-item:hover {
            background: var(--surface-secondary);
        }

        .memo-item {
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-xs);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
            border: 1px solid transparent;
            user-select: none;
        }

        .memo-item:hover {
            background: var(--surface-secondary);
            border-color: var(--border-primary);
        }

        .memo-item.active {
            background: transparent;
            color: var(--text-primary);
            border: 2px solid var(--accent-primary);
            box-shadow: var(--shadow-md);
        }

        .memo-title {
            font-weight: 500;
            font-size: var(--font-sm);
            line-height: var(--line-height-tight);
            margin-bottom: var(--spacing-xs);
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .memo-description {
            font-size: var(--font-xs);
            color: var(--text-tertiary);
            line-height: var(--line-height-normal);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-top: 2px;
        }

        .memo-preview {
            font-size: var(--font-xs);
            color: var(--text-tertiary);
            line-height: var(--line-height-normal);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .memo-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--spacing-sm);
            font-size: var(--font-xs);
            color: var(--text-tertiary);
        }

        .memo-item.active .memo-meta {
            color: var(--text-secondary);
        }

        .sidebar-footer {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* ---------- Content Area ---------- */
        .content {
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .memo-detail {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: var(--spacing-2xl);
            gap: var(--spacing-lg);
            min-height: 0; /* allow flex item to shrink */
            overflow-y: auto; /* enable scrolling when content is long */
        }

        .memo-title-input {
            font-size: var(--font-2xl);
            font-weight: 600;
            padding: var(--spacing-md) var(--spacing-lg);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            background: var(--surface-primary);
            color: var(--text-primary);
            transition: all var(--transition-fast);
        }

        .memo-title-input:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .memo-title-input::placeholder {
            color: var(--text-tertiary);
        }

        .memo-editor-container {
            flex: 1;
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            background: var(--surface-primary);
            overflow: auto;
            box-shadow: var(--shadow-sm);
        }

        .memo-metadata {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--surface-secondary);
            border-radius: var(--radius-lg);
            font-size: var(--font-xs);
            color: var(--text-secondary);
        }

        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: var(--spacing-2xl);
            color: var(--text-tertiary);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: var(--spacing-lg);
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: var(--font-xl);
            font-weight: 500;
            margin-bottom: var(--spacing-sm);
            color: var(--text-secondary);
        }

        .empty-state-description {
            font-size: var(--font-sm);
            line-height: var(--line-height-relaxed);
            max-width: 400px;
        }

        /* ---------- Buttons ---------- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid transparent;
            border-radius: var(--radius-md);
            font-size: var(--font-sm);
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all var(--transition-fast);
            user-select: none;
            white-space: nowrap;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--surface-secondary);
            color: var(--text-secondary);
            border-color: var(--border-primary);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--surface-primary);
            color: var(--text-primary);
            border-color: var(--border-primary);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
        }

        .btn-ghost:hover:not(:disabled) {
            background: var(--surface-secondary);
            color: var(--text-primary);
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: var(--radius-md);
        }

        .btn-sm {
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: var(--font-xs);
        }

        .btn-lg {
            padding: var(--spacing-md) var(--spacing-xl);
            font-size: var(--font-base);
        }

        /* ---------- Modals ---------- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--surface-primary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: fadeIn var(--transition-normal) ease;
        }

        .modal-header {
            padding: var(--spacing-xl);
            border-bottom: 1px solid var(--border-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: var(--font-lg);
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            border-radius: var(--radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all var(--transition-fast);
        }

        .modal-close:hover {
            background: var(--surface-secondary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: var(--spacing-xl);
        }

        .modal-footer {
            padding: var(--spacing-xl);
            border-top: 1px solid var(--border-secondary);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-sm);
        }

        /* ---------- Form Elements ---------- */
        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-size: var(--font-sm);
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: var(--spacing-md);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            background: var(--surface-secondary);
            color: var(--text-primary);
            font-size: var(--font-sm);
            transition: all var(--transition-fast);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-input::placeholder,
        .form-textarea::placeholder {
            color: var(--text-tertiary);
        }

        .form-checkbox {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .form-checkbox input {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-primary);
        }

        /* ---------- Notifications ---------- */
        .notification {
            position: fixed;
            top: calc(64px + var(--spacing-md)); /* below fixed topbar */
            right: var(--spacing-xl);
            background: var(--surface-primary);
            color: var(--text-primary);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-primary);
            z-index: 10001;
            opacity: 0;
            transition: opacity var(--transition-slow);
        }

        /* Î©îÎ™® ÏòµÏÖò Î≤ÑÌäº Ïä§ÌÉÄÏùº */
        .note-options-btn {
            position: absolute;
            top: var(--spacing-sm);
            right: var(--spacing-sm);
            color: var(--text-tertiary);
            background: transparent;
            border: none;
            font-size: var(--font-lg);
            width: 28px;
            height: 28px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 5;
            opacity: 0.7;
            transition: all var(--transition-fast);
        }

        .note-options-btn:hover {
            background: var(--surface-secondary);
            color: var(--text-primary);
            opacity: 1;
        }

        /* Î©îÎ™® ÏòµÏÖò Î©îÎâ¥ Ïä§ÌÉÄÏùº */
        .note-options-menu {
            position: absolute;
            top: calc(var(--spacing-sm) + 28px);
            right: var(--spacing-sm);
            background: var(--surface-elevated);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            z-index: 10;
            min-width: 120px;
            border: 1px solid var(--border-primary);
        }

        .note-option-item {
            padding: var(--spacing-md);
            color: var(--text-primary);
            font-size: var(--font-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .note-option-item:hover {
            background: var(--surface-secondary);
        }

        #errorNotification {
            position: fixed;
            top: 64px;
            left: 0;
            right: 0;
            text-align: center;
            background: var(--error);
            color: white;
            padding: var(--spacing-md);
            z-index: 10002;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .notification.show {
            opacity: 1;
        }

        .notification.success {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .notification.error {
            background: var(--error);
            color: white;
            border-color: var(--error);
        }

        /* ---------- Loading States ---------- */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-primary);
            border-radius: 50%;
            border-top-color: var(--accent-primary);
            animation: spin 1s linear infinite;
        }

        /* ---------- Responsive Design ---------- */
        @media (max-width: 768px) {
            .app-content {
                grid-template-columns: 1fr;
            }

            .app-content.sidebar-collapsed {
                grid-template-columns: 0 1fr;
            }

            .sidebar {
                position: fixed;
                top: 64px;
                left: 0;
                bottom: 0;
                width: 300px;
                z-index: 1000;
                transform: translateX(-100%);
                box-shadow: var(--shadow-xl);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .memo-detail {
                padding: var(--spacing-lg);
            }

            .topbar {
                padding: 0 var(--spacing-md);
            }

            .logo {
                font-size: var(--font-base);
            }

            .modal-content {
                width: 95%;
                margin: var(--spacing-lg);
            }

            .notification {
                top: calc(56px + var(--spacing-md)); /* mobile topbar height + margin */
            }
        }

        @media (max-width: 480px) {
            .topbar {
                height: 56px;
            }

            .app-content {
                height: calc(100vh - 56px);
            }

            .sidebar {
                top: 56px;
                width: 280px;
            }

            .memo-detail {
                padding: var(--spacing-md);
                gap: var(--spacing-md);
            }

            .memo-title-input {
                font-size: var(--font-xl);
            }
        }

        /* ---------- Toast UI Editor Customization ---------- */
        .toastui-editor-defaultUI,
        .toastui-editor-dark {
            border: none !important;
            background: transparent !important;
        }

        .toastui-editor-defaultUI .te-toolbar,
        .toastui-editor-dark .te-toolbar {
            border-bottom: 1px solid var(--border-primary) !important;
            background: var(--surface-secondary) !important;
            padding: var(--spacing-sm) !important;
            position: sticky !important;
            top: 0;
            z-index: 10;
        }

        .toastui-editor-defaultUI .te-toolbar button,
        .toastui-editor-dark .te-toolbar button {
            border-radius: var(--radius-sm) !important;
            margin: 2px !important;
            transition: all var(--transition-fast) !important;
        }

        .toastui-editor-defaultUI .te-toolbar button:hover,
        .toastui-editor-dark .te-toolbar button:hover {
            background: var(--surface-primary) !important;
        }

        .toastui-editor-defaultUI .te-md-container,
        .toastui-editor-dark .te-md-container {
            background: var(--surface-primary) !important;
            color: var(--text-primary) !important;
        }

        .toastui-editor-defaultUI .te-preview,
        .toastui-editor-dark .te-preview {
            background: var(--surface-primary) !important;
            color: var(--text-primary) !important;
        }

        /* Custom class to apply dark mode colors while using light mode settings */
        .dark-mode-colors {
            /* Apply dark mode colors from the toastui-editor-dark.css */
            --toastui-editor-main-color: #4b96e6 !important;
            --toastui-editor-text-color: #e5e5e5 !important;
            --toastui-editor-bg-color: #121212 !important;
            --toastui-editor-border-color: #333 !important;
            --toastui-editor-toolbar-bg-color: #232323 !important;
            --toastui-editor-toolbar-active-color: #555 !important;
            --toastui-editor-scrollbar-thumb-color: #666 !important;
            --toastui-editor-scrollbar-thumb-active-color: #999 !important;
            --toastui-editor-highlight-color: #fff !important;
            --toastui-editor-highlight-background-color: #134a8e !important;
        }

        /* Apply dark mode colors to specific editor elements */
        .dark-mode-colors .toastui-editor-contents,
        .dark-mode-colors .ProseMirror {
            color: var(--text-primary) !important;
            background-color: var(--surface-primary) !important;
        }

        .dark-mode-colors .toastui-editor-toolbar,
        .dark-mode-colors .toastui-editor-defaultUI-toolbar {
            background-color: var(--surface-secondary) !important;
            border-bottom: 1px solid var(--border-primary) !important;
        }

        .dark-mode-colors .toastui-editor-popup,
        .dark-mode-colors .toastui-editor-context-menu {
            background-color: var(--surface-elevated) !important;
            border: 1px solid var(--border-primary) !important;
            color: var(--text-primary) !important;
        }

        /* ---------- Sticky Markdown Toolbar ---------- */
        .sticky-toolbar {
            position: fixed;
            top: 64px; /* height of the .topbar on desktop */
            left: 320px; /* sidebar width */
            right: 0;
            z-index: 999; /* above content, below modal (10000) */
            background: var(--surface-secondary);
            border-bottom: 1px solid var(--border-primary);
            padding: var(--spacing-sm);
            display: flex;
            gap: var(--spacing-xs);
        }

        /* When sidebar is collapsed or on mobile, let the toolbar hug the left edge */
        .sidebar.collapsed ~ .content + #editorToolbarSticky,
        .app-content.sidebar-collapsed + #editorToolbarSticky

        @media (max-width: 768px) {
            .sticky-toolbar {
                left: 0;
                top: 56px; /* mobile topbar height */
            }
        }

        /* Toolbar moved out of editor should fill the width */
        .toolbar-moved {
            width: 100%;
        }

        /* --- Ensure memo pane grows when sidebar is collapsed (all breakpoints) --- */
        .app-content.sidebar-collapsed {
            grid-template-columns: 0 1fr !important;
        }

        .memo-item.in-folder {
            padding-left: calc(var(--spacing-md) + 24px);
        }

        .memo-item.in-folder::before {
            content: '';
            position: absolute;
            left: 4px;
            top: 4px;
            bottom: 4px;
            width: 10px;
            border-radius: var(--radius-sm);
            background: var(--folder-bg);
            opacity: .9;
        }

        .folder-delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            margin-left: 4px;
            color: var(--text-secondary);
        }

        .folder-delete-btn:hover {
            color: var(--error);
        }

        /* Prevent Toast¬†UI from relocating the popup with CSS transforms */
        .toastui-editor-context-menu,
        .toastui-editor-contextmenu {
            transform: none !important;
        }

        /* ---------- Markdown list markers (announcements & terms) ---------- */
        #termsContent ul,
        #termsContent ol,
        .modal-body ul,
        .modal-body ol {
            /* ensure bullets/numbers are visible */
            list-style-position: inside;
            margin: 0 0 var(--spacing-sm) var(--spacing-lg);
            padding-left: 0;
        }

        /* unordered lists: ‚Ä¢ */
        #termsContent ul,
        .modal-body ul {
            list-style-type: disc !important;
        }

        /* ordered lists: 1. */
        #termsContent ol,
        .modal-body ol {
            list-style-type: decimal !important;
        }

        /* ---------- Memo Title Wrapper & Note Status Banner ---------- */
        .memo-title-wrapper {
            position: relative;
            /* Remove width constraint to avoid unintended shrinkage */
        }

        /* Ensure memoTitle input takes full width of its container */
        #memoTitle {
            width: 100%;
            box-sizing: border-box;
        }

        .note-status-banner {
            position: absolute;
            top: -28px;
            left: 0;
            right: 0;
            display: grid;
            grid-template-columns: 1fr auto;
            font-size: 13px;
            height: 20px;
            pointer-events: none;
            z-index: 5;
        }
        .note-status-left,
        .note-status-right {
            display: flex;
            align-items: center;
            pointer-events: auto;
        }
        .note-status-left {
            justify-content: flex-start;
            gap: 6px;
        }
        .note-status-right {
            justify-content: flex-end;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css"/>
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/theme/toastui-editor-dark.css"/>
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
    <!-- Toast¬†UI linkify plugin (auto‚Äëdetect URLs) -->
    <script src="https://uicdn.toast.com/editor-plugin-linkify/latest/toastui-editor-plugin-linkify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
<script>
    (function () {
        var storedTheme = localStorage.getItem('theme') || 'dark-mode';
        document.body.classList.add(storedTheme);
    })();
</script>

<div class="app-container">
    <!-- Error Notification -->
    <div id="errorNotification" class="notification error" style="display: none;"></div>

    <!-- Top Bar -->
    <div class="topbar">
        <div class="topbar-left">
            <button id="toggleSidebar" class="btn btn-ghost btn-icon">
                <span>‚ò∞</span>
            </button>
            <a href="#" class="logo">Ïò®ÎùºÏù∏ Î©îÎ™®Ïû•</a>
        </div>
        <div class="topbar-right">
            <button id="themeToggle" class="btn btn-ghost btn-icon" title="ÌÖåÎßà Î≥ÄÍ≤Ω">
                <span id="themeIcon">üåô</span>
            </button>
            <button id="saveBtn" class="btn btn-primary btn-sm" title="Ï†ÄÏû•">
                <span>üíæ</span>
                <span>Ï†ÄÏû•</span>
            </button>
        </div>
    </div>

    <!-- Sticky toolbar container for the markdown editor -->
    <div id="editorToolbarSticky" class="sticky-toolbar hidden"></div>

    <!-- Main Content -->
    <div class="app-content">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="search-container">
                    <input id="codeInput" class="search-input" type="text" placeholder="ÏÉà Î©îÎ™® ÏΩîÎìú ÏûÖÎ†•..."
                           autocomplete="off" maxlength="8"/>
                    <span class="search-icon">üîç</span>
                </div>
                <div class="sidebar-controls">
                    <button id="addBtn" class="btn btn-primary btn-sm" title="Î©îÎ™® Ï∂îÍ∞Ä">
                        <span>‚ûï</span>
                        <span>Ï∂îÍ∞Ä</span>
                    </button>
                    <button id="addFolderBtn" class="btn btn-secondary btn-sm" title="Ìè¥Îçî Ï∂îÍ∞Ä">
                        <span>üìÅ</span>
                        <span>Ìè¥Îçî</span>
                    </button>
                </div>
            </div>

            <div id="folderList" class="folder-list"></div>
            <div class="memo-list" id="memoList">
                <!-- Memo items will be populated here -->
            </div>

            <div class="sidebar-footer">
                <button id="settingsBtn" class="btn btn-ghost btn-sm" title="ÏÑ§Ï†ï">
                    <span>‚öôÔ∏è</span>
                    <span>ÏÑ§Ï†ï</span>
                </button>
                <button id="shareBtn" class="btn btn-ghost btn-sm" title="Í≥µÏú†">
                    <span>üîó</span>
                    <span>Í≥µÏú†</span>
                </button>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content">
            <div id="memoDetail" class="memo-detail hidden">
                <div class="memo-title-wrapper" style="position: relative;">
                    <div id="noteStatusBanner" class="note-status-banner">
                      <div class="note-status-left">
                        <div id="editStatusNote" style="display:none; color: var(--warning);"></div>
                        <button id="refreshMemoBtn" class="btn btn-secondary btn-sm" style="display:none;">ÏÉàÎ°úÍ≥†Ïπ®</button>
                      </div>
                      <div class="note-status-right">
                        <div id="viewerCountNote" style="display:none; color: var(--text-secondary);"></div>
                      </div>
                    </div>
                    <input id="memoTitle" class="memo-title-input" type="text" placeholder="Î©îÎ™® Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
                           autocomplete="off"/>
                </div>
                <div id="memoEditor" class="memo-editor-container"></div>
                <div class="memo-metadata">
                    <div id="memoDates">
                        <span>ÏÉùÏÑ±: <span id="createDate">-</span></span>
                        <span>ÏàòÏ†ï: <span id="updateDate">-</span></span>
                    </div>
                    <div class="save-status">
                        <span id="saveStatus" class="hidden">Ï†ÄÏû•Îê®</span>
                    </div>
                </div>
            </div>

            <div id="noMemo" class="empty-state">
                <div class="empty-state-icon">üìù</div>
                <div class="empty-state-title">Î©îÎ™®Í∞Ä ÏóÜÏäµÎãàÎã§</div>
                <div class="empty-state-description">
                    ÏÉàÎ°úÏö¥ Î©îÎ™®Î•º Ï∂îÍ∞ÄÌïòÏó¨ ÏãúÏûëÌïòÏÑ∏Ïöî.<br>
                    ÏôºÏ™Ω ÏÇ¨Ïù¥ÎìúÎ∞îÏóêÏÑú Î©îÎ™® ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÍ≥† Ï∂îÍ∞Ä Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div id="shareModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Î©îÎ™® Í≥µÏú†</h3>
            <button id="shareClose" class="modal-close">‚úï</button>
        </div>
        <div class="modal-body">
            <div id="shareStageSelect">
                <div class="form-group">
                    <div style="display: flex; gap: var(--spacing-sm); justify-content: center;">
                        <button id="receiveBtn" class="btn btn-secondary">Í≥µÏú†Î∞õÍ∏∞</button>
                        <button id="createBtn" class="btn btn-primary">Í≥µÏú†ÌïòÍ∏∞</button>
                    </div>
                </div>
            </div>

            <div id="shareStageReceive" class="hidden">
                <div class="form-group">
                    <label class="form-label">Í≥µÏú† ÏΩîÎìú</label>
                    <input id="shareCodeInput" class="form-input" type="text" placeholder="Í≥µÏú† ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                           autocomplete="off" spellcheck="false" autocorrect="off" autocapitalize="off"/>
                </div>
                <button id="shareCodeConfirmBtn" class="btn btn-primary">ÌôïÏù∏</button>
            </div>

            <div id="shareStageCreate" class="hidden">
                <div class="form-group">
                    <div style="display: flex; gap: var(--spacing-sm); justify-content: center;">
                        <button id="modeLinkBtn" class="btn btn-secondary">ÎßÅÌÅ¨</button>
                        <button id="modeFileBtn" class="btn btn-secondary">ÌååÏùº</button>
                    </div>
                </div>

                <div id="linkInputWrap" class="hidden">
                    <div class="form-group">
                        <label class="form-label">ÎßÅÌÅ¨</label>
                        <input id="linkInput" class="form-input" type="text" placeholder="Í≥µÏú†Ìï† ÎßÅÌÅ¨Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                               autocomplete="off" spellcheck="false" autocorrect="off" autocapitalize="off"/>
                    </div>
                </div>

                <div id="fileInputWrap" class="hidden">
                    <div class="form-group">
                        <label class="form-label">ÌååÏùº</label>
                        <div style="border: 2px dashed var(--border-primary); border-radius: var(--radius-md); padding: var(--spacing-2xl); text-align: center; cursor: pointer;">
                            <input id="fileInput" type="file" style="display: none;"/>
                            <p id="fileDropText" style="color: var(--text-secondary);">ÌååÏùºÏùÑ ÎìúÎûòÍ∑∏ÌïòÍ±∞ÎÇò ÌÅ¥Î¶≠ÌïòÏó¨ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</p>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Í≥µÏú† Í∞ÄÎä• ÌöüÏàò</label>
                    <input type="number" id="remainingInput" class="form-input" min="1" max="99" value="1"/>
                </div>

                <button id="shareSubmitBtn" class="btn btn-primary" disabled>Í≥µÏú†ÌïòÍ∏∞</button>

                <div id="shareResultWrap" class="hidden" style="margin-top: var(--spacing-xl); text-align: center;">
                    <div id="shareResultText"
                         style="white-space: pre-wrap; font-size: var(--font-sm); margin-bottom: var(--spacing-md);"></div>
                    <div class="form-group">
                        <label class="form-label">Í≥µÏú† ÏΩîÎìú</label>
                        <div style="display: flex; gap: var(--spacing-sm);">
                            <input id="shareResultCode" class="form-input" type="text" readonly/>
                            <button id="copyCodeBtn" class="btn btn-secondary" title="ÏΩîÎìú Î≥µÏÇ¨">Î≥µÏÇ¨</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ï†ïÎ≥¥</label>
                        <div style="font-size: var(--font-sm); text-align: left; background: var(--surface-secondary); border-radius: var(--radius-md); padding: var(--spacing-md);">
                            <div>ÏÉùÏÑ± ÏùºÏûê: <span id="shareCreateDate">-</span></div>
                            <div>ÎßåÎ£å ÏùºÏûê: <span id="shareExpireDate">-</span></div>
                            <div>ÎÇ®ÏùÄ Ï°∞ÌöåÏàò: <span id="shareRemainingCnt">-</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">ÏÑ§Ï†ï</h3>
            <button id="settingsClose" class="modal-close">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <div class="form-checkbox">
                    <input type="checkbox" id="autoSaveEnable"/>
                    <label for="autoSaveEnable">ÏûêÎèô Ï†ÄÏû• ÌôúÏÑ±Ìôî</label>
                </div>
                <input type="number" id="autoSaveIntervalInput" class="form-input" min="10" max="240" placeholder="60"
                       style="margin-top: var(--spacing-sm);" disabled/>
                <small style="color: var(--text-tertiary);">ÏûêÎèô Ï†ÄÏû• Í∞ÑÍ≤© (Ï¥à)</small>
            </div>

            <div class="form-group">
                <label class="form-label">ÌÖåÎßà</label>
                <select id="themeSelect" class="form-select">
                    <option value="light">ÎùºÏù¥Ìä∏ Î™®Îìú</option>
                    <option value="dark">Îã§ÌÅ¨ Î™®Îìú</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ïó∞Îèô</label>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span id="clientStatus" style="color: var(--text-secondary);">ÎØ∏Ïó∞Îèô</span>
                    <button id="clientIntegrationBtn" class="btn btn-secondary btn-sm">Ïó∞Í≤∞</button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button id="resetListBtn" class="btn btn-secondary">Î©îÎ™® Î™©Î°ù Ï¥àÍ∏∞Ìôî</button>
        </div>
    </div>
</div>

<!-- Client Integration Modal -->
<div id="clientIntegrationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ïó∞Îèô</h3>
            <button id="clientDialogClose" class="modal-close">‚úï</button>
        </div>
        <div class="modal-body">
            <div id="createClientBtn" class="btn btn-primary"
                 style="margin: var(--spacing-sm); width: calc(100% - var(--spacing-lg));">ÏÉà ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÉùÏÑ±
            </div>
            <div id="connectClientBtn" class="btn btn-secondary"
                 style="margin: var(--spacing-sm); width: calc(100% - var(--spacing-lg));">Í∏∞Ï°¥ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ïó∞Í≤∞
            </div>

            <div id="clientConnectForm" class="hidden">
                <div class="form-group">
                    <label class="form-label">ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏΩîÎìú</label>
                    <input id="clientCodeInput" class="form-input" type="text" placeholder="ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"/>
                </div>
                <button id="clientCodeConfirmBtn" class="btn btn-primary">ÌôïÏù∏</button>
            </div>

            <div id="clientConnectStatus" class="hidden"
                 style="margin-top: var(--spacing-md); padding: var(--spacing-md); background: var(--surface-secondary); border-radius: var(--radius-md); color: var(--text-secondary);"></div>

            <button id="clientConnectExecuteBtn" class="btn btn-primary hidden" style="margin-top: var(--spacing-md);">
                Ïó∞Í≤∞ Ïã§Ìñâ
            </button>
            <button id="clientDialogBackBtn" class="btn btn-secondary hidden" style="margin-top: var(--spacing-md);">
                Îí§Î°ú
            </button>
        </div>
    </div>
</div>

<!-- Ï¥àÎåÄ Î™®Îã¨ -->
<div id="inviteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Î©îÎ™® Ï¥àÎåÄ</h3>
            <button id="inviteClose" class="modal-close">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Ï¥àÎåÄ ÏΩîÎìú</label>
                <div style="display: flex; gap: var(--spacing-sm);">
                    <input id="inviteCodeDisplay" class="form-input" type="text" readonly/>
                    <button id="copyInviteCodeBtn" class="btn btn-secondary" title="ÏΩîÎìú Î≥µÏÇ¨">Î≥µÏÇ¨</button>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Ï¥àÎåÄ URL</label>
                <div style="display: flex; gap: var(--spacing-sm);">
                    <input id="inviteUrlDisplay" class="form-input" type="text" readonly/>
                    <button id="copyInviteUrlBtn" class="btn btn-secondary" title="URL Î≥µÏÇ¨">Î≥µÏÇ¨</button>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">QR ÏΩîÎìú</label>
                <div id="qrCodeContainer" style="text-align: center; margin-top: var(--spacing-md);">
                    <!-- QR ÏΩîÎìúÍ∞Ä Ïó¨Í∏∞Ïóê ÏÉùÏÑ±Îê©ÎãàÎã§ -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Folder Invite Modal -->
<div id="folderInviteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Ìè¥Îçî Ï¥àÎåÄ</h3>
            <button id="folderInviteClose" class="modal-close">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">ÎßÅÌÅ¨</label>
                <div style="display:flex;gap:var(--spacing-sm);">
                    <input id="folderInviteLink" class="form-input" type="text" readonly/>
                    <button id="copyFolderInviteLinkBtn" class="btn btn-secondary">Î≥µÏÇ¨</button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">ÎßåÎ£å ÏùºÏûê</label>
                <input id="folderInviteExpire" class="form-input" type="text" readonly/>
            </div>
            <div class="form-group">
                <label class="form-label">QR ÏΩîÎìú</label>
                <div id="folderInviteQr" style="text-align:center;margin-top:var(--spacing-md);"></div>
            </div>
        </div>
    </div>
</div>

<!-- Move Folder Modal -->
<div id="moveFolderModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Ìè¥ÎçîÎ°ú Ïù¥Îèô</h3>
        </div>
        <div class="modal-body">
            <select id="moveFolderSelect" class="form-input" style="width:100%;"></select>
        </div>
        <div class="modal-footer">
            <button id="moveFolderConfirm" class="btn btn-primary">ÌôïÏù∏</button>
            <button id="moveFolderCancel" class="btn btn-secondary">Ï∑®ÏÜå</button>
        </div>
    </div>
</div>

<!-- Terms Modal -->
<div id="termsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="termsTitle" class="modal-title">Ïù¥Ïö©ÏïΩÍ¥Ä</h3>
        </div>
        <div class="modal-body">
            <div id="termsContent"
                 style="max-height: 400px; overflow-y: auto; line-height: var(--line-height-relaxed);"></div>
        </div>
        <div class="modal-footer">
            <button id="termsConfirm" class="btn btn-primary">ÌôïÏù∏</button>
        </div>
    </div>
</div>

<script>
    // Persist selected memo across reloads
    const activeCodeKey = 'activeMemoCode';
    let activeCode = localStorage.getItem(activeCodeKey) || null;

    var currentMenuCode = null;

    document.addEventListener('DOMContentLoaded', () => {

        if (typeof marked !== 'undefined') {
            marked.setOptions({gfm: true, breaks: true});
        }

        // Î¨∏ÏÑú ÌÅ¥Î¶≠ Ïãú Ïó¥Î¶∞ ÏòµÏÖò Î©îÎâ¥ Îã´Í∏∞
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.note-options-btn') &&
                !e.target.closest('.note-options-menu') &&
                !e.target.closest('.folder-options-btn') &&
                !e.target.closest('.folder-options-menu')) {
                document.querySelectorAll('.note-options-menu')
                    .forEach(menu => menu.classList.add('hidden'));
                document.querySelectorAll('.folder-options-menu')
                    .forEach(menu => menu.classList.add('hidden'));
            }
        });

        // ThymeleafÎ°úÎ∂ÄÌÑ∞ Ï†ÑÎã¨Îêú ÏóêÎü¨ Î©îÏãúÏßÄ Ï≤òÎ¶¨
        const errorParam = '[[${errorMessage}]]';
        if (errorParam && errorParam !== '[[${errorMessage}]]') {
            const errorNotification = document.getElementById('errorNotification');
            errorNotification.textContent = errorParam;
            errorNotification.style.display = 'block';
            setTimeout(() => {
                errorNotification.style.opacity = '1';
            }, 100);
            setTimeout(() => {
                errorNotification.style.opacity = '0';
                setTimeout(() => {
                    errorNotification.style.display = 'none';
                }, 500);
            }, 3000);
        }

        // Ï¥àÎåÄ Î™®Îã¨ ÌëúÏãú Ìï®Ïàò
        function showInviteModal(noteCode) {
            const inviteModal = document.getElementById('inviteModal');
            const inviteCodeDisplay = document.getElementById('inviteCodeDisplay');
            const inviteUrlDisplay = document.getElementById('inviteUrlDisplay');
            const qrCodeContainer = document.getElementById('qrCodeContainer');
            const inviteUrl = `${window.location.origin}/page/note/invite?code=${noteCode}`;

            // QRCode ÎùºÏù¥Î∏åÎü¨Î¶¨Í∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÎäîÏßÄ ÌôïÏù∏
            const isQRCodeLoaded = typeof QRCode !== 'undefined';
            if (!isQRCodeLoaded) {
                // QRCode ÎùºÏù¥Î∏åÎü¨Î¶¨ ÎèôÏ†Å Î°úÎìú ÏãúÎèÑ
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js';
                document.head.appendChild(script);

                // Î°úÎî© Î©îÏãúÏßÄ ÌëúÏãú
                qrCodeContainer.innerHTML = '<p style="color: var(--text-secondary);">QR ÏΩîÎìú Î°úÎî© Ï§ë...</p>';
            }

            // ÏΩîÎìúÏôÄ URL ÌëúÏãú
            inviteCodeDisplay.value = noteCode;
            inviteUrlDisplay.value = inviteUrl;

            // QR ÏΩîÎìú ÏÉùÏÑ±
            qrCodeContainer.innerHTML = '';
            try {
                new QRCode(qrCodeContainer, {
                    text: inviteUrl,
                    width: 128,
                    height: 128,
                    colorDark: document.body.classList.contains('dark-mode') ? '#FFFFFF' : '#000000',
                    colorLight: document.body.classList.contains('dark-mode') ? '#1A1A1A' : '#FFFFFF',
                });
            } catch (error) {
                console.error('QR ÏΩîÎìú ÏÉùÏÑ± Ïò§Î•ò:', error);
                qrCodeContainer.innerHTML = '<p style="color: var(--text-secondary);">QR ÏΩîÎìúÎ•º ÏÉùÏÑ±Ìï† Ïàò ÏóÜÏäµÎãàÎã§.</p>';
            }

            // Î™®Îã¨ ÌëúÏãú
            inviteModal.classList.add('show');

            // Îã´Í∏∞ Î≤ÑÌäº Ïù¥Î≤§Ìä∏
            document.getElementById('inviteClose').addEventListener('click', () => {
                inviteModal.classList.remove('show');
            });

            // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
            inviteModal.addEventListener('click', (e) => {
                if (e.target === inviteModal) {
                    inviteModal.classList.remove('show');
                }
            });

            // ÏΩîÎìú Î≥µÏÇ¨ Î≤ÑÌäº
            document.getElementById('copyInviteCodeBtn').addEventListener('click', () => {
                inviteCodeDisplay.select();
                document.execCommand('copy');
                showNotification('Ï¥àÎåÄ ÏΩîÎìúÍ∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§', 'success');
            });

            // URL Î≥µÏÇ¨ Î≤ÑÌäº
            document.getElementById('copyInviteUrlBtn').addEventListener('click', () => {
                inviteUrlDisplay.select();
                document.execCommand('copy');
                showNotification('Ï¥àÎåÄ URLÏù¥ Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§', 'success');
            });
        }

        /* ---------- Folder Invite ---------- */
        function showFolderInviteModal(sharedLink, expireDate) {
            const modal = document.getElementById('folderInviteModal');
            const linkInput = document.getElementById('folderInviteLink');
            const expireInput = document.getElementById('folderInviteExpire');
            const qrWrap = document.getElementById('folderInviteQr');

            linkInput.value = sharedLink;
            expireInput.value = expireDate.replace('T', ' ').substring(0, 16);

            qrWrap.innerHTML = '';
            new QRCode(qrWrap, {
                text: sharedLink,
                width: 128,
                height: 128,
                colorDark: document.body.classList.contains('dark-mode') ? '#FFFFFF' : '#000000',
                colorLight: document.body.classList.contains('dark-mode') ? '#1A1A1A' : '#FFFFFF',
            });

            document.getElementById('copyFolderInviteLinkBtn').onclick = () => {
                linkInput.select();
                document.execCommand('copy');
                showNotification('ÎßÅÌÅ¨Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§', 'success');
            };

            const closeBtn = document.getElementById('folderInviteClose');
            const hide = () => modal.classList.remove('show');
            closeBtn.onclick = hide;
            modal.onclick = e => {
                if (e.target === modal) hide();
            };

            modal.classList.add('show');
        }

        async function inviteFolder(folderObj) {
            if (!folderObj || !folderObj.codes || folderObj.codes.length === 0) {
                showNotification('Ìè¥ÎçîÏóê Î©îÎ™®Í∞Ä ÏóÜÏäµÎãàÎã§', 'error');
                return;
            }

            const baseUrl = window.location.origin;
            const codesStr = folderObj.codes.join(',');
            let inviteLink = `${baseUrl}/page/note/invite?code=${codesStr}&folder=${encodeURIComponent(folderObj.name)}`;
            if (folderObj.description) {
                inviteLink += `&folderDescription=${encodeURIComponent(folderObj.description)}`;
            }

            const res = await fetch(`${baseUrl}/share/link`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({link: inviteLink, remainingCnt: 1000})
            });
            if (!res.ok) {
                showNotification('Í≥µÏú† ÎßÅÌÅ¨ ÏÉùÏÑ± Ïã§Ìå®', 'error');
                return;
            }

            const data = await res.json();  // ShareBody
            const sharedLink = `${baseUrl}/page/share/${data.code}`;
            showFolderInviteModal(sharedLink, data.expireDate);
        }

        // Î©îÎ™® ÏÇ≠Ï†ú Ìï®Ïàò
        function deleteNote(noteCode) {
            // Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú Î©îÎ™® ÏΩîÎìú Ï†úÍ±∞
            noteCodeObjs = noteCodeObjs.filter(o => o.code !== noteCode);
            localStorage.setItem(noteCodesKey, JSON.stringify(noteCodeObjs));
            codes = noteCodeObjs.map(o => o.code);

            // Î™®Îì† Ìè¥ÎçîÏóêÏÑú Ìï¥Îãπ ÏΩîÎìú Ï†úÍ±∞
            folders.forEach(f => {
                f.codes = f.codes.filter(c => c !== noteCode);
            });
            saveFolders();

            // connectClientCodeÍ∞Ä ÏûàÏúºÎ©¥ ÏÑúÎ≤ÑÏóêÏÑúÎèÑ ÏÇ≠Ï†ú
            const connectCode = localStorage.getItem('connectClientCode');
            if (connectCode) {
                fetch(`/connect/client/note/codes/${noteCode}`, {
                    method: 'DELETE',
                    headers: {
                        'Connect-Code': connectCode
                    }
                }).catch(err => console.error('ÏÑúÎ≤Ñ ÏÇ≠Ï†ú Ïã§Ìå®:', err));
            }

            // ÌòÑÏû¨ ÌôúÏÑ±ÌôîÎêú Î©îÎ™®Í∞Ä ÏÇ≠Ï†úÎêú Î©îÎ™®Ïù∏ Í≤ΩÏö∞ Ï≤òÎ¶¨
            if (activeCode === noteCode) {
                if (codes.length > 0) {
                    activeCode = codes[0];
                    localStorage.setItem(activeCodeKey, activeCode);
                } else {
                    activeCode = null;
                    localStorage.removeItem(activeCodeKey);
                }
            }

            showNotification('Î©îÎ™®Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§', 'success');
            fetchMemos(); // Î©îÎ™® Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
        }

        // Utility selectors
        const $ = selector => document.querySelector(selector);
        const $$ = selector => Array.from(document.querySelectorAll(selector));

        // Safe date parser: handles numeric-string epoch and ISO strings
        function toDate(obj) {
            if (obj == null) return new Date(NaN);
            if (typeof obj === 'string' && /^\d+$/.test(obj)) {
                return new Date(Number(obj));
            }
            return new Date(obj);
        }

        // Move the Toast¬†UI toolbar into the fixed container so it never scrolls away
        function moveToolbar() {
            const toolbar = memoEditorContainer.querySelector('.te-toolbar');
            const sticky = document.getElementById('editorToolbarSticky');
            if (toolbar && !sticky.contains(toolbar)) {
                sticky.classList.remove('hidden');
                sticky.appendChild(toolbar);
                toolbar.classList.add('toolbar-moved');
                toolbar.style.position = 'static';
                toolbar.style.background = 'transparent';
                toolbar.style.border = 'none';
                toolbar.style.width = '100%';
            }
        }

        // Keep the sticky toolbar correctly aligned when the sidebar toggles or the window resizes
        function updateStickyLeft() {
            const sticky = document.getElementById('editorToolbarSticky');
            if (!sticky) return;

            const isMobile = window.matchMedia('(max-width: 768px)').matches;
            const sidebarElem = document.querySelector('.sidebar');
            const collapsed = (sidebarElem && sidebarElem.classList.contains('collapsed')) || isMobile;

            sticky.style.left = collapsed ? '0px' : '320px';
        }

        window.addEventListener('resize', updateStickyLeft);

        // Initialize or reinitialize the ToastUI editor
        function initEditor(content = '') {
            // Use theme based on current mode
            const isDarkMode = document.body.classList.contains('dark-mode');
            const editor = new toastui.Editor({
                el: $('#memoEditor'),
                height: '100%',
                width: '100%',
                initialEditType: 'wysiwyg',
                previewStyle: 'vertical',
                /* auto‚Äëlink URLs + open in new tab */
                htmlRender: {
                    linkAttributes: {
                        target: '_blank',
                        rel: 'noopener noreferrer'
                    }
                },
                // let markdown parser turn bare URLs into links
                markdown: {linkify: true},
                plugins: (toastui.Editor.plugin && toastui.Editor.plugin.linkify)
                    ? [toastui.Editor.plugin.linkify]
                    : [],
                toolbarItems: [
                    ['heading', 'bold', 'italic', 'strike'],
                    ['hr', 'quote'],
                    ['ul', 'ol', 'task', 'table'],
                    ['link', 'code', 'codeblock']
                ],
                hideModeSwitch: true,
                initialValue: content,
                // Use dark theme when in dark mode
                theme: isDarkMode ? 'dark' : 'light'
            });
            /* make editor links open immediately */
            setTimeout(() => {
                // click‚Äëto‚Äëopen for hyperlinks in both WYSIWYG & preview
                if (!memoEditorContainer._toastui_link_listener) {
                    memoEditorContainer.addEventListener('click', e => {
                        const anchor = e.target.closest('a');
                        if (anchor && anchor.href) {
                            e.preventDefault();
                            window.open(anchor.href, '_blank', 'noopener,noreferrer');
                        }
                    });
                    memoEditorContainer._toastui_link_listener = true;
                }
            }, 0);
            return editor;
        }

        const connectCodeKey = 'connectClientCode';
        let connectClientResponseData = null;

        function initConnectClient() {
            const stored = localStorage.getItem(connectCodeKey);
            if (stored) {
                fetch('/connect/client', {headers: {'Connect-Code': stored}})
                    .then(res => res.json())
                    .then(data => {
                        if (!data) {
                            localStorage.removeItem(connectCodeKey);
                            location.reload();
                        } else {
                            connectClientResponseData = data;
                            const returnedCodes = data.noteCodes;
                            const stored = JSON.parse(localStorage.getItem(noteCodesKey) || '[]');
                            const merged = stored.map(o => o.code).filter(code => returnedCodes.includes(code));
                            returnedCodes.forEach(code => {
                                if (!merged.includes(code)) merged.push(code);
                            });
                            noteCodeObjs = merged.map(code => ({code}));
                            localStorage.setItem(noteCodesKey, JSON.stringify(noteCodeObjs));
                            codes = noteCodeObjs.map(o => o.code);
                        }
                    })
                    .catch(() => {
                        localStorage.removeItem(connectCodeKey);
                        location.reload();
                    });
            }
        }

        initConnectClient();

        currentMenuCode = null;
        const themeToggle = $('#themeToggle');
        const themeIcon = $('#themeIcon');

        const memoEditorContainer = $('#memoEditor');

        function applyEditorThemeClass() {
            const wrapper = memoEditorContainer.querySelector('.toastui-editor-defaultUI, .toastui-editor-dark');
            if (!wrapper) return;

            // Apply dark mode colors only when in dark mode
            if (document.body.classList.contains('dark-mode')) {
                // Add a custom class to handle dark mode colors
                wrapper.classList.add('dark-mode-colors');
            } else {
                wrapper.classList.remove('dark-mode-colors');
            }
        }

        function updateThemeIcon() {
            if (document.body.classList.contains('dark-mode')) {
                themeIcon.textContent = '‚òÄÔ∏è';
            } else {
                themeIcon.textContent = 'üåô';
            }
        }

        updateThemeIcon();
        let memoEditor = initEditor('');
        /* ---------- ÏûêÎèô ÌïòÏù¥ÌçºÎßÅÌÅ¨ ---------- */
        // 1) Î∂ôÏó¨ÎÑ£ÏùÄ ÌÖçÏä§Ìä∏Í∞Ä URL ÌïòÎÇòÎùºÎ©¥ Ï¶âÏãú ÎßÅÌÅ¨Î°ú ÏÇΩÏûÖ
        memoEditorContainer.addEventListener('paste', (ev) => {
            const text = (ev.clipboardData || window.clipboardData).getData('text').trim();
            const urlPattern = /^https?:\/\/[^\s]+$/i;
            if (urlPattern.test(text) && memoEditor) {
                ev.preventDefault();
                memoEditor.exec('link', {url: text, linkText: text});
            }
        });

        // 2) ÏûÖÎ†• ÎèÑÏ§ë URL ÎÅùÏóê Ïä§ÌéòÏù¥Ïä§ / ÏóîÌÑ∞ ÏûÖÎ†• Ïãú ÏûêÎèô ÎßÅÌÅ¨Ìôî
        memoEditor.on('keydown', (ev) => {
            if (ev.key !== ' ' && ev.key !== 'Enter') return;
            // 0‚ÄØms ÌÉÄÏûÑÏïÑÏõÉÏúºÎ°ú ÏûÖÎ†• ÌôïÏ†ï ÌõÑ Ïã§Ìñâ
            setTimeout(() => {
                const sel = window.getSelection();
                if (!sel || !sel.anchorNode) return;
                const textNode = sel.anchorNode.nodeType === 3 ? sel.anchorNode : sel.anchorNode.lastChild;
                if (!textNode || textNode.nodeType !== 3) return;

                const words = textNode.textContent.split(/\s/);
                const last = words[words.length - 2] || '';           // ÏßÅÏ†Ñ Îã®Ïñ¥
                const urlPattern = /^https?:\/\/[^\s]+$/i;
                if (urlPattern.test(last)) {
                    memoEditor.exec('link', {url: last, linkText: last});
                }
            }, 0);
        });
        let originalTitle = '';
        let originalContent = '';
        moveToolbar();
        updateStickyLeft();
        // Fix Toast UI table context-menu placement so it appears at the mouse pointer
        memoEditor.on('contextmenu', (e) => {
            const pointerX = e.clientX;
            const pointerY = e.clientY;
            setTimeout(() => {
                const menu = document.querySelector('.toastui-editor-context-menu, .toastui-editor-contextmenu');
                if (!menu) return;

                function pin() {
                    menu.style.position = 'fixed';
                    menu.style.transform = 'none';
                    menu.style.margin = '0';

                    const rect = menu.getBoundingClientRect();
                    let left = pointerX + 4;
                    let top = pointerY + 4;

                    if (left + rect.width > window.innerWidth) left = window.innerWidth - rect.width - 8;
                    if (top + rect.height > window.innerHeight) top = window.innerHeight - rect.height - 8;
                    if (left < 8) left = 8;
                    if (top < 8) top = 8;

                    menu.style.left = `${left}px`;
                    menu.style.top = `${top}px`;
                }

                // initial pin
                pin();

                // keep pinning if Toast¬†UI modifies the style later
                const observer = new MutationObserver(pin);
                observer.observe(menu, {attributes: true, attributeFilter: ['style']});

                // stop observing when the menu closes
                menu.addEventListener('mouseleave', () => observer.disconnect(), {once: true});
            }, 0);
        });

        document.addEventListener('keydown', e => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (document.activeElement === memoTitle) {
                    updateTitle();
                } else {
                    updateContent();
                }
            }
        });

        applyEditorThemeClass();
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            document.body.classList.toggle('light-mode');
            const newTheme = document.body.classList.contains('dark-mode') ? 'dark-mode' : 'light-mode';
            localStorage.setItem('theme', newTheme);
            updateThemeIcon();
            const currentContent = memoEditor.getMarkdown();
            memoEditor.destroy();
            memoEditor = initEditor(currentContent);
            moveToolbar();
            updateStickyLeft();
            // Fix Toast UI table context-menu placement so it appears at the mouse pointer
            memoEditor.on('contextmenu', (e) => {
                const pointerX = e.clientX;
                const pointerY = e.clientY;
                setTimeout(() => {
                    const menu = document.querySelector('.toastui-editor-context-menu, .toastui-editor-contextmenu');
                    if (!menu) return;

                    function pin() {
                        menu.style.position = 'fixed';
                        menu.style.transform = 'none';
                        menu.style.margin = '0';

                        const rect = menu.getBoundingClientRect();
                        let left = pointerX + 4;
                        let top = pointerY + 4;

                        if (left + rect.width > window.innerWidth) left = window.innerWidth - rect.width - 8;
                        if (top + rect.height > window.innerHeight) top = window.innerHeight - rect.height - 8;
                        if (left < 8) left = 8;
                        if (top < 8) top = 8;

                        menu.style.left = `${left}px`;
                        menu.style.top = `${top}px`;
                    }

                    // initial pin
                    pin();

                    // keep pinning if Toast¬†UI modifies the style later
                    const observer = new MutationObserver(pin);
                    observer.observe(menu, {attributes: true, attributeFilter: ['style']});

                    // stop observing when the menu closes
                    menu.addEventListener('mouseleave', () => observer.disconnect(), {once: true});
                }, 0);
            });
            applyEditorThemeClass();
        });

        const toggleSidebar = $('#toggleSidebar');
        const sidebar = $('.sidebar');
        toggleSidebar.addEventListener('click', () => {
            const isMobile = window.matchMedia('(max-width: 768px)').matches;

            if (isMobile) {
                // Î™®Î∞îÏùº: Í∏∞Ï°¥ Ïä¨ÎùºÏù¥Îìú Î∞©Ïãù
                sidebar.classList.toggle('open');
            } else {
                // Îç∞Ïä§ÌÅ¨ÌÜ±: Ï†ëÌûò/ÌéºÏπ®
                sidebar.classList.toggle('collapsed');
                document.querySelector('.app-content')
                    .classList.toggle('sidebar-collapsed');
            }
            updateStickyLeft();
        });

        const saveBtn = $('#saveBtn');
        saveBtn.addEventListener('click', () => {
            updateTitle();
            updateContent();
        });

        const contentArea = $('.content');
        contentArea.addEventListener('click', () => {
            if (sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
            }
        });

        let draggedCode = null;
        let draggedFolderId = null;
        let draggedSidebarKey = null;     // Î£®Ìä∏ Î©îÎ™®¬∑Ìè¥Îçî ÌòºÌï© Ï†ïÎ†¨Ïö©
        const clientIdKey = 'clientId';
        const noteCodesKey = 'noteCodes';
        const noteCodeObjsKey = noteCodesKey;
        const foldersKey = 'folders';
        const collapsedFoldersKey = 'collapsedFolders';
        let collapsedFolders = JSON.parse(localStorage.getItem(collapsedFoldersKey) || '[]');

        // ‚îÄ‚îÄ ÏÇ¨Ïù¥ÎìúÎ∞î ÌëúÏãú ÏàúÏÑú (Î£®Ìä∏ Î©îÎ™® + Ìè¥Îçî ÎØπÏä§) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const sidebarOrderKey = 'sidebarOrder';
        let sidebarOrder = JSON.parse(localStorage.getItem(sidebarOrderKey) || '[]');

        function saveSidebarOrder() {
            localStorage.setItem(sidebarOrderKey, JSON.stringify(sidebarOrder));
        }

        let folders = JSON.parse(localStorage.getItem(foldersKey) || '[]');
        const activeFolderKey = 'activeFolderId';
        let activeFolderId = localStorage.getItem(activeFolderKey) || null;
        let noteCodeObjs = JSON.parse(localStorage.getItem(noteCodesKey) || '[]')
            .map(o => (typeof o === 'string') ? {code: o} : ({code: o.code}));

        let clientId = localStorage.getItem(clientIdKey);

        function syncSidebarOrder() {
            // ‚ë† ÌòÑÏû¨ Î£®Ìä∏ Î©îÎ™®(Ìè¥Îçî Î∞ñ) + Ìè¥Îçî id Î™©Î°ù ÎßåÎì§Í∏∞
            const current = [];
            const inFolder = folders.flatMap(f => f.codes || []);
            noteCodeObjs.map(o => o.code).forEach(code => {
                if (!inFolder.includes(code)) current.push(code);      // Î£®Ìä∏ Î©îÎ™®
            });
            folders.forEach(f => current.push('F:' + f.id));           // Ìè¥Îçî

            // ‚ë° sidebarOrder Ï†ïÎ¶¨(Î∂àÌïÑÏöî key Ï†úÍ±∞, ÏÉà key Ï∂îÍ∞Ä)
            sidebarOrder = sidebarOrder.filter(k => current.includes(k));
            current.forEach(k => {
                if (!sidebarOrder.includes(k)) sidebarOrder.push(k);
            });

            saveSidebarOrder();
        }

        /* ---------- sidebar Ïû¨Ï†ïÎ†¨ Í≥µÏö© ---------- */
        function reorderSidebar(dragKey, targetKey) {
            const dIdx = sidebarOrder.indexOf(dragKey);
            const tIdx = sidebarOrder.indexOf(targetKey);
            if (dIdx === -1 || tIdx === -1) return;
            const item = sidebarOrder.splice(dIdx, 1)[0];
            sidebarOrder.splice(tIdx, 0, item);
            saveSidebarOrder();
            renderList();
        }

        function showNotification(msg, type = 'success') {
            let notif = document.querySelector('.notification');
            if (!notif) {
                notif = document.createElement('div');
                notif.className = 'notification';
                document.body.appendChild(notif);
            }
            notif.textContent = msg;
            notif.className = `notification ${type} show`;

            // If a hide timer is already running, reset it
            if (notif._hideTimeout) {
                clearTimeout(notif._hideTimeout);
            }

            // Start a new 1‚Äësecond timer before fade‚Äëout
            notif._hideTimeout = setTimeout(() => {
                notif.classList.remove('show');
            }, 1000); // wait 1‚ÄØs, then CSS takes care of fade‚Äëout
        }

        const isInitial = !clientId;
        if (isInitial) {
            clientId = crypto.randomUUID();
            localStorage.setItem(clientIdKey, clientId);
            fetch('/notification/terms-of-used')
                .then(res => res.json())
                .then(data => showTerms(data));
        } else {
            fetch('/notification')
                .then(res => res.json())
                .then(data => {
                    const storedNumber = localStorage.getItem('notificationNumber');
                    if (storedNumber !== String(data.number)) {
                        showTerms(data);
                    }
                });
        }

        function showTerms(data) {
            const termsModal = document.getElementById('termsModal');
            const termsTitle = document.getElementById('termsTitle');
            const termsContent = document.getElementById('termsContent');
            const termsConfirm = document.getElementById('termsConfirm');
            termsTitle.textContent = data.title;
            termsContent.innerHTML = marked.parse(data.content);
            termsModal.classList.add('show');
            termsConfirm.onclick = () => {
                localStorage.setItem('notificationNumber', String(data.number));
                location.reload();
            };
        }

        const sidebarList = $('#memoList');
        const memoDetail = $('#memoDetail');
        const memoTitle = $('#memoTitle');
        const createDateElem = $('#createDate');
        const updateDateElem = $('#updateDate');
        const addBtn = $('#addBtn');
        const addFolderBtn = $('#addFolderBtn');
        if (addFolderBtn) {
            addFolderBtn.addEventListener('click', () => {
                const name = prompt('Ìè¥Îçî Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî');
                if (!name) return;
                const f = {id: crypto.randomUUID(), name: name.trim(), description: '', codes: []};
                folders.push(f);
                saveFolders();
                renderList();
            });
        }
        const codeInput = $('#codeInput');
        // Restrict to uppercase letters & digits, max 8 chars
        codeInput.addEventListener('input', () => {
            codeInput.value = codeInput.value
                .toUpperCase()
                .replace(/[^A-Z0-9]/g, '')
                .substring(0, 8);
        });
        const noMemoElem = $('#noMemo');
        const settingsBtn = $('#settingsBtn');
        const settingsModal = $('#settingsModal');
        const settingsClose = settingsModal ? $('#settingsClose') : null;
        const autoSaveEnable = settingsModal ? $('#autoSaveEnable') : null;
        const autoSaveInput = settingsModal ? $('#autoSaveIntervalInput') : null;
        const themeSelect = settingsModal ? $('#themeSelect') : null;
        const resetListBtn = settingsModal ? $('#resetListBtn') : null;

        if (settingsBtn) {
            settingsBtn.addEventListener('click', () => {
                const savedInterval = parseInt(localStorage.getItem('autoSaveInterval'));
                if (!isNaN(savedInterval)) {
                    autoSaveEnable.checked = true;
                    autoSaveInput.disabled = false;
                    autoSaveInput.value = savedInterval;
                } else {
                    autoSaveEnable.checked = false;
                    autoSaveInput.disabled = true;
                    autoSaveInput.value = '';
                }
                themeSelect.value = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
                settingsModal.classList.add('show');
                const isLinked = !!connectClientResponseData;
                $('#clientStatus').textContent = isLinked
                    ? `Ïó∞ÎèôÏ§ë: ${connectClientResponseData.code}`
                    : 'ÎØ∏Ïó∞Îèô';
                const btn = $('#clientIntegrationBtn');
                btn.textContent = isLinked ? 'Ïó∞Í≤∞Ìï¥Ï†ú' : 'Ïó∞Í≤∞';
                btn.onclick = () => {
                    if (connectClientResponseData) {
                        localStorage.removeItem(connectCodeKey);
                        connectClientResponseData = null;
                        const statusElem = $('#clientStatus');
                        statusElem.textContent = 'ÎØ∏Ïó∞Îèô';
                        btn.textContent = 'Ïó∞Í≤∞';
                    } else {
                        settingsModal.classList.remove('show');
                        openClientIntegrationDialog();
                    }
                };
            });
            settingsClose.addEventListener('click', () => settingsModal.classList.remove('show'));
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) settingsModal.classList.remove('show');
            });

            autoSaveEnable.addEventListener('change', e => {
                if (e.target.checked) {
                    autoSaveInput.disabled = false;
                    const val = 60;
                    autoSaveInput.value = val;
                    localStorage.setItem('autoSaveInterval', val);
                    setupAutoSave();
                } else {
                    autoSaveInput.disabled = true;
                    localStorage.removeItem('autoSaveInterval');
                    if (autoSaveTimerId !== null) {
                        clearInterval(autoSaveTimerId);
                        autoSaveTimerId = null;
                    }
                }
            });

            autoSaveInput.addEventListener('change', e => {
                let v = parseInt(e.target.value);
                if (isNaN(v) || v < 10) v = 10;
                if (v > 240) v = 240;
                e.target.value = v;
                if (autoSaveEnable.checked) {
                    localStorage.setItem('autoSaveInterval', v);
                    setupAutoSave();
                }
            });

            themeSelect.addEventListener('change', e => {
                const val = e.target.value;
                document.body.classList.toggle('dark-mode', val === 'dark');
                document.body.classList.toggle('light-mode', val === 'light');
                localStorage.setItem('theme', val === 'dark' ? 'dark-mode' : 'light-mode');
                updateThemeIcon();
                const currentContent = memoEditor.getMarkdown();
                memoEditor.destroy();
                memoEditor = initEditor(currentContent);
                applyEditorThemeClass();
            });

            resetListBtn.addEventListener('click', () => {
                if (confirm('Ï†ïÎßê Ï¥àÍ∏∞Ìôî ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                    localStorage.removeItem(noteCodesKey);
                    location.reload();
                }
            });
        }

        function openClientIntegrationDialog() {
            const m = document.getElementById('clientIntegrationModal');
            m.classList.add('show');
            ['createClientBtn', 'connectClientBtn'].forEach(id => document.getElementById(id).classList.remove('hidden'));
            ['clientConnectForm', 'clientConnectStatus', 'clientConnectExecuteBtn', 'clientDialogBackBtn'].forEach(id => document.getElementById(id).classList.add('hidden'));
        }

        $('#clientDialogClose').addEventListener('click', () => {
            $('#clientIntegrationModal').classList.remove('show');
        });

        $('#createClientBtn').addEventListener('click', () => {
            fetch('/connect/client?' + codes.map(c => 'noteCodes=' + encodeURIComponent(c)).join('&'), {method: 'POST'})
                .then(res => res.json())
                .then(data => {
                    localStorage.setItem(connectCodeKey, data.code);
                    connectClientResponseData = data;
                    const status = $('#clientConnectStatus');
                    status.textContent = 'ÏÉùÏÑ± ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§';
                    status.classList.remove('hidden');
                    $('#clientDialogBackBtn').classList.remove('hidden');
                    ['createClientBtn', 'connectClientBtn'].forEach(id => $('#' + id).classList.add('hidden'));
                });
        });

        $('#connectClientBtn').addEventListener('click', () => {
            $('#clientConnectForm').classList.remove('hidden');
            ['createClientBtn', 'connectClientBtn'].forEach(id => $('#' + id).classList.add('hidden'));
            $('#clientDialogBackBtn').classList.remove('hidden');
        });

        $('#clientDialogBackBtn').addEventListener('click', () => {
            location.reload();
        });

        $('#clientCodeConfirmBtn').addEventListener('click', () => {
            const input = $('#clientCodeInput').value.trim();
            const statusElem = $('#clientConnectStatus');
            statusElem.classList.add('hidden');
            fetch('/connect/client', {headers: {'Connect-Code': input}})
                .then(res => res.json().catch(() => null))
                .then(data => {
                    if (!data) {
                        statusElem.textContent = 'Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäî ÏΩîÎìúÏûÖÎãàÎã§';
                        statusElem.classList.remove('hidden');
                        return;
                    }
                    connectClientResponseData = data;
                    statusElem.textContent = 'ÌôïÏù∏ÎêòÏóàÏäµÎãàÎã§\nÏïÑÎûò Ïó∞Í≤∞ Î≤ÑÌäºÏùÑ ÎàÑÎ•¥Î©¥ Í∏∞Ï°¥ Îì±Î°ùÌïú Î©îÎ™®Î•º ÏÇ¨ÎùºÏßëÎãàÎã§';
                    statusElem.classList.remove('hidden');
                    $('#clientConnectExecuteBtn').classList.remove('hidden');
                    $('#clientCodeConfirmBtn').disabled = true;
                })
                .catch(() => {
                    statusElem.textContent = 'Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäî ÏΩîÎìúÏûÖÎãàÎã§';
                    statusElem.classList.remove('hidden');
                });
        });

        $('#clientConnectExecuteBtn').addEventListener('click', () => {
            const data = connectClientResponseData;
            localStorage.setItem(connectCodeKey, data.code);
            noteCodeObjs = data.noteCodes.map(c => ({code: c}));
            localStorage.setItem(noteCodesKey, JSON.stringify(noteCodeObjs));
            location.reload();
        });

        codeInput.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addBtn.click();
            }
        });

        let codes = noteCodeObjs.map(o => o.code);
        let memos = [];
        let autoSaveTimerId = null;

        if (codes.length === 0) {
            memoDetail.classList.add('hidden');
            noMemoElem.classList.remove('hidden');
        }

        function saveFolders() {
            localStorage.setItem(foldersKey, JSON.stringify(folders));
        }

        /* ---------- Ìè¥Îçî ÏÇ≠Ï†ú ---------- */
        function deleteFolder(id) {
            const idx = folders.findIndex(f => f.id === id);
            if (idx === -1) return;
            if (!confirm('Ìè¥ÎçîÏôÄ ÏïàÏùò Î™®Îì† Î©îÎ™®Î•º ÏÇ≠Ï†úÌï†ÍπåÏöî?')) return;

            const codesToRemove = [...(folders[idx].codes || [])];

            // ÏïàÏùò Î©îÎ™® Ï†ÑÎ∂Ä ÏÇ≠Ï†ú
            codesToRemove.forEach(cd => deleteNote(cd));

            // Ìè¥Îçî Ï†úÍ±∞
            folders.splice(idx, 1);
            saveFolders();

            activeFolderId = null;
            localStorage.removeItem(activeFolderKey);

            renderList();
        }

        /* ---------- Î©îÎ™®Î•º ÏÑ†ÌÉù Ìè¥ÎçîÏóê Î∞∞Ïπò ---------- */
        function moveNoteToFolder(noteCode, folderId) {
            // Î™®Îì† Ìè¥ÎçîÏóêÏÑú Ï†úÍ±∞
            folders.forEach(f => {
                f.codes = (f.codes || []).filter(c => c !== noteCode);
            });

            // ÎåÄÏÉÅ Ìè¥ÎçîÏóê Ï∂îÍ∞Ä
            if (folderId) {
                const tgt = folders.find(f => f.id === folderId);
                if (tgt) {
                    tgt.codes = tgt.codes || [];
                    if (!tgt.codes.includes(noteCode)) tgt.codes.push(noteCode);
                }
            }

            saveFolders();
            renderList();
        }

        /* ---------- Ìè¥Îçî ÏÑ†ÌÉù Î™®Îã¨ ---------- */
        function showMoveToFolderModal(noteCode) {
            const modal = document.getElementById('moveFolderModal');
            const select = document.getElementById('moveFolderSelect');

            // ÎìúÎ°≠Îã§Ïö¥ Í∞±Ïã†
            select.innerHTML = '';
            folders.forEach(f => {
                const opt = document.createElement('option');
                opt.value = f.id;
                opt.textContent = f.name;
                select.appendChild(opt);
            });
            const addOpt = document.createElement('option');
            addOpt.value = 'add';
            addOpt.textContent = '‚ûï  Ìè¥Îçî Ï∂îÍ∞ÄÌïòÍ∏∞';
            select.appendChild(addOpt);

            modal.classList.add('show');

            document.getElementById('moveFolderCancel').onclick = () => modal.classList.remove('show');
            document.getElementById('moveFolderConfirm').onclick = () => {
                const val = select.value;
                if (val === 'add') {
                    const name = prompt('ÏÉà Ìè¥Îçî Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî');
                    if (!name) return;
                    const newFolder = {id: crypto.randomUUID(), name: name.trim(), description: '', codes: []};
                    folders.push(newFolder);
                    saveFolders();
                    moveNoteToFolder(noteCode, newFolder.id);
                } else {
                    moveNoteToFolder(noteCode, val);
                }
                modal.classList.remove('show');
            };

            // Î™®Îã¨ Î∞∞Í≤Ω ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.remove('show');
            });
        }

        function setupAutoSave() {
            if (autoSaveTimerId !== null) {
                clearInterval(autoSaveTimerId);
            }
            const interval = parseInt(localStorage.getItem('autoSaveInterval'));
            if (!isNaN(interval)) {
                autoSaveTimerId = setInterval(() => {
                    if (activeCode) {
                        updateContent();
                    }
                }, interval * 1000);
            }
        }

        setupAutoSave();

        function fetchMemos() {
            if (codes.length === 0) {
                sidebarList.innerHTML = '';
                memoDetail.classList.add('hidden');
                noMemoElem.classList.remove('hidden');
                return;
            }
            fetch('/note/list?' + codes.map(c => 'codes=' + encodeURIComponent(c)).join('&'))
                .then(res => res.json())
                .then(data => {
                    const returnedCodes = data.map(m => m.code);
                    const invalidCodes = codes.filter(c => !returnedCodes.includes(c));
                    if (invalidCodes.length) {
                        noteCodeObjs = noteCodeObjs.filter(o => returnedCodes.includes(o.code));
                        localStorage.setItem(noteCodesKey, JSON.stringify(noteCodeObjs));
                        codes = noteCodeObjs.map(o => o.code);
                    }
                    const fetched = data;
                    memos = codes.map(c => fetched.find(m => m.code === c)).filter(m => m);
                    renderList();
                    if (memos.length === 0) {
                        memoDetail.classList.add('hidden');
                        noMemoElem.classList.remove('hidden');
                        return;
                    }
                    noMemoElem.classList.add('hidden');
                    if (!activeCode || !memos.find(m => m.code === activeCode)) {
                        activeCode = memos[0].code;
                    }
                    localStorage.setItem(activeCodeKey, activeCode);
                    selectMemo(activeCode);
                });
        }

        function renderList() {
            syncSidebarOrder();
            sidebarList.innerHTML = '';

            /* util: Î©îÎ™® ÌïòÎÇò ÏÉùÏÑ± */
            function buildMemo(m, isRoot = false) {
                const el = document.createElement('div');
                el.className = 'memo-item';
                el.setAttribute('draggable', 'true');

                const cDateStr = new Date(m.createDate).toLocaleDateString();
                const uDateStr = new Date(m.updateDate).toLocaleDateString();

                el.innerHTML = `
            <div class="memo-title">${m.title || '(Ï†úÎ™©ÏóÜÏùå)'}</div>
            ${m.description ? `<div class="memo-description">${m.description}</div>` : ''}
            <div class="memo-meta">
                <span>ÏàòÏ†ï: ${uDateStr}</span>
                <span>ÏÉùÏÑ±: ${cDateStr}</span>
            </div>
            <button class="note-options-btn" title="Î©îÎ™® ÏòµÏÖò">‚ãÆ</button>
            <div class="note-options-menu hidden" data-code="${m.code}">
                <div class="note-option-item invite-option">üîó Ï¥àÎåÄ</div>
                <div class="note-option-item edit-desc-option">‚úèÔ∏è ÏÑ§Î™Ö ÏàòÏ†ï</div>
                <div class="note-option-item move-option">üìÇ Ìè¥ÎçîÎ°ú Ïù¥Îèô</div>
                <div class="note-option-item delete-option">üóëÔ∏è ÏÇ≠Ï†ú</div>
            </div>
        `;

                // Í∏∞Ï°¥ Ïù¥Î≤§Ìä∏(ÏÑ†ÌÉù¬∑ÏòµÏÖò¬∑ÎìúÎûòÍ∑∏) Í∑∏ÎåÄÎ°ú Ïú†ÏßÄ
                el.addEventListener('click', e => {
                    // Î©îÎ™® ÏÑ†ÌÉù
                    if (!e.target.closest('.note-options-btn') && !e.target.closest('.note-options-menu')) {
                        selectMemo(m.code);
                    }
                });

                // ÏòµÏÖò Î©îÎâ¥ Î≤ÑÌäº
                const optionsBtn = el.querySelector('.note-options-btn');
                const optionsMenu = el.querySelector('.note-options-menu');
                if (optionsBtn && optionsMenu) {
                    optionsBtn.addEventListener('click', e => {
                        e.stopPropagation();
                        document.querySelectorAll('.note-options-menu').forEach(menu => {
                            if (menu !== optionsMenu) menu.classList.add('hidden');
                        });
                        optionsMenu.classList.toggle('hidden');
                        currentMenuCode = m.code;
                    });
                    // ÏòµÏÖò Î©îÎâ¥ Ìï≠Î™© Ïù¥Î≤§Ìä∏
                    optionsMenu.querySelector('.invite-option').addEventListener('click', e => {
                        e.stopPropagation();
                        optionsMenu.classList.add('hidden');
                        showInviteModal(m.code);
                    });
                    optionsMenu.querySelector('.edit-desc-option')
                        .addEventListener('click', ev => {
                            ev.stopPropagation();
                            optionsMenu.classList.add('hidden');

                            const newDesc = prompt('Î©îÎ™® ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî', m.description || '');
                            if (newDesc === null) return;

                            fetch(`/note/${m.code}/description`, {
                                method: 'PUT',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({description: newDesc.trim()}),
                            })
                                .then(r => r.ok ? r.json() : Promise.reject())
                                .then(res => {
                                    m.description = (res && res.description) ?? newDesc.trim();
                                    renderList();
                                    showNotification('ÏÑ§Î™ÖÏù¥ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§', 'success');
                                })
                                .catch(() => showNotification('ÏÑ§Î™Ö ÏàòÏ†ï Ïã§Ìå®', 'error'));
                        });
                    optionsMenu.querySelector('.move-option').addEventListener('click', e => {
                        e.stopPropagation();
                        optionsMenu.classList.add('hidden');
                        showMoveToFolderModal(m.code);
                    });
                    optionsMenu.querySelector('.delete-option').addEventListener('click', e => {
                        e.stopPropagation();
                        optionsMenu.classList.add('hidden');
                        deleteNote(m.code);
                    });
                }

                // ‚îÄ‚îÄ ÎìúÎûòÍ∑∏ Ïù¥Î≤§Ìä∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                if (el.classList.contains('in-folder')) {
                    // Ìè¥Îçî ÎÇ¥Î∂Ä Î©îÎ™® Ï†ïÎ†¨
                    el.addEventListener('dragstart', e => {
                        draggedCode = m.code;          // Ìè¥Îçî ÎÇ¥Î∂Ä Ï†ïÎ†¨Ïö©
                        draggedSidebarKey = null;      // Î£®Ìä∏ Ïû¨Î∞∞ÏπòÎäî ÎÅÑÍ∏∞
                        e.dataTransfer.setData('text/plain', m.code);
                        e.dataTransfer.effectAllowed = 'move';
                    });
                    el.addEventListener('dragend', () => {
                        draggedCode = null;
                        el.style.background = '';
                    });
                    el.addEventListener('dragover', e => {
                        e.preventDefault();
                        el.style.background = 'var(--surface-secondary)';
                    });
                    el.addEventListener('dragleave', () => el.style.background = '');
                    el.addEventListener('drop', e => {
                        e.preventDefault();
                        el.style.background = '';
                        if (draggedCode && draggedCode !== m.code) {
                            reorderMemos(draggedCode, m.code);
                        }
                        draggedCode = null;
                    });
                } else {
                    // Î£®Ìä∏ Î©îÎ™® ‚Üî Ìè¥Îçî ÌòºÌï© Ï†ïÎ†¨
                    el.addEventListener('dragstart', e => {
                        draggedCode = m.code;          // Ìè¥Îçî Ïù¥ÎèôÏùÑ ÏúÑÌï¥ Ïú†ÏßÄ
                        draggedSidebarKey = m.code;    // ÏÇ¨Ïù¥ÎìúÎ∞î Ï†ïÎ†¨ ÌÇ§
                        e.dataTransfer.setData('text/plain', m.code);
                        e.dataTransfer.effectAllowed = 'move';
                    });
                    el.addEventListener('dragend', () => {
                        draggedCode = null;
                        draggedSidebarKey = null;
                        el.style.background = '';
                    });
                    el.addEventListener('dragover', e => {
                        e.preventDefault();
                        if (draggedSidebarKey && draggedSidebarKey !== m.code)
                            el.style.background = 'var(--surface-secondary)';
                    });
                    el.addEventListener('dragleave', () => el.style.background = '');
                    el.addEventListener('drop', e => {
                        e.preventDefault();
                        el.style.background = '';

                        // Ìè¥Îçî ÏïàÏóêÏÑú ÎÅåÏñ¥Ïò® Î©îÎ™®ÎùºÎ©¥ Î£®Ìä∏Î°ú Ïù¥Îèô
                        if (draggedCode) {
                            moveNoteToFolder(draggedCode, null);
                        }

                        // ÏÇ¨Ïù¥ÎìúÎ∞î Ï†ïÎ†¨
                        if (draggedSidebarKey && draggedSidebarKey !== m.code) {
                            reorderSidebar(draggedSidebarKey, m.code);
                        }

                        // Ï†ïÎ¶¨
                        draggedCode = null;
                        draggedSidebarKey = null;
                    });
                }

                // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Î©îÎ™® Í∞ïÏ°∞
                if (activeCode === m.code) {
                    el.classList.add('active');
                }

                return el;
            }

            // ----- Top‚Äëlevel items (memos & folders mixed) -----
            for (const key of sidebarOrder) {
                if (key.startsWith('F:')) {
                    const folderId = key.slice(2);
                    const f = folders.find(ff => ff.id === folderId);
                    if (!f) continue;

                    const collapsed = collapsedFolders.includes(f.id);

                    const header = document.createElement('div');
                    header.className = 'folder-header';
                    header.setAttribute('draggable', 'true');
                    const descriptionHTML = f.description
                        ? `<div class="folder-description">${f.description}</div>`
                        : '';
                    header.innerHTML = `
                    <div class="folder-header-row">
                        <span class="folder-label"><span class="folder-arrow">${collapsed ? '‚ñ∂' : '‚ñº'}</span> üìÅ ${f.name}</span>
                        <button class="folder-options-btn" title="Ìè¥Îçî ÏòµÏÖò">‚ãÆ</button>
                    </div>
                    ${descriptionHTML}
                    <div class="folder-options-menu hidden" data-folder-id="${f.id}">
                        <div class="folder-option-item invite-option">üîó Ï¥àÎåÄ</div>
                        <div class="folder-option-item edit-desc-option">‚úèÔ∏è ÏÑ§Î™Ö ÏàòÏ†ï</div>
                        <div class="folder-option-item delete-option">üóëÔ∏è ÏÇ≠Ï†ú</div>
                    </div>`;
                    // ÏÑ†ÌÉùÎêú Î©îÎ™®Í∞Ä Ìè¥Îçî ÏïàÏóê ÏûàÏùÑ Í≤ΩÏö∞ Ìè¥Îçî ÌôîÏÇ¥Ìëú ÏÉâÏÉÅ Î≥ÄÍ≤Ω
                    const arrowElem = header.querySelector('.folder-arrow');
                    if (f.codes.includes(activeCode)) {
                        arrowElem.style.color = 'var(--accent-primary)';
                    } else {
                        arrowElem.style.color = '';
                    }
                    sidebarList.appendChild(header);

                    /* ‚îÄ‚îÄ ÎìúÎûòÍ∑∏ Ìï∏Îì§Îü¨ (Ìè¥Îçî) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
                    header.addEventListener('dragstart', e => {
                        draggedFolderId = f.id;
                        draggedSidebarKey = 'F:' + f.id;
                        e.dataTransfer.setData('text/plain', f.id);
                        e.dataTransfer.effectAllowed = 'move';
                    });
                    header.addEventListener('dragend', () => {
                        draggedFolderId = null;
                        draggedSidebarKey = null;
                        header.style.background = '';
                    });
                    header.addEventListener('dragenter', e => {
                        e.preventDefault();
                        if (draggedSidebarKey && draggedSidebarKey !== 'F:' + f.id)
                            header.style.background = 'var(--surface-secondary)';
                    });
                    header.addEventListener('dragover', e => {
                        e.preventDefault();
                        if (draggedSidebarKey && draggedSidebarKey !== 'F:' + f.id)
                            header.style.background = 'var(--surface-secondary)';
                    });
                    header.addEventListener('dragleave', () => header.style.background = '');
                    header.addEventListener('drop', e => {
                        e.preventDefault();
                        header.style.background = '';
                        if (draggedCode) {                           // Î©îÎ™® ‚Üí Ìè¥Îçî Ïù¥Îèô
                            moveNoteToFolder(draggedCode, f.id);
                            draggedCode = null;
                        } else if (draggedSidebarKey && draggedSidebarKey !== 'F:' + f.id) {
                            reorderSidebar(draggedSidebarKey, 'F:' + f.id); // ÏÇ¨Ïù¥ÎìúÎ∞î Ï†ïÎ†¨
                            draggedSidebarKey = null;
                        }
                        if (draggedFolderId && draggedFolderId !== f.id) {
                            reorderFolders(draggedFolderId, f.id);          // Ìè¥Îçî Î∞∞Ïó¥ ÎèôÍ∏∞Ìôî
                            draggedFolderId = null;
                        }
                    });

                    // ‚îÄ‚îÄ Ìè¥Îçî ÏòµÏÖò Î≤ÑÌäº Î∞è Î©îÎâ¥ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    const fOptionsBtn = header.querySelector('.folder-options-btn');
                    const fOptionsMenu = header.querySelector('.folder-options-menu');

                    fOptionsBtn.addEventListener('click', ev => {
                        ev.stopPropagation();
                        document.querySelectorAll('.folder-options-menu').forEach(m => {
                            if (m !== fOptionsMenu) m.classList.add('hidden');
                        });
                        fOptionsMenu.classList.toggle('hidden');
                    });

                    fOptionsMenu.querySelector('.invite-option')
                        .addEventListener('click', ev => {
                            ev.stopPropagation();
                            fOptionsMenu.classList.add('hidden');
                            inviteFolder(f);                 // Ïã§Ï†ú Ï¥àÎåÄ Î°úÏßÅ Ïã§Ìñâ
                        });

                    fOptionsMenu.querySelector('.edit-desc-option')
                        .addEventListener('click', ev => {
                            ev.stopPropagation();
                            fOptionsMenu.classList.add('hidden');
                            const newDesc = prompt('Ìè¥Îçî ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî', f.description || '');
                            if (newDesc !== null) {
                                f.description = newDesc.trim();
                                saveFolders();
                                renderList();
                            }
                        });

                    fOptionsMenu.querySelector('.delete-option')
                        .addEventListener('click', ev => {
                            ev.stopPropagation();
                            fOptionsMenu.classList.add('hidden');
                            deleteFolder(f.id);
                        });

                    // Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞
                    const headerRow = header.querySelector('.folder-header-row');
                    headerRow.addEventListener('click', ev => {
                        // ÏòµÏÖò Î©îÎâ¥ ÌÅ¥Î¶≠ÏùÄ Î¨¥Ïãú
                        if (ev.target.closest('.folder-options-btn') ||
                            ev.target.closest('.folder-options-menu')) return;

                        // Ï†ëÌûò Î¶¨Ïä§Ìä∏ ÌÜ†Í∏Ä
                        const idxColl = collapsedFolders.indexOf(f.id);
                        if (idxColl === -1) {
                            // ÌòÑÏû¨ ÌéºÏ≥êÏßÑ ÏÉÅÌÉú ‚Üí Ï†ëÍ∏∞
                            collapsedFolders.push(f.id);
                        } else {
                            // ÌòÑÏû¨ Ï†ëÌûå ÏÉÅÌÉú ‚Üí ÌéºÏπòÍ∏∞
                            collapsedFolders.splice(idxColl, 1);
                        }

                        localStorage.setItem(collapsedFoldersKey, JSON.stringify(collapsedFolders));
                        renderList();
                    });

                    // Î©îÎ™® ÎìúÎ°≠ ‚Üí Ìè¥Îçî Ïù¥Îèô
                    header.addEventListener('dragover', e => e.preventDefault());

                    // ÎÇ¥Î∂Ä Î©îÎ™® Î†åÎçî
                    if (!collapsed) {
                        (f.codes || []).forEach(c => {
                            const m = memos.find(mm => mm.code === c);
                            if (m) {
                                const el = buildMemo(m, false);
                                el.classList.add('in-folder');
                                sidebarList.appendChild(el);
                            }
                        });
                    }
                } else {
                    const code = key;
                    const m = memos.find(mm => mm.code === code);
                    if (m) sidebarList.appendChild(buildMemo(m, true));
                }
            }
            /* ------ Î£®Ìä∏ Îπà Í≥µÍ∞Ñ ÎìúÎ°≠ Ï≤òÎ¶¨ ------ */
            sidebarList.addEventListener('dragover', e => e.preventDefault());
            sidebarList.addEventListener('drop', e => {
                // Îπà Í≥µÍ∞Ñ(= Î¶¨Ïä§Ìä∏ ÏûêÏ≤¥) ÏúÑÏóê Îñ®Ïñ¥Îú®Î†∏ÏùÑ Îïå
                if (e.target === sidebarList && draggedCode) {
                    moveNoteToFolder(draggedCode, null);

                    // ÏÇ¨Ïù¥ÎìúÎ∞î ÏàúÏÑúÏóê ÏóÜÏúºÎ©¥ Îß® ÎÅùÏóê Ï∂îÍ∞Ä
                    if (!sidebarOrder.includes(draggedCode)) {
                        sidebarOrder.push(draggedCode);
                        saveSidebarOrder();
                    }

                    draggedCode = null;
                    draggedSidebarKey = null;
                    renderList();
                }
            });
        }

        function reorderMemos(draggedCode, targetCode) {
            // Í∞ôÏùÄ Ìè¥Îçî ÏïàÏóêÏÑúÎßå Ï†ïÎ†¨
            const dFolder = folders.find(f => (f.codes || []).includes(draggedCode));
            const tFolder = folders.find(f => (f.codes || []).includes(targetCode));
            if (dFolder && tFolder && dFolder.id === tFolder.id) {
                const arr = dFolder.codes;
                const dIdx = arr.indexOf(draggedCode);
                const tIdx = arr.indexOf(targetCode);
                if (dIdx !== -1 && tIdx !== -1) {
                    const item = arr.splice(dIdx, 1)[0];
                    arr.splice(tIdx, 0, item);
                    saveFolders();
                    renderList();
                }
                return; // Ìè¥Îçî ÎÇ¥Î∂Ä Ï†ïÎ†¨ ÎÅù
            }

            const draggedIndex = noteCodeObjs.findIndex(o => o.code === draggedCode);
            const targetIndex = noteCodeObjs.findIndex(o => o.code === targetCode);

            if (draggedIndex !== -1 && targetIndex !== -1) {
                const draggedItem = noteCodeObjs.splice(draggedIndex, 1)[0];
                noteCodeObjs.splice(targetIndex, 0, draggedItem);
                localStorage.setItem(noteCodesKey, JSON.stringify(noteCodeObjs));
                codes = noteCodeObjs.map(o => o.code);
                fetchMemos();
            }
        }

        /* ---------- Ìè¥Îçî Ïû¨Ï†ïÎ†¨ ---------- */
        function reorderFolders(draggedId, targetId) {
            const dIdx = folders.findIndex(f => f.id === draggedId);
            const tIdx = folders.findIndex(f => f.id === targetId);
            if (dIdx !== -1 && tIdx !== -1) {
                const item = folders.splice(dIdx, 1)[0];
                folders.splice(tIdx, 0, item);
                saveFolders();
                renderList();
            }
        }

        function selectMemo(code) {

            const editStatusNote = document.getElementById('editStatusNote');
            const refreshMemoBtn = document.getElementById('refreshMemoBtn');
            const viewerCountNote = document.getElementById('viewerCountNote');

            if (editStatusNote) {
                editStatusNote.style.display = 'none';
                editStatusNote.textContent = '';
            }

            if (refreshMemoBtn) {
                refreshMemoBtn.style.display = 'none';
            }

            if (viewerCountNote) {
                viewerCountNote.style.display = 'none';
                viewerCountNote.textContent = '';
            }

            if (activeCode &&
                (memoTitle.value !== originalTitle ||
                    memoEditor.getMarkdown() !== originalContent)) {
                updateTitle();      // Ï†úÎ™© Ï†ÄÏû•
                updateContent();    // ÎÇ¥Ïö© Ï†ÄÏû•
            }

            activeCode = code;
            localStorage.setItem(activeCodeKey, activeCode);
            // WebSocket: join note
            sendNoteSocketEvent && sendNoteSocketEvent('JOIN_NOTE', code);
            const memo = memos.find(m => m.code === code);
            if (memo) {
                memoDetail.classList.remove('hidden');
                noMemoElem.classList.add('hidden');
                memoTitle.value = memo.title || '';
                memoEditor.setMarkdown(memo.content || '');
                createDateElem.textContent = new Date(memo.createDate).toLocaleString();
                updateDateElem.textContent = new Date(memo.updateDate).toLocaleString();

                originalTitle = memoTitle.value || '';
                originalContent = memoEditor.getMarkdown() || '';
                renderList();
            }
            // Reset editStarted flag
            editStarted = false;
        }

        // Ï†úÎ™©Îßå Ï†ÄÏû•
        function updateTitle() {
            if (!activeCode) return;
            const codeToSave = activeCode;
            const title = memoTitle.value.trim();

            fetch(`/note/${codeToSave}/title`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({title})
            })
                .then(res => res.json())
                .then(data => {
                    const memo = memos.find(m => m.code === codeToSave);
                    if (memo) {
                        memo.title = title;
                        const parsed = toDate(data.updateDate ?? Date.now());
                        memo.updateDate = parsed.getTime();
                        if (activeCode === codeToSave) {
                            updateDateElem.textContent = parsed.toLocaleString();
                        }
                        renderList();
                    }
                    showNotification('Ï†úÎ™©Ïù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§', 'success');
                    // WebSocket: notify save
                    sendNoteSocketEvent && sendNoteSocketEvent('SAVE_NOTE', activeCode);
                })
                .catch((e) => showNotification('Ï†úÎ™© Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§', 'error'));

            if (activeCode === codeToSave) originalTitle = memoTitle.value;
        }

        // ÎÇ¥Ïö©Îßå Ï†ÄÏû•
        function updateContent() {
            if (!activeCode) return;
            const codeToSave = activeCode;
            const content = memoEditor.getMarkdown();

            fetch(`/note/${codeToSave}/content`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({content})
            })
                .then(res => res.json())
                .then(data => {
                    const memo = memos.find(m => m.code === codeToSave);
                    if (memo) {
                        memo.content = content;
                        const parsed = toDate(data.updateDate ?? Date.now());
                        memo.updateDate = parsed.getTime();
                        if (activeCode === codeToSave) {
                            updateDateElem.textContent = parsed.toLocaleString();
                        }
                        renderList();
                    }
                    showNotification('ÎÇ¥Ïö©Ïù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§', 'success');
                    // WebSocket: notify save
                    sendNoteSocketEvent && sendNoteSocketEvent('SAVE_NOTE', activeCode);
                })
                .catch(() => showNotification('ÎÇ¥Ïö© Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§', 'error'));

            if (activeCode === codeToSave) originalContent = memoEditor.getMarkdown();
        }

        // ---- Edit State Detector ----
        function updateEditState() {
            const title = memoTitle.value.trim();
            const content = memoEditor.getMarkdown();
            if (!editStarted && (title !== originalTitle || content !== originalContent)) {
                sendNoteSocketEvent && sendNoteSocketEvent('EDIT_NOTE', activeCode);
                editStarted = true;
            } else if (editStarted && title === originalTitle && content === originalContent) {
                sendNoteSocketEvent && sendNoteSocketEvent('EDIT_CANCEL_NOTE', activeCode);
                editStarted = false;
            }
        }

        memoTitle.addEventListener('input', updateEditState);
        // Polling method to detect edits in title/content
        setInterval(() => {
            if (!memoEditor || !activeCode) return;

            const currentContent = memoEditor.getMarkdown();
            const currentTitle = memoTitle.value.trim();

            const changed = currentTitle !== originalTitle || currentContent !== originalContent;

            if (!editStarted && changed) {
                sendNoteSocketEvent && sendNoteSocketEvent('EDIT_NOTE', activeCode);
                editStarted = true;
            } else if (editStarted && !changed) {
                sendNoteSocketEvent && sendNoteSocketEvent('EDIT_CANCEL_NOTE', activeCode);
                editStarted = false;
            }
        }, 500);

        function generateCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let out = '';
            for (let i = 0; i < 8; i++) {
                out += chars[Math.floor(Math.random() * chars.length)];
            }
            return out;
        }

        addBtn.addEventListener('click', () => {
            let code = codeInput.value.trim().toUpperCase()
                .replace(/[^A-Z0-9]/g, '')
                .substring(0, 8);

            // If no code entered, generate one until it is unique
            if (!code) {
                do {
                    code = generateCode();
                } while (codes.includes(code));
            } else if (codes.includes(code)) {
                showNotification('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî ÏΩîÎìúÏûÖÎãàÎã§', 'error');
                return;
            }

            fetch(`/note/${code}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({clientId: clientId})
            })
                .then(res => res.json())
                .then(() => {
                    const copyBtn = $('#copyCodeBtn');
                    const originalText = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<span>‚úì</span>';
                    copyBtn.style.color = 'var(--success)';

                    setTimeout(() => {
                        copyBtn.innerHTML = originalText;
                        copyBtn.style.color = '';
                    }, 2000);

                    noteCodeObjs.unshift({code}); // ÏÉà Î©îÎ™®Î•º Î™©Î°ù Îß® ÏïûÏóê Î∞∞Ïπò
                    localStorage.setItem(noteCodesKey, JSON.stringify(noteCodeObjs));
                    codes = noteCodeObjs.map(o => o.code);
                    activeCode = code;
                    localStorage.setItem(activeCodeKey, activeCode);
                    if (activeFolderId) {
                        const folderObj = folders.find(f => f.id === activeFolderId);
                        if (folderObj && !folderObj.codes.includes(code)) {
                            folderObj.codes.push(code);
                            saveFolders();
                        }
                    }
                    codeInput.value = '';
                    fetchMemos();
                    showNotification('Î©îÎ™®Í∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§', 'success');
                })
                .catch(() => {
                    showNotification('Î©îÎ™® Ï∂îÍ∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§', 'error');
                });

            originalTitle = '';
            originalContent = '';
        });

        // Share functionality
        const shareBtn = $('#shareBtn');
        const shareModal = $('#shareModal');
        const shareClose = $('#shareClose');

        shareBtn.addEventListener('click', () => {
            shareModal.classList.add('show');
            // Ï¥àÍ∏∞ ÏÉÅÌÉúÎ°ú ÏÑ§Ï†ï
            $('#shareStageSelect').classList.remove('hidden');
            $('#shareStageReceive').classList.add('hidden');
            $('#shareStageCreate').classList.add('hidden');
            $('#shareResultWrap').classList.add('hidden');
        });

        shareClose.addEventListener('click', () => {
            shareModal.classList.remove('show');
        });

        shareModal.addEventListener('click', (e) => {
            if (e.target === shareModal) {
                shareModal.classList.remove('show');
            }
        });

        // Í≥µÏú†Î∞õÍ∏∞ Î≤ÑÌäº ÌÅ¥Î¶≠
        $('#receiveBtn').addEventListener('click', () => {
            $('#shareStageSelect').classList.add('hidden');
            $('#shareStageReceive').classList.remove('hidden');
            $('#shareCodeInput').value = '';
            $('#shareCodeInput').focus();
        });

        // Í≥µÏú†ÌïòÍ∏∞ Î≤ÑÌäº ÌÅ¥Î¶≠
        $('#createBtn').addEventListener('click', () => {
            $('#shareStageSelect').classList.add('hidden');
            $('#shareStageCreate').classList.remove('hidden');
            $('#linkInputWrap').classList.add('hidden');
            $('#fileInputWrap').classList.add('hidden');
            $('#shareSubmitBtn').disabled = true;
        });

        // ÎßÅÌÅ¨ Î™®Îìú Î≤ÑÌäº ÌÅ¥Î¶≠
        $('#modeLinkBtn').addEventListener('click', () => {
            $('#modeLinkBtn').classList.add('btn-primary');
            $('#modeLinkBtn').classList.remove('btn-secondary');
            $('#modeFileBtn').classList.add('btn-secondary');
            $('#modeFileBtn').classList.remove('btn-primary');
            $('#linkInputWrap').classList.remove('hidden');
            $('#fileInputWrap').classList.add('hidden');
            $('#shareSubmitBtn').disabled = !$('#linkInput').value.trim();
        });

        // ÌååÏùº Î™®Îìú Î≤ÑÌäº ÌÅ¥Î¶≠
        $('#modeFileBtn').addEventListener('click', () => {
            $('#modeFileBtn').classList.add('btn-primary');
            $('#modeFileBtn').classList.remove('btn-secondary');
            $('#modeLinkBtn').classList.add('btn-secondary');
            $('#modeLinkBtn').classList.remove('btn-primary');
            $('#fileInputWrap').classList.remove('hidden');
            $('#linkInputWrap').classList.add('hidden');
            $('#shareSubmitBtn').disabled = !$('#fileInput').files.length;
        });

        // ÌååÏùº ÏÑ†ÌÉù ÏòÅÏó≠ ÌÅ¥Î¶≠ Ï≤òÎ¶¨
        const fileDropArea = $('#fileDropText').parentElement;
        fileDropArea.addEventListener('click', () => {
            $('#fileInput').click();
        });

        // ÌååÏùº ÎìúÎûòÍ∑∏ & ÎìúÎ°≠ Ï≤òÎ¶¨
        fileDropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileDropArea.style.borderColor = 'var(--accent-primary)';
        });

        fileDropArea.addEventListener('dragleave', () => {
            fileDropArea.style.borderColor = 'var(--border-primary)';
        });

        fileDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDropArea.style.borderColor = 'var(--border-primary)';
            if (e.dataTransfer.files.length) {
                $('#fileInput').files = e.dataTransfer.files;
                $('#fileDropText').textContent = `ÏÑ†ÌÉùÎêú ÌååÏùº: ${e.dataTransfer.files[0].name}`;
                $('#shareSubmitBtn').disabled = false;
            }
        });

        // ÌååÏùº ÏÑ†ÌÉù Ï≤òÎ¶¨
        $('#fileInput').addEventListener('change', (e) => {
            if (e.target.files.length) {
                $('#fileDropText').textContent = `ÏÑ†ÌÉùÎêú ÌååÏùº: ${e.target.files[0].name}`;
                $('#shareSubmitBtn').disabled = false;
            } else {
                $('#fileDropText').textContent = 'ÌååÏùºÏùÑ ÎìúÎûòÍ∑∏ÌïòÍ±∞ÎÇò ÌÅ¥Î¶≠ÌïòÏó¨ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî';
                $('#shareSubmitBtn').disabled = true;
            }
        });

        // ÎßÅÌÅ¨ ÏûÖÎ†• Ï≤òÎ¶¨
        $('#linkInput').addEventListener('input', (e) => {
            $('#shareSubmitBtn').disabled = !e.target.value.trim();
        });

        // Í≥µÏú†ÏΩîÎìúÎ°ú ÌéòÏù¥ÏßÄ Ï†ëÍ∑º Ï≤òÎ¶¨
        $('#shareCodeInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                $('#shareCodeConfirmBtn').click();
            }
        });

        // Í≥µÏú†ÏΩîÎìú ÌôïÏù∏ Î≤ÑÌäº ÌÅ¥Î¶≠
        $('#shareCodeConfirmBtn').addEventListener('click', () => {
            const code = $('#shareCodeInput').value.trim();
            if (!code) {
                showNotification('Í≥µÏú† ÏΩîÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                return;
            }

            // ÎßÅÌÅ¨ Ï≤òÎ¶¨Î•º ÏúÑÌï¥ ÏÑúÎ≤ÑÎ°ú ÏöîÏ≤≠
            window.location.href = `/page/share/${code}`;
        });

        // Í≥µÏú†ÌïòÍ∏∞ Î≤ÑÌäº ÌÅ¥Î¶≠
        $('#shareSubmitBtn').addEventListener('click', () => {
            const remainingCnt = parseInt($('#remainingInput').value) || 1;
            if (remainingCnt < 1 || remainingCnt > 99) {
                showNotification('Í≥µÏú† Í∞ÄÎä• ÌöüÏàòÎäî 1~99 ÏÇ¨Ïù¥ Í∞íÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§', 'error');
                return;
            }

            // ÎßÅÌÅ¨ Î™®ÎìúÏù∏ Í≤ΩÏö∞
            if ($('#linkInputWrap').classList.contains('hidden') === false) {
                const link = $('#linkInput').value.trim();
                if (!link) {
                    showNotification('ÎßÅÌÅ¨Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                    return;
                }

                fetch('/share/link', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({link, remainingCnt})
                })
                    .then(res => res.json())
                    .then(data => displayShareResult(data))
                    .catch(() => showNotification('Í≥µÏú† ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§', 'error'));
            }
            // ÌååÏùº Î™®ÎìúÏù∏ Í≤ΩÏö∞
            else {
                const fileInput = $('#fileInput');
                if (!fileInput.files.length) {
                    showNotification('ÌååÏùºÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî', 'error');
                    return;
                }

                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('remainingCnt', remainingCnt);

                fetch('/share/file', {
                    method: 'POST',
                    body: formData
                })
                    .then(res => res.json())
                    .then(data => displayShareResult(data))
                    .catch(() => showNotification('Í≥µÏú† ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§', 'error'));
            }
        });

        // Í≥µÏú† Í≤∞Í≥º ÌëúÏãú Ìï®Ïàò
        function displayShareResult(data) {
            $('#shareResultWrap').classList.remove('hidden');
            $('#shareResultCode').value = data.code;
            $('#shareCreateDate').textContent = new Date(data.createDate).toLocaleString();
            $('#shareExpireDate').textContent = new Date(data.expireDate).toLocaleString();
            $('#shareRemainingCnt').textContent = data.remainingCnt;

            // Î≥µÏÇ¨ Î≤ÑÌäº ÏÑ§Ï†ï
            $('#copyCodeBtn').addEventListener('click', () => {
                const codeInput = $('#shareResultCode');
                codeInput.select();
                document.execCommand('copy');
                showNotification('ÏΩîÎìúÍ∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§', 'success');
            });
        }

        fetchMemos();
        renderList();

        // ===== WebSocket for Note Realtime =====
        // WebSocket Setup
        const ws = new WebSocket('ws://localhost:8080/socket/note/connect');

        ws.addEventListener('open', () => {
            console.log('WebSocket Ïó∞Í≤∞Îê®');
        });

        ws.addEventListener('message', (event) => {
            const msg = JSON.parse(event.data);
            if (!msg.eventName) return;

            switch (msg.eventName) {
                case 'USER_CNT_NOTE':
                    const viewerNoteElem = document.getElementById('viewerCountNote');
                    if (viewerNoteElem) {
                        if (msg.userCnt >= 2) {
                            viewerNoteElem.textContent = `${msg.userCnt}Î™ÖÏù¥ Î≥¥Í≥†ÏûàÏäµÎãàÎã§`;
                            viewerNoteElem.style.display = 'block';
                        } else {
                            viewerNoteElem.style.display = 'none';
                        }
                    }
                    break;
                case 'EDIT_NOTE':
                    const editStateElem = document.getElementById('editStatusNote');
                    if (editStateElem) {
                        editStateElem.textContent = 'Îã§Î•∏ ÏÇ¨Ïö©ÏûêÍ∞Ä Î©îÎ™®Î•º ÏàòÏ†ïÏ§ëÏûÖÎãàÎã§';
                        editStateElem.style.display = 'block';
                    }
                    break;
                case 'EDIT_CANCEL_NOTE':
                    const cancelStateElem = document.getElementById('editStatusNote');
                    if (cancelStateElem) {
                        cancelStateElem.style.display = 'none';
                    }
                    break;
                case 'SAVE_NOTE':
                    const saveStateElem = document.getElementById('editStatusNote');
                    if (saveStateElem) {
                        saveStateElem.textContent = 'Îã§Î•∏ ÏÇ¨Ïö©ÏûêÍ∞Ä Î©îÎ™®Î•º ÏàòÏ†ïÌïòÏòÄÏäµÎãàÎã§';
                        saveStateElem.style.display = 'inline-block';
                    }
                    const refreshBtn = document.getElementById('refreshMemoBtn');
                    if (refreshBtn) {
                        refreshBtn.style.display = 'inline-block';
                    }
                    break;
            }
        });

        function sendNoteSocketEvent(eventName, code) {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({eventName, code}));
            }
        }

        // Edit flag for note
        let editStarted = false;

        // Ï∑®ÏÜå Î≤ÑÌäº UI handler
        const refreshBtn = document.getElementById('refreshMemoBtn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
                // ÏÉàÎ°úÍ≥†Ïπ® (reload memo content)
                if (activeCode) {
                    fetchMemos();
                }
                refreshBtn.style.display = 'none';
                const editStateElem = document.getElementById('editStatusNote');
                if (editStateElem) editStateElem.style.display = 'none';
            });
        }
    });
</script>
</body>
</html>
</script>
</body>
</html>