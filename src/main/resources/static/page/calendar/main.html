<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
    <meta name="color-scheme" content="light dark"/>
    <meta name="supported-color-schemes" content="light dark"/>
    <title>Ïò®ÎùºÏù∏ Ï∫òÎ¶∞Îçî</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        /* ---------- Design Tokens ---------- */
        :root {
            /* Light Theme */
            --bg-primary: #FAFBFC;
            --bg-secondary: #F8F9FA;
            --surface-primary: #FFFFFF;
            --surface-secondary: #F1F3F4;
            --surface-elevated: #FFFFFF;
            --surface-overlay: rgba(255, 255, 255, 0.95);

            --text-primary: #1A1A1A;
            --text-secondary: #6B7280;
            --text-tertiary: #9CA3AF;
            --text-accent: #4338CA;

            --accent-primary: #6366F1;
            --accent-secondary: #818CF8;
            --accent-hover: #4F46E5;
            --accent-pressed: #4338CA;

            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;

            --border-primary: rgba(0, 0, 0, 0.08);
            --border-secondary: rgba(0, 0, 0, 0.05);
            --border-focus: var(--accent-primary);

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-full: 9999px;

            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --spacing-xl: 24px;
            --spacing-2xl: 32px;

            --font-xs: 0.75rem;
            --font-sm: 0.875rem;
            --font-base: 1rem;
            --font-lg: 1.125rem;
            --font-xl: 1.25rem;
            --font-2xl: 1.5rem;

            --line-height-tight: 1.25;
            --line-height-normal: 1.5;
            --line-height-relaxed: 1.625;

            --backdrop-blur: blur(20px);
            --transition-fast: 0.15s ease;
            --transition-normal: 0.2s ease;
            --transition-slow: 0.3s ease;
        }

        /* Dark Theme */
        body.dark-mode {
            --bg-primary: #0A0A0A;
            --bg-secondary: #111111;
            --surface-primary: #1A1A1A;
            --surface-secondary: #2A2A2A;
            --surface-elevated: #262626;
            --surface-overlay: rgba(26, 26, 26, 0.95);

            --text-primary: #FAFAFA;
            --text-secondary: #A1A1AA;
            --text-tertiary: #71717A;
            --text-accent: #A78BFA;

            --accent-primary: #8B5CF6;
            --accent-secondary: #A78BFA;
            --accent-hover: #7C3AED;
            --accent-pressed: #6D28D9;

            --success: #34D399;
            --warning: #FBBF24;
            --error: #F87171;

            --border-primary: rgba(255, 255, 255, 0.1);
            --border-secondary: rgba(255, 255, 255, 0.05);
        }

        /* ---------- Base Styles ---------- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: var(--font-base);
            line-height: var(--line-height-normal);
            transition: background-color var(--transition-normal), color var(--transition-normal);
            overflow-x: hidden;
        }

        /* ---------- Layout ---------- */
        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--surface-elevated);
            border-bottom: 1px solid var(--border-primary);
            backdrop-filter: var(--backdrop-blur);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .topbar-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            min-width: 300px;
            background: var(--surface-primary);
            border-right: 1px solid var(--border-primary);
            display: flex;
            flex-direction: column;
            transition: transform var(--transition-normal);
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: margin-left var(--transition-normal);
        }

        /* ---------- Navigation ---------- */
        .nav-dropdown {
            position: relative;
        }

        .nav-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--surface-elevated);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            min-width: 150px;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all var(--transition-fast);
        }

        .nav-dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .nav-dropdown-item {
            display: block;
            padding: var(--spacing-sm) var(--spacing-md);
            color: var(--text-primary);
            text-decoration: none;
            border-radius: var(--radius-sm);
            margin: var(--spacing-xs);
            transition: background-color var(--transition-fast);
        }

        .nav-dropdown-item:hover {
            background: var(--surface-secondary);
        }

        /* ---------- Buttons ---------- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-sm);
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all var(--transition-fast);
            user-select: none;
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--surface-secondary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--surface-elevated);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
        }

        .btn-ghost:hover {
            background: var(--surface-secondary);
            color: var(--text-primary);
        }

        .btn-icon {
            padding: var(--spacing-sm);
            min-width: auto;
        }

        .btn-sm {
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: var(--font-xs);
        }

        /* ---------- Logo ---------- */
        .logo {
            font-size: var(--font-lg);
            font-weight: 600;
            color: var(--text-primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            cursor: pointer;
        }

        .logo::before {
            content: 'üìÖ';
            font-size: var(--font-xl);
        }

        /* ---------- Sidebar ---------- */
        .sidebar-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-primary);
        }

        .sidebar-title {
            font-size: var(--font-lg);
            font-weight: 600;
            margin-bottom: var(--spacing-md);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-lg);
        }

        .sidebar-footer {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border-primary);
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        /* ---------- Calendar Categories ---------- */
        .category-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .category-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--surface-secondary);
            border-radius: var(--radius-md);
            transition: background-color var(--transition-fast);
        }

        .category-item:hover {
            background: var(--surface-elevated);
        }

        .category-item.active {
            background: var(--accent-primary);
            color: white;
        }

        .category-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            flex: 1;
        }

        .category-color {
            width: 12px;
            height: 12px;
            border-radius: var(--radius-full);
            flex-shrink: 0;
        }

        .category-name {
            font-size: var(--font-sm);
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .category-description {
            font-size: var(--font-xs);
            color: var(--text-tertiary);
            margin-top: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .category-actions {
            display: flex;
            gap: var(--spacing-xs);
            opacity: 0;
            transition: opacity var(--transition-fast);
        }

        .category-item:hover .category-actions {
            opacity: 1;
        }

        .category-action {
            padding: var(--spacing-xs);
            border: none;
            background: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: var(--radius-sm);
            font-size: var(--font-xs);
            transition: all var(--transition-fast);
        }

        .category-action:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .category-more-menu {
            position: relative;
        }

        .category-more-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--surface-elevated);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            min-width: 120px;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all var(--transition-fast);
        }

        .category-more-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .category-more-item {
            display: block;
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            background: none;
            border: none;
            color: var(--text-primary);
            text-align: left;
            cursor: pointer;
            font-size: var(--font-xs);
            border-radius: var(--radius-sm);
            margin: var(--spacing-xs);
            transition: background-color var(--transition-fast);
        }

        .category-more-item:hover {
            background: var(--surface-secondary);
        }

        /* ---------- Calendar View ---------- */
        .calendar-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-lg);
            background: var(--surface-primary);
            border-bottom: 1px solid var(--border-primary);
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .calendar-title {
            font-size: var(--font-2xl);
            font-weight: 600;
            margin: 0 var(--spacing-lg);
        }

        .calendar-view {
            flex: 1;
            padding: var(--spacing-lg);
            overflow: auto;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border-primary);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .calendar-header-cell {
            background: var(--surface-secondary);
            padding: var(--spacing-md);
            text-align: center;
            font-size: var(--font-sm);
            font-weight: 600;
            color: var(--text-secondary);
        }

        .calendar-cell {
            background: var(--surface-primary);
            min-height: 120px;
            padding: var(--spacing-sm);
            position: relative;
            cursor: pointer;
            transition: background-color var(--transition-fast);
        }

        .calendar-cell:hover {
            background: var(--surface-secondary);
        }

        .calendar-cell.other-month {
            background: var(--surface-secondary);
            color: var(--text-tertiary);
        }

        .calendar-cell.today {
            background: var(--accent-primary);
            color: white;
        }

        .calendar-day {
            font-size: var(--font-sm);
            font-weight: 500;
            margin-bottom: var(--spacing-xs);
        }

        .calendar-events {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .calendar-event {
            background: var(--accent-secondary);
            color: white;
            padding: 2px var(--spacing-xs);
            border-radius: var(--radius-sm);
            font-size: var(--font-xs);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
            transition: all var(--transition-fast);
            transform: scale(1);
        }

        .calendar-event:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-md);
            z-index: 10;
            position: relative;
        }

        .calendar-event-continuous {
            position: absolute;
            top: calc(var(--spacing-sm) + 20px);
            height: 16px;
            z-index: 5;
            border-radius: 0;
            margin: 1px 0;
        }

        .calendar-event-continuous.start {
            border-top-left-radius: var(--radius-sm);
            border-bottom-left-radius: var(--radius-sm);
        }

        .calendar-event-continuous.end {
            border-top-right-radius: var(--radius-sm);
            border-bottom-right-radius: var(--radius-sm);
        }
        
        .calendar-event-continuous.single {
            border-radius: var(--radius-sm);
        }

        /* ---------- Modal ---------- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--surface-elevated);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform var(--transition-normal);
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-primary);
        }

        .modal-title {
            font-size: var(--font-lg);
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: var(--font-lg);
            cursor: pointer;
            padding: var(--spacing-xs);
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
        }

        .modal-close:hover {
            background: var(--surface-secondary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: var(--spacing-lg);
        }

        /* ---------- Form Elements ---------- */
        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-label {
            display: block;
            font-size: var(--font-sm);
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            background: var(--surface-primary);
            color: var(--text-primary);
            font-size: var(--font-sm);
            transition: all var(--transition-fast);
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-checkbox {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            cursor: pointer;
            font-size: var(--font-sm);
            color: var(--text-primary);
        }

        .form-checkbox input[type="checkbox"] {
            display: none;
        }

        .checkmark {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .form-checkbox input[type="checkbox"]:checked + .checkmark {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .form-checkbox input[type="checkbox"]:checked + .checkmark::after {
            content: '‚úì';
            color: white;
            font-size: var(--font-xs);
            font-weight: bold;
        }

        /* ---------- Color Picker ---------- */
        .color-picker {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .color-input {
            width: 40px;
            height: 40px;
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            cursor: pointer;
            padding: 0;
        }

        .color-presets {
            display: flex;
            gap: var(--spacing-xs);
            flex-wrap: wrap;
        }

        .color-preset {
            width: 24px;
            height: 24px;
            border: 2px solid transparent;
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .color-preset:hover {
            transform: scale(1.1);
            border-color: var(--text-secondary);
        }

        .color-preset.active {
            border-color: var(--text-primary);
            transform: scale(1.1);
        }

        /* ---------- Date Picker ---------- */
        .date-picker-container {
            min-width: 300px;
        }

        .month-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-sm);
        }

        .month-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            background: var(--surface-primary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: var(--font-sm);
        }

        .month-btn:hover {
            background: var(--surface-secondary);
        }

        .month-btn.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        /* ---------- Utilities ---------- */
        .hidden {
            display: none !important;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* ---------- Responsive ---------- */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 73px; /* topbar height */
                left: 0;
                height: calc(100vh - 73px);
                z-index: 150;
                transform: translateX(-100%);
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .calendar-title {
                font-size: var(--font-xl);
                margin: 0 var(--spacing-sm);
            }

            .calendar-cell {
                min-height: 80px;
            }
        }

        @media (min-width: 769px) {
            .sidebar.collapsed {
                transform: translateX(-100%);
            }
            
            .main-content.sidebar-collapsed .content {
                margin-left: -300px;
            }
        }

        /* ---------- Animations ---------- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Top Bar -->
        <div class="topbar">
            <div class="topbar-left">
                <button id="toggleSidebar" class="btn btn-ghost btn-icon">
                    <span>‚ò∞</span>
                </button>
                <div class="nav-dropdown">
                    <div class="logo" id="navToggle">Ïò®ÎùºÏù∏ Ï∫òÎ¶∞Îçî</div>
                    <div class="nav-dropdown-menu" id="navMenu">
                        <a href="/" class="nav-dropdown-item">üìù Î©îÎ™®Ïû•</a>
                        <a href="/page/calendar" class="nav-dropdown-item">üìÖ Ï∫òÎ¶∞Îçî</a>
                    </div>
                </div>
            </div>
            <div class="topbar-right">
                <button id="themeToggle" class="btn btn-ghost btn-icon" title="ÌÖåÎßà Î≥ÄÍ≤Ω">
                    <span id="themeIcon">üåô</span>
                </button>
            </div>
        </div>

        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <h2 class="sidebar-title">ÎÇ¥ Ï∫òÎ¶∞Îçî</h2>
                    <div style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                        <input id="calendarCodeInput" class="form-input" type="text" placeholder="ÏÉà Ï∫òÎ¶∞Îçî ÏΩîÎìú ÏûÖÎ†•..." maxlength="8" style="flex: 1; font-size: var(--font-xs);"/>
                        <button id="addCalendarCodeBtn" class="btn btn-primary btn-sm">
                            <span>Ï∂îÍ∞Ä</span>
                        </button>
                    </div>
                    <button id="addCategoryBtn" class="btn btn-primary btn-sm">
                        <span>+</span>
                        <span>Ïπ¥ÌÖåÍ≥†Î¶¨ Ï∂îÍ∞Ä</span>
                    </button>
                </div>

                <div class="sidebar-content">
                    <div class="category-list" id="categoryList">
                        <!-- Categories will be populated here -->
                    </div>
                </div>

                <div class="sidebar-footer">
                    <!-- Í≥µÏú† Í∏∞Îä•ÏùÄ Î≥ÑÎèÑÎ°ú Íµ¨ÌòÑ ÏòàÏ†ï -->
                </div>
            </div>

            <!-- Content Area -->
            <div class="content">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <div class="calendar-nav">
                            <button id="prevMonth" class="btn btn-ghost btn-icon">
                                <span>‚Äπ</span>
                            </button>
                            <h1 class="calendar-title" id="calendarTitle" style="cursor: pointer;">2024ÎÖÑ 1Ïõî</h1>
                            <button id="nextMonth" class="btn btn-ghost btn-icon">
                                <span>‚Ä∫</span>
                            </button>
                        </div>
                        <button id="todayBtn" class="btn btn-secondary">Ïò§Îäò</button>
                    </div>

                    <div class="calendar-view">
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- Calendar header -->
                            <div class="calendar-header-cell">Ïùº</div>
                            <div class="calendar-header-cell">Ïõî</div>
                            <div class="calendar-header-cell">Ìôî</div>
                            <div class="calendar-header-cell">Ïàò</div>
                            <div class="calendar-header-cell">Î™©</div>
                            <div class="calendar-header-cell">Í∏à</div>
                            <div class="calendar-header-cell">ÌÜ†</div>
                            
                            <!-- Calendar cells will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="categoryModalTitle">Ïπ¥ÌÖåÍ≥†Î¶¨ Ï∂îÍ∞Ä</h3>
                <button id="categoryClose" class="modal-close">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Ï†úÎ™©</label>
                    <input id="categoryTitleInput" class="form-input" type="text" placeholder="Ïπ¥ÌÖåÍ≥†Î¶¨ Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"/>
                </div>
                <div class="form-group">
                    <label class="form-label">ÏÑ§Î™Ö (ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
                    <textarea id="categoryDescInput" class="form-textarea" placeholder="Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">ÏÉâÏÉÅ</label>
                    <div class="color-picker">
                        <input id="categoryColorInput" type="color" value="#6366F1" class="color-input"/>
                        <div class="color-presets">
                            <button type="button" class="color-preset" data-color="#6366F1" style="background: #6366F1;"></button>
                            <button type="button" class="color-preset" data-color="#10B981" style="background: #10B981;"></button>
                            <button type="button" class="color-preset" data-color="#F59E0B" style="background: #F59E0B;"></button>
                            <button type="button" class="color-preset" data-color="#EF4444" style="background: #EF4444;"></button>
                            <button type="button" class="color-preset" data-color="#8B5CF6" style="background: #8B5CF6;"></button>
                            <button type="button" class="color-preset" data-color="#EC4899" style="background: #EC4899;"></button>
                            <button type="button" class="color-preset" data-color="#06B6D4" style="background: #06B6D4;"></button>
                            <button type="button" class="color-preset" data-color="#84CC16" style="background: #84CC16;"></button>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <button id="categorySubmitBtn" class="btn btn-primary">Ï∂îÍ∞Ä</button>
                    <button id="categoryCancelBtn" class="btn btn-secondary">Ï∑®ÏÜå</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Event Modal -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="eventModalTitle">ÏùºÏ†ï Ï∂îÍ∞Ä</h3>
                <button id="eventClose" class="modal-close">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Ï†úÎ™©</label>
                    <input id="eventTitleInput" class="form-input" type="text" placeholder="ÏùºÏ†ï Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"/>
                </div>
                <div class="form-group">
                    <label class="form-checkbox">
                        <input id="eventAllDayCheckbox" type="checkbox"/>
                        <span class="checkmark"></span>
                        ÌïòÎ£®Ï¢ÖÏùº
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-label">ÏãúÏûë ÎÇ†Ïßú</label>
                    <input id="eventStartDateInput" class="form-input" type="datetime-local"/>
                    <input id="eventStartDateOnly" class="form-input hidden" type="date"/>
                </div>
                <div class="form-group">
                    <label class="form-label">Ï¢ÖÎ£å ÎÇ†Ïßú</label>
                    <input id="eventEndDateInput" class="form-input" type="datetime-local"/>
                    <input id="eventEndDateOnly" class="form-input hidden" type="date"/>
                </div>
                <div class="form-group">
                    <label class="form-label">ÏÑ§Î™Ö (ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
                    <textarea id="eventDescInput" class="form-textarea" placeholder="ÏùºÏ†ï ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Ï∫òÎ¶∞Îçî</label>
                    <select id="eventCalendarSelect" class="form-select">
                        <!-- Options will be populated -->
                    </select>
                </div>
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; gap: var(--spacing-sm);">
                        <button id="eventSubmitBtn" class="btn btn-primary">Ï†ÄÏû•</button>
                        <button id="eventCancelBtn" class="btn btn-secondary">Ï∑®ÏÜå</button>
                    </div>
                    <button id="eventDeleteBtn" class="btn" style="background: var(--error); color: white; display: none;">ÏÇ≠Ï†ú</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Date Picker Modal -->
    <div id="datePickerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ÎÖÑÎèÑ/Ïõî ÏÑ†ÌÉù</h3>
                <button id="datePickerClose" class="modal-close">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="date-picker-container">
                    <div class="form-group">
                        <label class="form-label">ÎÖÑÎèÑ</label>
                        <select id="yearSelect" class="form-select" style="max-height: 200px; overflow-y: auto;">
                            <!-- Years will be populated -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ïõî</label>
                        <div class="month-grid">
                            <button type="button" class="month-btn" data-month="0">1Ïõî</button>
                            <button type="button" class="month-btn" data-month="1">2Ïõî</button>
                            <button type="button" class="month-btn" data-month="2">3Ïõî</button>
                            <button type="button" class="month-btn" data-month="3">4Ïõî</button>
                            <button type="button" class="month-btn" data-month="4">5Ïõî</button>
                            <button type="button" class="month-btn" data-month="5">6Ïõî</button>
                            <button type="button" class="month-btn" data-month="6">7Ïõî</button>
                            <button type="button" class="month-btn" data-month="7">8Ïõî</button>
                            <button type="button" class="month-btn" data-month="8">9Ïõî</button>
                            <button type="button" class="month-btn" data-month="9">10Ïõî</button>
                            <button type="button" class="month-btn" data-month="10">11Ïõî</button>
                            <button type="button" class="month-btn" data-month="11">12Ïõî</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <button id="datePickerConfirm" class="btn btn-primary">ÌôïÏù∏</button>
                        <button id="datePickerCancel" class="btn btn-secondary">Ï∑®ÏÜå</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        const baseUrl = '';
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);
        
        let currentDate = new Date();
        let calendars = [];
        let dateRecords = [];
        let cachedMonths = new Set();
        let selectedCalendars = new Set();
        let editingEvent = null;
        let selectedYear = currentDate.getFullYear();
        let selectedMonth = currentDate.getMonth();
        let draggedEvent = null;
        let dragStartDate = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeTheme();
            loadCalendarsFromStorage();
            setupEventListeners();
            renderCalendar();
            loadCalendarData();
        });

        // Theme management
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const isDark = savedTheme === 'dark-mode' || (!savedTheme && prefersDark);
            
            document.body.classList.toggle('dark-mode', isDark);
            $('#themeIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark-mode' : 'light-mode');
            $('#themeIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        // Local storage management
        function loadCalendarsFromStorage() {
            const storedCodes = localStorage.getItem('calendarCodes');
            if (storedCodes) {
                selectedCalendars = new Set(JSON.parse(storedCodes));
            }
        }

        function saveCalendarsToStorage() {
            localStorage.setItem('calendarCodes', JSON.stringify([...selectedCalendars]));
        }

        function getCalendarColor(code) {
            const colorData = JSON.parse(localStorage.getItem('calendarColors') || '{}');
            return colorData[code] || '#6366F1';
        }

        function setCalendarColor(code, color) {
            const colorData = JSON.parse(localStorage.getItem('calendarColors') || '{}');
            colorData[code] = color;
            localStorage.setItem('calendarColors', JSON.stringify(colorData));
        }

        // API calls
        async function loadCalendarData() {
            if (selectedCalendars.size === 0) return;

            try {
                // Load calendar information
                const calendarResponse = await fetch(`/calendar/list?codes=${[...selectedCalendars].join(',')}`);
                calendars = await calendarResponse.json();
                
                // Ï∫òÎ¶∞Îçî visibility ÏÉÅÌÉú Î°úÎìú
                const visibilityData = JSON.parse(localStorage.getItem('calendarVisibility') || '{}');
                calendars.forEach(calendar => {
                    calendar.visible = visibilityData[calendar.code] !== false; // Í∏∞Î≥∏Í∞íÏùÄ true
                });
                
                // Load date records for current month +- 1
                const startMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
                const endMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 2, 0);
                
                await loadDateRecords(formatYearMonth(startMonth), formatYearMonth(endMonth));
                
                renderCategories();
                renderCalendar();
            } catch (error) {
                console.error('Failed to load calendar data:', error);
                showNotification('Ï∫òÎ¶∞Îçî Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®', 'error');
            }
        }

        async function loadDateRecords(startYearMonth, endYearMonth) {
            if (selectedCalendars.size === 0) return;

            try {
                const response = await fetch(`/calendar/search?codes=${[...selectedCalendars].join(',')}&startYearMonth=${startYearMonth}&endYearMonth=${endYearMonth}`);
                const newRecords = await response.json();
                
                // Merge new records with existing ones
                const existingIds = new Set(dateRecords.map(r => r.id));
                const uniqueNewRecords = newRecords.filter(r => !existingIds.has(r.id));
                dateRecords = [...dateRecords, ...uniqueNewRecords];
                
                // Cache the loaded months
                const start = new Date(startYearMonth + '-01');
                const end = new Date(endYearMonth + '-01');
                for (let d = new Date(start); d <= end; d.setMonth(d.getMonth() + 1)) {
                    cachedMonths.add(formatYearMonth(d));
                }
            } catch (error) {
                console.error('Failed to load date records:', error);
            }
        }

        async function createCalendar(title, description, color = '#6366F1') {
            try {
                const response = await fetch('/calendar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) throw new Error('Failed to create calendar');
                
                const calendar = await response.json();
                
                if (title !== calendar.title) {
                    await updateCalendarTitle(calendar.code, title);
                    calendar.title = title;
                }
                
                if (description) {
                    await updateCalendarDescription(calendar.code, description);
                    calendar.description = description;
                }
                
                // ÏÉâÏÉÅ Ï†ÄÏû•
                setCalendarColor(calendar.code, color);
                
                calendars.push(calendar);
                selectedCalendars.add(calendar.code);
                saveCalendarsToStorage();
                renderCategories();
                
                return calendar;
            } catch (error) {
                console.error('Failed to create calendar:', error);
                throw error;
            }
        }

        async function addCalendarByCode(code) {
            try {
                const response = await fetch(`/calendar/${code}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('Ï∫òÎ¶∞ÎçîÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
                    }
                    throw new Error('Ï∫òÎ¶∞Îçî Ï∂îÍ∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§');
                }
                
                const calendar = await response.json();
                
                // Ïù¥ÎØ∏ Ï∂îÍ∞ÄÎêú Ï∫òÎ¶∞ÎçîÏù∏ÏßÄ ÌôïÏù∏
                if (selectedCalendars.has(code)) {
                    showNotification('Ïù¥ÎØ∏ Ï∂îÍ∞ÄÎêú Ï∫òÎ¶∞ÎçîÏûÖÎãàÎã§', 'info');
                    return;
                }
                
                calendars.push(calendar);
                selectedCalendars.add(calendar.code);
                saveCalendarsToStorage();
                renderCategories();
                loadCalendarData();
                
                showNotification('Ï∫òÎ¶∞ÎçîÍ∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§', 'success');
                return calendar;
            } catch (error) {
                console.error('Failed to add calendar by code:', error);
                showNotification(error.message || 'Ï∫òÎ¶∞Îçî Ï∂îÍ∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§', 'error');
                throw error;
            }
        }

        async function updateCalendarTitle(code, title) {
            const response = await fetch(`/calendar/${code}/title`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title })
            });
            return response.json();
        }

        async function updateCalendarDescription(code, description) {
            const response = await fetch(`/calendar/${code}/description`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ description })
            });
            return response.json();
        }

        // Calendar rendering
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            $('#calendarTitle').textContent = `${year}ÎÖÑ ${month + 1}Ïõî`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const grid = $('#calendarGrid');
            const existingCells = grid.querySelectorAll('.calendar-cell');
            existingCells.forEach(cell => cell.remove());
            
            // Ï∫òÎ¶∞Îçî ÎÇ†Ïßú Î∞∞Ïó¥ ÏÉùÏÑ±
            const calendarDates = [];
            for (let i = 0; i < 42; i++) {
                const cellDate = new Date(startDate);
                cellDate.setDate(startDate.getDate() + i);
                calendarDates.push(cellDate);
            }
            
            // Í∏∞Î≥∏ ÏÖÄ ÏÉùÏÑ±
            const cells = calendarDates.map(date => createCalendarCell(date, month));
            cells.forEach(cell => grid.appendChild(cell));
            
            // Ïó∞ÏÜç ÏùºÏ†ï Î†åÎçîÎßÅ
            renderContinuousEvents(calendarDates, cells);
        }

        function createCalendarCell(date, currentMonth) {
            const cell = document.createElement('div');
            cell.className = 'calendar-cell';
            
            const isOtherMonth = date.getMonth() !== currentMonth;
            const isToday = isDateToday(date);
            
            if (isOtherMonth) cell.classList.add('other-month');
            if (isToday) cell.classList.add('today');
            
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            dayElement.textContent = date.getDate();
            cell.appendChild(dayElement);
            
            const eventsElement = document.createElement('div');
            eventsElement.className = 'calendar-events';
            
            // Îã®Ïùº ÏùºÏ†ïÎßå ÌëúÏãú (ÌïòÎ£®ÏßúÎ¶¨ ÏùºÏ†ï)
            const dayRecords = getSingleDayRecordsForDate(date);
            dayRecords.forEach(record => {
                const eventElement = document.createElement('div');
                eventElement.className = 'calendar-event';
                eventElement.textContent = record.title;
                eventElement.draggable = true;
                
                // Ï∫òÎ¶∞Îçî ÏÉâÏÉÅ Ï†ÅÏö©
                const calendarColor = getCalendarColor(record.calendar.code);
                eventElement.style.backgroundColor = calendarColor;
                
                eventElement.addEventListener('click', (e) => {
                    e.stopPropagation();
                    editEvent(record);
                });
                
                // ÎìúÎûòÍ∑∏ Ïù¥Î≤§Ìä∏
                eventElement.addEventListener('dragstart', (e) => {
                    draggedEvent = record;
                    dragStartDate = new Date(date);
                    e.dataTransfer.effectAllowed = 'move';
                    eventElement.style.opacity = '0.5';
                });
                
                eventElement.addEventListener('dragend', (e) => {
                    eventElement.style.opacity = '1';
                    draggedEvent = null;
                    dragStartDate = null;
                });
                
                eventsElement.appendChild(eventElement);
            });
            
            cell.appendChild(eventsElement);
            
            cell.addEventListener('click', () => {
                openEventModal(date);
            });
            
            // ÎìúÎûç Ïù¥Î≤§Ìä∏
            cell.addEventListener('dragover', (e) => {
                if (draggedEvent) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    cell.style.backgroundColor = 'var(--accent-secondary)';
                    cell.style.opacity = '0.8';
                }
            });
            
            cell.addEventListener('dragleave', (e) => {
                if (draggedEvent) {
                    cell.style.backgroundColor = '';
                    cell.style.opacity = '';
                }
            });
            
            cell.addEventListener('drop', async (e) => {
                if (draggedEvent) {
                    e.preventDefault();
                    cell.style.backgroundColor = '';
                    cell.style.opacity = '';
                    
                    const dropDate = new Date(date);
                    const daysDiff = Math.round((dropDate - dragStartDate) / (1000 * 60 * 60 * 24));
                    
                    if (daysDiff !== 0) {
                        await moveEvent(draggedEvent, daysDiff);
                    }
                }
            });
            
            return cell;
        }

        function renderCategories() {
            const list = $('#categoryList');
            list.innerHTML = '';
            
            calendars.forEach(calendar => {
                const item = document.createElement('div');
                item.className = 'category-item';
                if (calendar.visible !== false) {
                    item.classList.add('active');
                }
                
                const eyeIcon = calendar.visible !== false ? 'üëÅÔ∏è' : 'üôà';
                const calendarColor = getCalendarColor(calendar.code);
                
                const description = calendar.description ? `<div class="category-description">${calendar.description}</div>` : '';
                
                item.innerHTML = `
                    <div class="category-info">
                        <div class="category-color" style="background: ${calendarColor};"></div>
                        <div style="flex: 1;">
                            <div class="category-name">${calendar.title}</div>
                            ${description}
                        </div>
                    </div>
                    <div class="category-actions">
                        <button class="category-action" data-action="hide" data-code="${calendar.code}">${eyeIcon}</button>
                        <div class="category-more-menu">
                            <button class="category-action" data-action="more" data-code="${calendar.code}">‚ãØ</button>
                            <div class="category-more-dropdown" id="more-${calendar.code}">
                                <button class="category-more-item" data-action="invite" data-code="${calendar.code}">Ï¥àÎåÄ</button>
                                <button class="category-more-item" data-action="edit-title" data-code="${calendar.code}">Ï†úÎ™© ÏàòÏ†ï</button>
                                <button class="category-more-item" data-action="edit" data-code="${calendar.code}">ÏÑ§Î™Ö ÏàòÏ†ï</button>
                                <button class="category-more-item" data-action="delete" data-code="${calendar.code}">ÏÇ≠Ï†ú</button>
                            </div>
                        </div>
                    </div>
                `;
                
                list.appendChild(item);
            });
            
            // Remove existing event listeners and add new ones
            const newList = list.cloneNode(true);
            list.parentNode.replaceChild(newList, list);
            
            // Add event listeners for category actions
            newList.addEventListener('click', (e) => {
                const action = e.target.dataset.action;
                const code = e.target.dataset.code;
                
                if (action === 'hide') {
                    toggleCalendarVisibility(code);
                } else if (action === 'more') {
                    // Close other dropdowns
                    document.querySelectorAll('.category-more-dropdown').forEach(dropdown => {
                        if (dropdown.id !== `more-${code}`) {
                            dropdown.classList.remove('show');
                        }
                    });
                    // Toggle current dropdown
                    const dropdown = document.getElementById(`more-${code}`);
                    dropdown.classList.toggle('show');
                    e.stopPropagation();
                } else if (action === 'invite') {
                    // TODO: Ï¥àÎåÄ Í∏∞Îä• Íµ¨ÌòÑ
                    showNotification('Ï¥àÎåÄ Í∏∞Îä•ÏùÄ Ï∂îÌõÑ Íµ¨ÌòÑ ÏòàÏ†ïÏûÖÎãàÎã§', 'info');
                    document.getElementById(`more-${code}`).classList.remove('show');
                } else if (action === 'edit-title') {
                    const calendar = calendars.find(cal => cal.code === code);
                    if (calendar) {
                        const newTitle = prompt('Ï∫òÎ¶∞Îçî Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî', calendar.title || '');
                        if (newTitle !== null && newTitle.trim()) {
                            updateCalendarTitle(code, newTitle.trim())
                                .then(() => {
                                    calendar.title = newTitle.trim();
                                    renderCategories();
                                    showNotification('Ï†úÎ™©Ïù¥ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§', 'success');
                                })
                                .catch(() => showNotification('Ï†úÎ™© ÏàòÏ†ï Ïã§Ìå®', 'error'));
                        }
                    }
                    document.getElementById(`more-${code}`).classList.remove('show');
                } else if (action === 'edit') {
                    const calendar = calendars.find(cal => cal.code === code);
                    if (calendar) {
                        const newDesc = prompt('Ï∫òÎ¶∞Îçî ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî', calendar.description || '');
                        if (newDesc !== null) {
                            updateCalendarDescription(code, newDesc.trim())
                                .then(() => {
                                    calendar.description = newDesc.trim();
                                    renderCategories();
                                    showNotification('ÏÑ§Î™ÖÏù¥ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§', 'success');
                                })
                                .catch(() => showNotification('ÏÑ§Î™Ö ÏàòÏ†ï Ïã§Ìå®', 'error'));
                        }
                    }
                    document.getElementById(`more-${code}`).classList.remove('show');
                } else if (action === 'delete') {
                    removeCalendar(code);
                    document.getElementById(`more-${code}`).classList.remove('show');
                }
            });
        }

        // Helper functions
        function formatYearMonth(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        }

        function isDateToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        function getRecordsForDate(date) {
            const dateStr = date.toISOString().split('T')[0];
            return dateRecords.filter(record => {
                const startDateTime = new Date(record.startDateTime);
                const endDateTime = new Date(record.endDateTime);
                
                // ÎÇ†ÏßúÎßå Ï∂îÏ∂ú (ÏãúÍ∞Ñ Ï†úÍ±∞)
                const startDate = new Date(startDateTime.getFullYear(), startDateTime.getMonth(), startDateTime.getDate());
                const endDate = new Date(endDateTime.getFullYear(), endDateTime.getMonth(), endDateTime.getDate());
                const checkDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                
                // ÎÇ†Ïßú Î≤îÏúÑ Ï≤¥ÌÅ¨ (ÏãúÏûëÏùºÍ≥º Ï¢ÖÎ£åÏùº Î™®Îëê Ìè¨Ìï®)
                const inDateRange = checkDate >= startDate && checkDate <= endDate;
                
                // Ï∫òÎ¶∞Îçî visibility Ï≤¥ÌÅ¨
                const calendar = calendars.find(cal => cal.code === record.calendar.code);
                const isVisible = calendar ? calendar.visible !== false : true;
                
                return inDateRange && isVisible;
            });
        }

        function getSingleDayRecordsForDate(date) {
            return getRecordsForDate(date).filter(record => {
                const startDateTime = new Date(record.startDateTime);
                const endDateTime = new Date(record.endDateTime);
                
                // ÎÇ†ÏßúÎßå Ï∂îÏ∂ú (ÏãúÍ∞Ñ Ï†úÍ±∞)  
                const startDate = new Date(startDateTime.getFullYear(), startDateTime.getMonth(), startDateTime.getDate());
                const endDate = new Date(endDateTime.getFullYear(), endDateTime.getMonth(), endDateTime.getDate());
                
                // ÏãúÏûëÏùºÍ≥º Ï¢ÖÎ£åÏùºÏù¥ Í∞ôÏùÄ ÎÇ†Ïù∏ Í≤ΩÏö∞Îßå (Îã®Ïùº ÏùºÏ†ï)
                return startDate.getTime() === endDate.getTime();
            });
        }

        function getMultiDayRecords() {
            return dateRecords.filter(record => {
                const startDateTime = new Date(record.startDateTime);
                const endDateTime = new Date(record.endDateTime);
                
                // ÎÇ†ÏßúÎßå Ï∂îÏ∂ú (ÏãúÍ∞Ñ Ï†úÍ±∞)
                const startDate = new Date(startDateTime.getFullYear(), startDateTime.getMonth(), startDateTime.getDate());
                const endDate = new Date(endDateTime.getFullYear(), endDateTime.getMonth(), endDateTime.getDate());
                
                // ÏãúÏûëÏùºÍ≥º Ï¢ÖÎ£åÏùºÏù¥ Îã§Î•∏ Í≤ΩÏö∞Îßå (Ïó∞ÏÜç ÏùºÏ†ï)
                const isMultiDay = startDate.getTime() !== endDate.getTime();
                
                // Ï∫òÎ¶∞Îçî visibility Ï≤¥ÌÅ¨
                const calendar = calendars.find(cal => cal.code === record.calendar.code);
                const isVisible = calendar ? calendar.visible !== false : true;
                
                return isMultiDay && isVisible;
            });
        }

        function renderContinuousEvents(calendarDates, cells) {
            const multiDayRecords = getMultiDayRecords();
            const usedRows = new Map(); // Í∞Å ÎÇ†ÏßúÎ≥ÑÎ°ú ÏÇ¨Ïö©Îêú Ìñâ Ï∂îÏ†Å
            
            multiDayRecords.forEach(record => {
                const startDateTime = new Date(record.startDateTime);
                const endDateTime = new Date(record.endDateTime);
                
                const startDate = new Date(startDateTime.getFullYear(), startDateTime.getMonth(), startDateTime.getDate());
                const endDate = new Date(endDateTime.getFullYear(), endDateTime.getMonth(), endDateTime.getDate());
                
                // Ï∫òÎ¶∞ÎçîÏóê ÌëúÏãúÎêòÎäî ÎÇ†Ïßú Î≤îÏúÑÏóêÏÑú ÏùºÏ†ïÏù¥ Í≤πÏπòÎäî Î∂ÄÎ∂Ñ Ï∞æÍ∏∞
                const firstCalendarDate = calendarDates[0];
                const lastCalendarDate = calendarDates[calendarDates.length - 1];
                
                let currentDate = new Date(Math.max(startDate.getTime(), firstCalendarDate.getTime()));
                const eventEndDate = new Date(Math.min(endDate.getTime(), lastCalendarDate.getTime()));
                
                if (currentDate > eventEndDate) return;
                
                // Ï£º Îã®ÏúÑÎ°ú ÏùºÏ†ïÏùÑ ÎÇòÎàÑÏñ¥ Î†åÎçîÎßÅ
                while (currentDate <= eventEndDate) {
                    const weekStart = getWeekStart(currentDate, calendarDates);
                    const weekEnd = getWeekEnd(currentDate, calendarDates);
                    
                    const segmentStart = new Date(Math.max(currentDate.getTime(), weekStart.getTime()));
                    const segmentEnd = new Date(Math.min(eventEndDate.getTime(), weekEnd.getTime()));
                    
                    if (segmentStart <= segmentEnd) {
                        renderEventSegment(record, segmentStart, segmentEnd, calendarDates, cells, usedRows);
                    }
                    
                    // Îã§Ïùå Ï£ºÎ°ú Ïù¥Îèô
                    currentDate = new Date(weekEnd);
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            });
        }

        function getWeekStart(date, calendarDates) {
            const dateIndex = calendarDates.findIndex(d => d.toDateString() === date.toDateString());
            if (dateIndex === -1) return date;
            
            const weekStartIndex = Math.floor(dateIndex / 7) * 7;
            return calendarDates[weekStartIndex];
        }

        function getWeekEnd(date, calendarDates) {
            const dateIndex = calendarDates.findIndex(d => d.toDateString() === date.toDateString());
            if (dateIndex === -1) return date;
            
            const weekEndIndex = Math.min(Math.floor(dateIndex / 7) * 7 + 6, calendarDates.length - 1);
            return calendarDates[weekEndIndex];
        }

        function renderEventSegment(record, segmentStart, segmentEnd, calendarDates, cells, usedRows) {
            const startIndex = calendarDates.findIndex(d => d.toDateString() === segmentStart.toDateString());
            const endIndex = calendarDates.findIndex(d => d.toDateString() === segmentEnd.toDateString());
            
            if (startIndex === -1 || endIndex === -1) return;
            
            // ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ìñâ Ï∞æÍ∏∞
            let row = 0;
            while (true) {
                let canUseRow = true;
                for (let i = startIndex; i <= endIndex; i++) {
                    const dateKey = calendarDates[i].toDateString();
                    if (!usedRows.has(dateKey)) usedRows.set(dateKey, new Set());
                    if (usedRows.get(dateKey).has(row)) {
                        canUseRow = false;
                        break;
                    }
                }
                if (canUseRow) break;
                row++;
            }
            
            // Ìñâ ÏÇ¨Ïö© ÌëúÏãú
            for (let i = startIndex; i <= endIndex; i++) {
                const dateKey = calendarDates[i].toDateString();
                usedRows.get(dateKey).add(row);
            }
            
            // Ïó∞ÏÜç ÏùºÏ†ï ÏöîÏÜå ÏÉùÏÑ±
            for (let i = startIndex; i <= endIndex; i++) {
                const cell = cells[i];
                const eventElement = document.createElement('div');
                eventElement.className = 'calendar-event calendar-event-continuous';
                
                // ÏãúÏûë, Ï§ëÍ∞Ñ, ÎÅù Ïä§ÌÉÄÏùº Ï†ÅÏö©
                if (i === startIndex && i === endIndex) {
                    eventElement.classList.add('single');
                    eventElement.textContent = record.title;
                } else if (i === startIndex) {
                    eventElement.classList.add('start');
                    eventElement.textContent = record.title;
                } else if (i === endIndex) {
                    eventElement.classList.add('end');
                } else {
                    // Ï§ëÍ∞Ñ
                }
                
                // ÏúÑÏπò ÏÑ§Ï†ï
                eventElement.style.top = `calc(var(--spacing-sm) + 20px + ${row * 18}px)`;
                eventElement.style.left = '2px';
                eventElement.style.right = '2px';
                
                // Ï∫òÎ¶∞Îçî ÏÉâÏÉÅ Ï†ÅÏö©
                const calendarColor = getCalendarColor(record.calendar.code);
                eventElement.style.backgroundColor = calendarColor;
                
                // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
                eventElement.addEventListener('click', (e) => {
                    e.stopPropagation();
                    editEvent(record);
                });
                
                // ÎìúÎûòÍ∑∏ Ïù¥Î≤§Ìä∏
                eventElement.draggable = true;
                eventElement.addEventListener('dragstart', (e) => {
                    draggedEvent = record;
                    dragStartDate = calendarDates[i];
                    e.dataTransfer.effectAllowed = 'move';
                    eventElement.style.opacity = '0.5';
                });
                
                eventElement.addEventListener('dragend', (e) => {
                    eventElement.style.opacity = '1';
                    draggedEvent = null;
                    dragStartDate = null;
                });
                
                cell.appendChild(eventElement);
            }
        }

        function toggleCalendarVisibility(code) {
            // Ï∫òÎ¶∞Îçî Î¶¨Ïä§Ìä∏ÏóêÏÑú Ìï¥Îãπ Ï∫òÎ¶∞Îçî Ï∞æÍ∏∞
            const calendar = calendars.find(cal => cal.code === code);
            if (!calendar) return;
            
            // ÌòÑÏû¨ ÌëúÏãú ÏÉÅÌÉú ÌÜ†Í∏Ä
            calendar.visible = !calendar.visible;
            
            // ÌëúÏãú ÏÉÅÌÉúÎ•º Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû•
            const visibilityData = JSON.parse(localStorage.getItem('calendarVisibility') || '{}');
            visibilityData[code] = calendar.visible;
            localStorage.setItem('calendarVisibility', JSON.stringify(visibilityData));
            
            renderCategories();
            renderCalendar();
        }

        function removeCalendar(code) {
            if (!confirm('Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏπ¥ÌÖåÍ≥†Î¶¨ ÎÇ¥ Îç∞Ïù¥ÌÑ∞Îäî ÏÇ≠Ï†úÎêòÏßÄ ÏïäÏäµÎãàÎã§.')) {
                return;
            }
            
            calendars = calendars.filter(cal => cal.code !== code);
            selectedCalendars.delete(code);
            dateRecords = dateRecords.filter(record => record.calendar.code !== code);
            saveCalendarsToStorage();
            renderCategories();
            renderCalendar();
        }

        // Modal functions
        function openEventModal(date = null, event = null) {
            editingEvent = event;
            const modal = $('#eventModal');
            const title = $('#eventModalTitle');
            const deleteBtn = $('#eventDeleteBtn');
            const allDayCheckbox = $('#eventAllDayCheckbox');
            
            if (event) {
                title.textContent = 'ÏùºÏ†ï ÏàòÏ†ï';
                $('#eventTitleInput').value = event.title;
                
                // ÌïòÎ£®Ï¢ÖÏùº Ïó¨Î∂Ä ÌôïÏù∏ (00:00:00 ~ 23:59:59)
                const startTime = new Date(event.startDateTime);
                const endTime = new Date(event.endDateTime);
                const isAllDay = startTime.getHours() === 0 && startTime.getMinutes() === 0 && startTime.getSeconds() === 0 &&
                                 endTime.getHours() === 23 && endTime.getMinutes() === 59 && endTime.getSeconds() === 59;
                
                allDayCheckbox.checked = isAllDay;
                
                if (isAllDay) {
                    $('#eventStartDateOnly').value = startTime.toISOString().slice(0, 10);
                    $('#eventEndDateOnly').value = endTime.toISOString().slice(0, 10);
                } else {
                    $('#eventStartDateInput').value = new Date(event.startDateTime).toISOString().slice(0, 16);
                    $('#eventEndDateInput').value = new Date(event.endDateTime).toISOString().slice(0, 16);
                }
                
                toggleAllDayInputs(isAllDay);
                $('#eventDescInput').value = event.description || '';
                $('#eventCalendarSelect').value = event.calendar.code;
                deleteBtn.style.display = 'inline-flex';
            } else {
                title.textContent = 'ÏùºÏ†ï Ï∂îÍ∞Ä';
                $('#eventTitleInput').value = '';
                $('#eventDescInput').value = '';
                allDayCheckbox.checked = false;
                deleteBtn.style.display = 'none';
                
                if (date) {
                    const dateStr = date.toISOString().slice(0, 10);
                    $('#eventStartDateInput').value = `${dateStr}T09:00`;
                    $('#eventEndDateInput').value = `${dateStr}T10:00`;
                    $('#eventStartDateOnly').value = dateStr;
                    $('#eventEndDateOnly').value = dateStr;
                }
                
                toggleAllDayInputs(false);
            }
            
            // Populate calendar select
            const select = $('#eventCalendarSelect');
            select.innerHTML = '';
            calendars.forEach(calendar => {
                const option = document.createElement('option');
                option.value = calendar.code;
                option.textContent = calendar.title;
                select.appendChild(option);
            });
            
            modal.classList.add('show');
        }

        function toggleAllDayInputs(isAllDay) {
            const startDateTimeInput = $('#eventStartDateInput');
            const endDateTimeInput = $('#eventEndDateInput');
            const startDateOnlyInput = $('#eventStartDateOnly');
            const endDateOnlyInput = $('#eventEndDateOnly');
            
            if (isAllDay) {
                // ÌïòÎ£®Ï¢ÖÏùºÎ°ú Î∞îÎÄî Îïå, Í∏∞Ï°¥ ÏãúÏûë/Ï¢ÖÎ£å ÎÇ†ÏßúÏùò ÎÖÑÏõîÏùºÏùÑ date-only ÌïÑÎìúÏóê ÏÑ§Ï†ï
                if (startDateTimeInput.value) {
                    const startDate = new Date(startDateTimeInput.value);
                    startDateOnlyInput.value = startDate.toISOString().slice(0, 10);
                }
                if (endDateTimeInput.value) {
                    const endDate = new Date(endDateTimeInput.value);
                    endDateOnlyInput.value = endDate.toISOString().slice(0, 10);
                }
                
                startDateTimeInput.classList.add('hidden');
                endDateTimeInput.classList.add('hidden');
                startDateOnlyInput.classList.remove('hidden');
                endDateOnlyInput.classList.remove('hidden');
            } else {
                startDateTimeInput.classList.remove('hidden');
                endDateTimeInput.classList.remove('hidden');
                startDateOnlyInput.classList.add('hidden');
                endDateOnlyInput.classList.add('hidden');
            }
        }

        function editEvent(event) {
            openEventModal(null, event);
        }

        async function saveEvent() {
            const title = $('#eventTitleInput').value.trim();
            const description = $('#eventDescInput').value.trim();
            const calendarCode = $('#eventCalendarSelect').value;
            const isAllDay = $('#eventAllDayCheckbox').checked;
            
            let startDateTime, endDateTime;
            
            if (isAllDay) {
                const startDate = $('#eventStartDateOnly').value;
                const endDate = $('#eventEndDateOnly').value;
                
                if (!title || !startDate || !endDate || !calendarCode) {
                    showNotification('ÌïÑÏàò Ï†ïÎ≥¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                    return;
                }
                
                startDateTime = `${startDate} 00:00:00`;
                endDateTime = `${endDate} 23:59:59`;
            } else {
                const startDateTimeInput = $('#eventStartDateInput').value;
                const endDateTimeInput = $('#eventEndDateInput').value;
                
                if (!title || !startDateTimeInput || !endDateTimeInput || !calendarCode) {
                    showNotification('ÌïÑÏàò Ï†ïÎ≥¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                    return;
                }
                
                // ÎÇ†Ïßú Ìè¨Îß∑ÏùÑ yyyy-MM-dd HH:mm:ssÎ°ú Î≥ÄÌôò
                const formatDateTime = (dateTimeStr) => {
                    const date = new Date(dateTimeStr);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const seconds = '00';
                    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
                };
                
                startDateTime = formatDateTime(startDateTimeInput);
                endDateTime = formatDateTime(endDateTimeInput);
            }
            
            const requestData = {
                title,
                startDateTime,
                endDateTime,
                description: description || null
            };
            
            try {
                let response;
                if (editingEvent) {
                    response = await fetch(`/calendar/${calendarCode}/record/${editingEvent.id}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData)
                    });
                } else {
                    response = await fetch(`/calendar/${calendarCode}/record`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData)
                    });
                }
                
                if (!response.ok) throw new Error('Failed to save event');
                
                const savedEvent = await response.json();
                
                if (editingEvent) {
                    const index = dateRecords.findIndex(r => r.id === editingEvent.id);
                    if (index !== -1) {
                        dateRecords[index] = savedEvent;
                    }
                } else {
                    dateRecords.push(savedEvent);
                }
                
                closeModal('eventModal');
                renderCalendar();
                showNotification('ÏùºÏ†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§', 'success');
            } catch (error) {
                console.error('Failed to save event:', error);
                showNotification('ÏùºÏ†ï Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§', 'error');
            }
        }

        async function deleteEvent() {
            if (!editingEvent) return;
            
            if (!confirm('Ïù¥ ÏùºÏ†ïÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            
            try {
                const response = await fetch(`/calendar/${editingEvent.calendar.code}/record/${editingEvent.id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('Failed to delete event');
                
                dateRecords = dateRecords.filter(r => r.id !== editingEvent.id);
                closeModal('eventModal');
                renderCalendar();
                showNotification('ÏùºÏ†ïÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§', 'success');
            } catch (error) {
                console.error('Failed to delete event:', error);
                showNotification('ÏùºÏ†ï ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§', 'error');
            }
        }

        async function moveEvent(event, daysDiff) {
            try {
                // ÏãúÏûëÏùºÍ≥º Ï¢ÖÎ£åÏùºÏóê ÏùºÏàò Ï∞®Ïù¥ÎßåÌÅº ÎçîÌïòÍ∏∞
                const startDateTime = new Date(event.startDateTime);
                const endDateTime = new Date(event.endDateTime);
                
                startDateTime.setDate(startDateTime.getDate() + daysDiff);
                endDateTime.setDate(endDateTime.getDate() + daysDiff);
                
                // ÎÇ†Ïßú Ìè¨Îß∑ÏùÑ yyyy-MM-dd HH:mm:ssÎ°ú Î≥ÄÌôò
                const formatDateTime = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const seconds = String(date.getSeconds()).padStart(2, '0');
                    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
                };
                
                const requestData = {
                    title: event.title,
                    startDateTime: formatDateTime(startDateTime),
                    endDateTime: formatDateTime(endDateTime),
                    description: event.description || null
                };
                
                const response = await fetch(`/calendar/${event.calendar.code}/record/${event.id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) throw new Error('Failed to move event');
                
                const updatedEvent = await response.json();
                
                // Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                const index = dateRecords.findIndex(r => r.id === event.id);
                if (index !== -1) {
                    dateRecords[index] = updatedEvent;
                }
                
                renderCalendar();
                showNotification('ÏùºÏ†ïÏù¥ Ïù¥ÎèôÎêòÏóàÏäµÎãàÎã§', 'success');
            } catch (error) {
                console.error('Failed to move event:', error);
                showNotification('ÏùºÏ†ï Ïù¥ÎèôÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§', 'error');
            }
        }

        function closeModal(modalId) {
            $(`#${modalId}`).classList.remove('show');
        }

        // Navigation functions
        async function navigateMonth(direction) {
            const newDate = new Date(currentDate);
            newDate.setMonth(newDate.getMonth() + direction);
            
            const targetMonth = formatYearMonth(newDate);
            
            // Check if we need to load data for the new month
            if (!cachedMonths.has(targetMonth) && selectedCalendars.size > 0) {
                const startMonth = formatYearMonth(new Date(newDate.getFullYear(), newDate.getMonth() - 1, 1));
                const endMonth = formatYearMonth(new Date(newDate.getFullYear(), newDate.getMonth() + 2, 0));
                await loadDateRecords(startMonth, endMonth);
            }
            
            currentDate = newDate;
            renderCalendar();
        }

        function goToToday() {
            currentDate = new Date();
            renderCalendar();
        }

        function openDatePicker() {
            const modal = $('#datePickerModal');
            const yearSelect = $('#yearSelect');
            const monthBtns = document.querySelectorAll('.month-btn');
            
            // Populate years (current year ¬± 100 years)
            yearSelect.innerHTML = '';
            const currentYear = new Date().getFullYear();
            for (let year = currentYear - 100; year <= currentYear + 100; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + 'ÎÖÑ';
                if (year === currentDate.getFullYear()) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
            
            // Set selected month
            monthBtns.forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.month) === currentDate.getMonth()) {
                    btn.classList.add('active');
                }
            });
            
            selectedYear = currentDate.getFullYear();
            selectedMonth = currentDate.getMonth();
            
            modal.classList.add('show');
        }

        // Notification system
        function showNotification(message, type = 'info') {
            // Simple alert for now - could be enhanced with a proper notification system
            alert(message);
        }

        // Event listeners setup
        function setupEventListeners() {
            // Theme toggle
            $('#themeToggle').addEventListener('click', toggleTheme);
            
            // Sidebar toggle
            $('#toggleSidebar').addEventListener('click', () => {
                const sidebar = $('#sidebar');
                const mainContent = $('.main-content');
                const isMobile = window.innerWidth <= 768;
                
                if (isMobile) {
                    sidebar.classList.toggle('show');
                } else {
                    const isCollapsed = sidebar.classList.toggle('collapsed');
                    if (isCollapsed) {
                        mainContent.classList.add('sidebar-collapsed');
                    } else {
                        mainContent.classList.remove('sidebar-collapsed');
                    }
                }
            });
            
            // Navigation dropdown
            $('#navToggle').addEventListener('click', (e) => {
                e.stopPropagation();
                $('#navMenu').classList.toggle('show');
            });
            
            document.addEventListener('click', () => {
                $('#navMenu').classList.remove('show');
                
                // Ïπ¥ÌÖåÍ≥†Î¶¨ ÎçîÎ≥¥Í∏∞ ÎìúÎ°≠Îã§Ïö¥ Îã´Í∏∞
                document.querySelectorAll('.category-more-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
            });
            
            // Calendar navigation
            $('#prevMonth').addEventListener('click', () => navigateMonth(-1));
            $('#nextMonth').addEventListener('click', () => navigateMonth(1));
            $('#todayBtn').addEventListener('click', goToToday);
            $('#calendarTitle').addEventListener('click', openDatePicker);
            
            // Date picker modal
            $('#datePickerClose').addEventListener('click', () => closeModal('datePickerModal'));
            $('#datePickerCancel').addEventListener('click', () => closeModal('datePickerModal'));
            
            $('#yearSelect').addEventListener('change', (e) => {
                selectedYear = parseInt(e.target.value);
            });
            
            document.querySelectorAll('.month-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.month-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedMonth = parseInt(btn.dataset.month);
                });
            });
            
            $('#datePickerConfirm').addEventListener('click', () => {
                currentDate = new Date(selectedYear, selectedMonth, 1);
                renderCalendar();
                closeModal('datePickerModal');
            });
            
            // Calendar code input
            const calendarCodeInput = $('#calendarCodeInput');
            calendarCodeInput.addEventListener('input', () => {
                calendarCodeInput.value = calendarCodeInput.value
                    .toUpperCase()
                    .replace(/[^A-Z0-9]/g, '')
                    .substring(0, 8);
            });
            
            calendarCodeInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    $('#addCalendarCodeBtn').click();
                }
            });
            
            $('#addCalendarCodeBtn').addEventListener('click', async () => {
                const code = calendarCodeInput.value.trim().toUpperCase();
                if (!code) {
                    showNotification('Ï∫òÎ¶∞Îçî ÏΩîÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                    return;
                }
                
                try {
                    await addCalendarByCode(code);
                    calendarCodeInput.value = '';
                } catch (error) {
                    // Error already handled in addCalendarByCode
                }
            });

            // Category modal
            $('#addCategoryBtn').addEventListener('click', () => {
                $('#categoryModal').classList.add('show');
                $('#categoryTitleInput').focus();
                
                // Í∏∞Î≥∏ ÏÉâÏÉÅ ÌîÑÎ¶¨ÏÖã ÌôúÏÑ±Ìôî
                const colorPresets = document.querySelectorAll('.color-preset');
                colorPresets.forEach(p => p.classList.remove('active'));
                if (colorPresets.length > 0) {
                    colorPresets[0].classList.add('active');
                }
            });
            
            $('#categoryClose').addEventListener('click', () => closeModal('categoryModal'));
            $('#categoryCancelBtn').addEventListener('click', () => closeModal('categoryModal'));
            
            // Color picker event listeners
            const categoryColorInput = $('#categoryColorInput');
            const colorPresets = document.querySelectorAll('.color-preset');
            
            colorPresets.forEach(preset => {
                preset.addEventListener('click', () => {
                    const color = preset.dataset.color;
                    categoryColorInput.value = color;
                    
                    // Remove active class from all presets
                    colorPresets.forEach(p => p.classList.remove('active'));
                    // Add active class to clicked preset
                    preset.classList.add('active');
                });
            });
            
            categoryColorInput.addEventListener('change', () => {
                // Remove active class from all presets when custom color is selected
                colorPresets.forEach(p => p.classList.remove('active'));
            });

            $('#categorySubmitBtn').addEventListener('click', async () => {
                const title = $('#categoryTitleInput').value.trim();
                const description = $('#categoryDescInput').value.trim();
                const color = $('#categoryColorInput').value;
                
                if (!title) {
                    showNotification('Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                    return;
                }
                
                try {
                    await createCalendar(title, description, color);
                    closeModal('categoryModal');
                    $('#categoryTitleInput').value = '';
                    $('#categoryDescInput').value = '';
                    $('#categoryColorInput').value = '#6366F1';
                    colorPresets.forEach(p => p.classList.remove('active'));
                    colorPresets[0].classList.add('active'); // Ï≤´ Î≤àÏß∏ ÏÉâÏÉÅÏùÑ Í∏∞Î≥∏ÏúºÎ°ú ÌôúÏÑ±Ìôî
                    // Ï∂îÍ∞Ä ÏÑ±Í≥µ Ïãú ÏïåÎ¶º Ï†úÍ±∞
                } catch (error) {
                    showNotification('Ïπ¥ÌÖåÍ≥†Î¶¨ Ï∂îÍ∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§', 'error');
                }
            });
            
            // Event modal
            $('#eventClose').addEventListener('click', () => closeModal('eventModal'));
            $('#eventCancelBtn').addEventListener('click', () => closeModal('eventModal'));
            $('#eventSubmitBtn').addEventListener('click', saveEvent);
            $('#eventDeleteBtn').addEventListener('click', deleteEvent);
            
            // All-day checkbox event listener
            $('#eventAllDayCheckbox').addEventListener('change', (e) => {
                toggleAllDayInputs(e.target.checked);
            });
            
            
            // Close modals on outside click
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.classList.remove('show');
                }
            });
            
            // Handle window resize for sidebar
            window.addEventListener('resize', () => {
                const sidebar = $('#sidebar');
                const mainContent = $('.main-content');
                const isMobile = window.innerWidth <= 768;
                
                if (isMobile) {
                    sidebar.classList.remove('collapsed');
                    mainContent.classList.remove('sidebar-collapsed');
                    if (!sidebar.classList.contains('show')) {
                        sidebar.style.display = '';
                    }
                } else {
                    sidebar.classList.remove('show');
                }
            });
        }
    </script>
</body>
</html>